<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" >
<head>
    <title></title>
    <link href="../Styles/Query.css" rel="stylesheet" type="text/css" />
    <link href="../Styles/ScrollBar.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="../SzdwControls/domCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwMark.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwInfoPanel.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwPopupWindow.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwAjaxDataOperate.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCommon.js" type="text/javascript"></script>
</head>
<body> 
    <form action="">
        <div id="UserInfoPanel" class="groupPanel">
            <div id="row0" style="margin-bottom:10px;height:24px;">
                <div id="cell00" class="cellDiv">
                    <label for="txtName" class="pwLabel">用户名称:</label>
                    <input id="txtName" type="text" class="pwTextBox" disabled="disabled"  style="background-color:transparent;border:0px;"/> 
                </div> 
            </div>
            <div id="row1" style="height:24px;">  
                <div id="cell10" class="cellDiv">
                    <label for="txtNameCN" class="pwLabel">中文姓名:</label>
                    <input id="txtNameCN" type="text" class="pwTextBox" disabled="disabled" style="background-color:transparent;border:0px;" /> 
                </div>                
            </div>
        </div>
        <div id="PasswordPanel" class="groupPanel">
            <div id="row3" style="margin-bottom:10px;height:24px;">  
                <div id="Div5" class="cellDiv">
                    <label class="pwLabel">原密码:</label>
                    <input id="txtOldPass" type="password" class="pwTextBox"  /> 
                </div>                
            </div>
            <div id="row4" style="margin-bottom:10px;height:24px;">  
                <div id="Div6" class="cellDiv">
                    <label class="pwLabel">新密码:</label>
                    <input id="txtNewPass" type="password" class="pwTextBox"  /> 
                </div>                
            </div>
            <div id="row5" style="height:24px;">  
                <div id="Div8" class="cellDiv">
                    <label class="pwLabel">新密码确认:</label>
                    <input id="txtNewPassConfirm" type="password" class="pwTextBox" /> 
                </div>                
            </div>
        </div>
        <div id="buttonPanel">
            <input id="btnCancel" type="button" value="取消" class="pwButton2" style="float:right;"/>
            <input id="btnSave" type="button" value="提交保存" class="pwKeyButton2" style="float:right"/>
        </div>          
    </form>
    <script type="text/javascript">
        //#region 全局变量
        var permission = null; xuserId = null;themeColor = "Orange";// parent.themeColor;
        var bodyWidth = $(document).width(); bodyHeight = $(document).height();
        var lblWidth = 75;txtWidth = 170;isPassValid = false;isNewPassSame = false;
        var isOldPassValid = false; isFirst = true;
        var ml = 10; mt = 10; btnHeight = 32;
        var panelWidth = bodyWidth - ml * 2;
        //#endregion 全局变量

        //#region 网页加载 

        //#region 初始加载
        $(document).ready(function () {
            //设置用户面板
            SetUserInfoPanel();

            //设置密码修改面板
            SetPasswordPanel();

            //设置按钮面板
            SetButtonPanel();

            //按钮事件绑定
            ButtonHandler();

            //窗口调整大小
            $(window).resize(function () {
                RePositionControls();
            });
        });

        function RePositionControls() {
            var pw = parent.document.body.popupWindow;
            if (pw) {
                var p = $("#buttonPanel");
                var ph = pw.pagePanelHeight;
                var h = $(p).outerHeight();
                var x = 0;
                var y = ph - h - 2;
                $(p).css({ "left": x, "top": y });
            }
        }
        //#endregion 初始加载
       
        //#endregion 网页加载  

        //#region 设置用户信息
        function SetUserInfoPanel() {
            var q = $("#UserInfoPanel");
            var x = 0;
            var y = mt;
            var w = bodyWidth - x * 2;
            $(q).css({ "left": x, "top": y }).outerWidth(w,true);
            $(".pwLabel").outerWidth(lblWidth);
            //$(".pwTextBox").outerWidth(txtWidth);

            //获取用户信息
            GetUserInfo();
        }

        //获取用户信息
        function GetUserInfo() {
            var userJson = $.parseJSON(SzdwCommon.getUrlParam("paramJson"));
            if (userJson) {
                xuserId = userJson.xuserId;
                $("#txtName").val(userJson.xuserName);
                $("#txtNameCN").val(userJson.xuserNameCN);
            }
        }
        //#endregion 设置用户信息        

        //#region 设置密码修改面板
        function SetPasswordPanel() {
            var up = $("#UserInfoPanel");
            var upx = $(up).position().left;
            var upy = $(up).position().top;
            var uph = $(up).outerHeight();
            var upw = $(up).outerWidth();

            var p = $("#PasswordPanel");
            var x = 0;
            var y = upy + uph;
            var w = bodyWidth - x * 2;
            $(p).css({ "left": x, "top": y}).outerWidth(w, true);
            $(".pwLabel").outerWidth(lblWidth);
            $(".pwTextBox").outerWidth(txtWidth).css("margin-left","20px");


            //验证当前密码是否正确

            ValidatePass($("#txtOldPass"), 2);

            //验证新密码是否填写
            ValidatePass($("#txtNewPass"), 1);

            //验证新密码确认是否填写并且一致
            ValidatePass($("#txtNewPassConfirm"), 3);
            $("#txtOldPass").focus();
        }
        //#endregion 设置密码修改面板    

        //#region 设置按钮面板
        function SetButtonPanel() {
            var p = $("#buttonPanel");
            var w = bodyWidth;
            var h = 35;
            var x = 0;
            var y = bodyHeight - h-2;
            $(p).css({ "position": "relative", "left": x, "top": y, "border-top": "0px solid #E2E2E2", "padding": "5px 10px 5px 5px" });
            $(p).outerWidth(w).outerHeight(h);
        }
        //#endregion 设置按钮面板        
        
        //#region 按钮事件
        function ButtonHandler() {            
            //获取弹窗
            var pw = parent.document.body.popupWindow;
            var szdwGv = parent.szdwGv;
            $("#btnSave").click(function () {
                if (isPassValid && isNewPassSame) {
                    var password = $("#txtNewPass").val();
                    var objDataBind = null;
                    var requestUrl = "../Xuser/XuserProcess.ashx";
                    var paramJson = { xuserId: xuserId, password: password, modifierId: xuserId, MethodName: "XuserModifyPassword" };
                    SzdwAjaxDataOperate.ajaxUpdate(objDataBind, requestUrl, paramJson, OperateCallBack);
                } else {
                    if (isFirst) {
                        //$("#txtOldPass").trigger("blur");
                        $("#txtNewPass").trigger("blur");
                        isFirst = false;
                    }
                }
            });

            $("#btnCancel").click(function () {
                pw.Hide();
            });

            function OperateCallBack() {
                alert("密码修改成功。");
                pw.Hide();
            }
        }
        //#endregion 按钮事件  

        //#region 密码验证
       
        //obj:输入密码的文本框对象；type:1，密码填写否验证；2：1的基础上加密码正确性验证；3：1的基础上加密码一致性验证
        function ValidatePass(obj,type) {
            var p = obj;
            var imageUrl = "../SzdwControls/Image/warnning21w2.png";
            $(p).attachInfoPanel({ imageUrl: imageUrl,width:130, showMode: 2, positionMode: 1, backColor: themeColor, backOpacity: 0.4 });  //附加信息提示框
            if (type == 2) {
            	$(p).attachMark(); //附加标记提示框
            }
            $(p).focus(function () {
                $(this).data("infoPanel").Hide();
            }).blur(function () {
                if ($.trim($(this).val()).length <6) {
                    var infoPanel = $(this).data("infoPanel");
                    infoPanel.contentText = "必须6位以上";
                    infoPanel.Refresh();
                    return false;
                }
                else {
                    switch (type) {
                        case 2:
                            XuserPasswordIsValid($(this));
                            break;
                        case 3:
                            XuserNewPasswordIsSame(obj);
                            break;
                    }
                }
            });
        }

        //检测用户密码是否正确
        function XuserPasswordIsValid(txtPass) {
            var p = txtPass;
            var m = $(p).data("mark");
            m.imageJson = { loadingImage: "../SzdwControls/Image/refresh.gif", successImage: "../SzdwControls/Image/correct21g2.png" };    
            m.status = 0;
            m.SetMark();
            m.Show();
            var url = "../Xuser/XuserProcess.ashx";
            var userName = $.trim($("#txtName").val());
            var password = $.trim($(p).val());
            var paramJson = { userName: userName, password: password, MethodName: "XuserPasswordIsValid" };
            $.ajax({ url: url, type: "post", data: paramJson, dataType: "json",
                success: function (jsData) {
                    if (jsData.passValid) {
                        m.status = 1;
                        m.SetMark();
                    } else {
                        m.Hide();
                        var infoPanel = $(p).data("infoPanel");
                        infoPanel.contentText = "密码错误";
                        infoPanel.Refresh();
                    }
                    isPassValid = jsData.passValid;
                }
            });
        }
        
        //检测用户密码是否正确
        function XuserNewPasswordIsSame() {
            var p1 = $("#txtNewPass");
            var p2 = $("#txtNewPassConfirm");
            if (p1.val() != p2.val()) {
                var infoPanel = $(p2).data("infoPanel");
                infoPanel.contentText = "密码不一致";
                infoPanel.Refresh();
            }
            isNewPassSame = p1.val() == p2.val();
        }
        //#endregion 密码验证
    </script>
</body>
</html>