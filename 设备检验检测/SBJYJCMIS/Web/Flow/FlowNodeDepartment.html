<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="../Styles/Page.css" rel="stylesheet" type="text/css" />
    <link href="../Styles/Query.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwDropDownList.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwGridView.js" type="text/javascript"></script>
    <link href="../SzdwControls/SzdwGridView.css" rel="stylesheet" type="text/css" />
    <script src="../SzdwControls/SzdwPagination.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwButton.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwAjaxDataOperate.js" type="text/javascript"></script>
    <script src="../Scripts/myparm.js" type="text/javascript"></script>
    <script src="../SzdwControls/domCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwInfoPanel.js" type="text/javascript"></script>
    <style type="text/css">
        input::-ms-clear {
            display: none;
        }
    </style>
</head>
<body style="background-color: #EEEEEE">
    <form action="">
        <div id="leftPanel">
            <div id="flowNodeFilterPanel" style="height: 25px; padding-bottom: 10px;">
                <div id="rfpCell00" class="cellDiv" style="color: #1B60C3; font-size: 12pt; font-family: 微软雅黑;">
                    <input id="ddlFlow" type="text" class="dropDownList" style="width:100px; background-color: transparent; text-align:center;" />
                </div>
                <div>
                    <div id="rfpCell01" class="cellDiv" style="border-left: 1px solid #DDDDDD; margin-left: 10px;">
                        <input id="txtFlowNodeName" type="text" class="textBox2" style="background-color: transparent;
                    border-right: 0px;" />
                    </div>
                </div>
            </div>
            <div id="flowNodeDataPanel" class="dataPanel">
            </div>
        </div>
        <div id="rightPanel">
            <div id="roleFilterPanel" style="height: 25px; padding-bottom: 10px;">
                <div id="rpfpCell00" class="cellDiv" style="color: #1B60C3; font-size: 12pt; font-family: 微软雅黑;">
                    节点部门
                </div>
                <div id="rpfpCell01" class="cellDiv" style="border-left: 1px solid #DDDDDD; margin-left: 10px;">
                    <div id="ddlAssignType" class="dropDownList" style="width: 80px;">
                    </div>
                </div>
                <div id="rpfpCell02" class="cellDiv" style="padding-left: 5px">
                    <input id="txtDepartmentName" type="text" class="textBox2" style="background-color: transparent;
                    border-right: 0px; width: 120px;" />
                </div>
            </div>
            <div id="xgDataPanel" class="dataPanel">
            </div>
        </div>
    </form>
    <script type="text/javascript">
        //#region 全局变量
        var xuserId, xmenuId, permission = null; //用户及权限：json格式
        var ml = 20; mt = 20; //ml:margin-left;mt:margin-top;
        var btnWidth = 90; btnHeight = 26; btnImageWidth = 25; //btnWidth:按钮宽;btnHeight:按钮高;btnImageWidth:按钮图片宽
        //#endregion 全局变量

        //#region 网页加载

        //#region 初始加载
        $(document).ready(function () {
            //获取用户Id和MenuId
            xuserId = GetXuserId();
            xmenuId = GetXmenuId();
            permission = GetPermission();

            bodyWidth = Math.max($(document.body).width(), minWidth);
            bodyHeight = Math.max($(document.body).height(), minHeight);

            //设置查询面板
            SetLeftPanel();

            //设置结果面板
            SetRightPanel();

            //窗口调整大小
            $(window).resize(function () {
                var body = document.body;
                bodyWidth = Math.max($(document.body).width(), minWidth);
                bodyHeight = Math.max($(document.body).height(), minHeight);
                panelWidth = bodyWidth;
                ResizeControls();
            });
        });
        //#endregion 初始加载

        //#region 重设元素位置尺寸

        //#region 重设位置尺寸
        //重设网页元素位置
        function RepositionControls() {
            var lw = GetLeftPanelWidth();
            var lx = GetLeftPanelX();
            var ly = GetLeftPanelY();

            //设置结果集
            var rx = lx + lw + mt;
            var ry = ly;
            $("#rightPanel").css({ "left": rx, "top": ry });
        }

        //重设网页元素尺寸
        function ResizeControls() {
            var lp = $("#leftPanel");
            var rp = $("#rightPanel");
            var dh = bodyHeight;
            var pw = bodyWidth;
            var lx = GetLeftPanelX();
            var ly = GetLeftPanelY();
            var lw = GetLeftPanelWidth();
            var lh = dh - ly - 10;

            if (szdwFlowNode) {
                $(lp).outerHeight(lh);
                var fh = $("#flowNodeFilterPanel").outerHeight();
                szdwFlowNode.Resize(lw, lh - fh);
            }

            if (szdwXg) {
                var rx = lx + lw + ml;
                var rw = pw - rx - ml;
                var rh = lh;

                $("#rightPanel").outerWidth(rw).outerHeight(rh);
                var ph = $("#roleFilterPanel").outerHeight();
                szdwXg.Resize(rw, rh - ph);
            }
        }
        //#endregion 重设位置尺寸

        //#region 获取查询面板位置尺寸
        //获取查询面板高度
        function GetLeftPanelWidth() {
            var p = $("#leftPanel");
            return $(p).css("display") == "none" ? 0 : $(p).outerWidth(true);
        }

        function GetLeftPanelHeight() {
            var p = $("#leftPanel");
            return $(p).css("display") == "none" ? 0 : $(p).outerHeight(true);
        }

        //获取查询面板纵坐标
        function GetLeftPanelY() {
            var p = $("#leftPanel");
            return $(p).css("display") == "none" ? 0 : $(p).offset().top;
        }

        //获取查询面板横坐标
        function GetLeftPanelX() {
            var p = $("#leftPanel");
            return $(p).offset().left;
        }
        //#endregion 获取查询面板位置尺寸

        //#endregion 重设元素尺寸

        //#endregion 网页加载

        //#region 用户权限
        //获取用户Id
        function GetXuserId() {
            return $.parseJSON(SzdwCommon.getUrlParam("paramJson")).xuserId;

        }

        //获取菜单ID:xMenuId
        function GetXmenuId() {
            return $.parseJSON(SzdwCommon.getUrlParam("paramJson")).xmenuId;
        }

        //获取权限
        function GetPermission() {
            var jsonList = $.parseJSON(SzdwCommon.getUrlParam("paramJson")).permissionJsonList;
            return SzdwCommon.getPermission(jsonList);
        }
        //#endregion 用户权限

        //#region 左面板

        //#region 设置左面板
        function SetLeftPanel() {
            var lp = $("#leftPanel");
            var x = ml;
            var y = mt;
            var w = 340;
            var h = bodyHeight - y - 10;
            $(lp).css({ "position": "absolute", "left": x, "top": y }).outerWidth(w).outerHeight(h);

            //组筛选按钮
            CreateFlowNodeSearchButton();

            //节点名称文本框默认值设置
            var defaultValue = "节点名称筛选";
            $("#txtFlowNodeName").val(defaultValue);
            $("#txtFlowNodeName").css("color", "gray");

            //鼠标点进txtFlowNodeName时默认值消失
            $("#txtFlowNodeName").focus(function () {
                $("#txtFlowNodeName").val("");
                $("#txtFlowNodeName").css("color", "");
            }).blur(function () {
                var len = $.trim($("#txtFlowNodeName").val()).length;
                if (len <= 0) {
                    $("#txtFlowNodeName").val(defaultValue);
                    $("#txtFlowNodeName").css("color", "gray");
                }
                else {
                    $("#txtFlowNodeName").css("color", "");
                }
            });


            //节点名称回车筛选
            $("#txtFlowNodeName").keypress(function (e) {
                var k = e.which;
                if (k == 13) {
                    $(szdwFlowNodeSearchButton.button).trigger("click");
                }
            });

            //初始加载结果数据
            BindDdlFlow();
            GetFlowNodeList();
        }
        //#endregion 设置右面板

        //#region 节点筛选按钮
        var szdwFlowNodeSearchButton = null;
        function CreateFlowNodeSearchButton() {
            var nc = $("#txtFlowNodeName").parent();
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = btnHeight;
            szdwFlowNodeSearchButton = new SzdwButton(p, x, y, w, h);
            szdwFlowNodeSearchButton.namingContainer = nc;
            szdwFlowNodeSearchButton.imageWidth = btnImageWidth;
            szdwFlowNodeSearchButton.image = imgFile.query;
            szdwFlowNodeSearchButton.title = "节点名称筛选";
            szdwFlowNodeSearchButton.Load();

            //单击事件
            var btn = szdwFlowNodeSearchButton.button;
            $(btn).click(function (e) {
                var defaultValue = "节点名称筛选";
                var flowNodeName=$("#txtFlowNodeName").val();
                if (flowNodeName == defaultValue) {
                    flowNodeName = "";
                }
                szdwFlowNode.paramJson["name"] = flowNodeName;
                szdwFlowNode.paramJson["flowId"] = $.trim($("#ddlFlow").data("value"));
                szdwFlowNode.DataBind();
                e.stopPropagation();
            });
        }
        //#endregion 组筛选按钮

        //#region 流程类别列表下拉框
        var szdwDdlFlow = null;
        function BindDdlFlow() {
            var requestUrl = "../Permission/PermissionDropDwonListProcess.ashx";
            //部门下拉框
            var paramJson = { MethodName: "GetFlowList" };
            var paramDdlDep = { requestUrl: requestUrl, paramJson: paramJson, fnInitial: InitialDdlFlow, maxHeight: 300 };
            $("#ddlFlow").dropDownList(paramDdlDep);
            $("#ddlFlow").val("检测报告审核");
            $("#ddlFlow").data("value", 1);
        }
        //通用下拉框初始化设置
        function InitialDdlFlow(szdwDdl) {
            szdwDdl.jsonItemAll = { Id: 0, Name: "全部" };
            szdwDdl.fnItemClick = function () {
                flowId = $.trim($("#ddlFlow").data("value"));
                $(szdwFlowNodeSearchButton.button).trigger("click");
            }
        }
        //#endregion 部门列表下拉框

        //#region 获取数据
        function GetFlowNodeList() {
            //设置结果面板相关属性
            var lph = GetLeftPanelHeight();
            var rfph = $("#flowNodeFilterPanel").outerHeight();
            var c = $("#flowNodeDataPanel");
            var position = "relative";
            var x = 0;
            var y = 0;
            var w = GetLeftPanelWidth();
            var h = lph - rfph;

            //创建Gridview并绑定数据
            CreateFlowNodeGridView(c, position, x, y, w, h);
        }
        //#endregion 获取数据

        //#region 查询结果

        //#region 获取查询参数
        function GetFlowNodeParamJson() {
            var xuserId = xuserId;
            var defaultValue = "节点名称筛选";
            var flowNodeName = $.trim($("#txtFlowNodeName").val());
            if (flowNodeName == defaultValue) {
                flowNodeName = "";
            }
            var flowId = $("#ddlFlow").data("value");
            var paramJson = { flowId: flowId };

            if (flowNodeName.length > 0) {
                paramJson["name"] = flowNodeName;
            }

            return paramJson;
        }
        //#endregion 获取查询参数

        //#region 创建Gridview并绑定数据
        var szdwFlowNode = null;
        function CreateFlowNodeGridView(namingContainer, position, x, y, width, height) {
            if (szdwFlowNode == null || typeof (szdwFlowNode) == "undefined") {
                //创建SzdwGridViewt实例
                szdwFlowNode = new SzdwGridView(position, x, y, width, height);
                szdwFlowNode.namingContainer = namingContainer;
                szdwFlowNode.fnInitial = InitialSzdwFlowNode(szdwFlowNode);
                szdwFlowNode.fnRowClick = SzdwFlowNodeRowClick;
                szdwFlowNode.fnDataBindCallBack = InitialRowClick;
            }

            //异步加载数据
            if (szdwFlowNode.pagination != null) {
                szdwFlowNode.pagination.ResetBar();
            }

            var paramJson = GetFlowNodeParamJson();
            paramJson["pageSize"] = szdwFlowNode.pageSize;
            paramJson["MethodName"] = "FlowNodeGetList";
            szdwFlowNode.requestUrl = "../Flow/FlowNodeProcess.ashx";
            szdwFlowNode.paramJson = paramJson;
            szdwFlowNode.DataBind();
        }


        //初次加载时默认选中第一行，并加载该Group对应的用户数据
        function InitialRowClick() {
            $(szdwFlowNode.bodyRows[0]).trigger("click");
        }
        //#endregion 创建Gridview并绑定数据

        //#region 初始化Gridview属性
        function InitialSzdwFlowNode(szdwFlowNode) {
            //个性样式设置
            szdwFlowNode.dataPanelCssJson = { "background-color": "White" };
            szdwFlowNode.paginationCssJson = { "background-color": "White", "font-family": "微软雅黑", "font-size": "small", "border": "1px solid Silver", "border-top": "0px" };
            szdwFlowNode.minHeight = 300;
            szdwFlowNode.allowRowClickEvent = true;

            //dataPanel设置
            szdwFlowNode.hasSumRow = false;
            szdwFlowNode.hasPagination = false;
            szdwFlowNode.hasButtonPanel = true;
            szdwFlowNode.pageSize = 1000;

            //head设置
            szdwFlowNode.headCssName = "gridHead2";
            szdwFlowNode.headHeight = 30;
            szdwFlowNode.fieldJsonData = [{ "Field": "RowNumber", "Text": "序号", "Width": 40 },
                                          { "Field": "Flow", "Text": "流程类别", "Width": 100 },
                                          { "Field": "Name", "Text": "节点名称", "Width": 200, "OrderField": "Name" }];

            szdwFlowNode.cellCssJson = {
                "Name": { "text-align": "left" },
                "Memo": { "text-align": "left" }
            };
        }
        //#endregion 初始化Gridview属性

        //#region 行单击事件
        function SzdwFlowNodeRowClick(rowIndex) {
            var jsonList = szdwFlowNode.recordSetJson;
            if (jsonList) {
                var jsonData = jsonList[rowIndex];
                var flowNodeId = jsonData.Id;
                var flowId = jsonData.FlowId;
                if (szdwXg) {
                    szdwXg.paramJson["flowNodeId"] = flowNodeId;
                    szdwXg.paramJson["flowId"] = flowId;
                    szdwXg.paramJson["flowNode"] = jsonData.Name;
                    szdwXg.DataBind();
                }
            }
        }
        //#endregion 行单击事件

        //#endregion 查询结果
        //#endregion 右面板

        //#region 右面板

        //#region 设置右面板
        function SetRightPanel() {
            var lp = $("#leftPanel");
            var lw = GetLeftPanelWidth();
            var lh = GetLeftPanelHeight();
            var lx = GetLeftPanelX();
            var ly = GetLeftPanelY();
            var x = lx + lw + ml;
            var y = ly;
            var w = bodyWidth - x - ml;
            var h = lh;

            var rp = $("#rightPanel");
            $(rp).css({ "position": "absolute", "left": x, "top": y }).outerWidth(w).outerHeight(h);

            //组筛选控件加载
            CreateFlowNodeRoleFilter();

            //初始加载结果数据
            GetFlowNodeRoleList();
        }
        //#endregion 设置右面板

        //#region 添加角色到节点筛选

        //#region 角色筛选控件加载
        function CreateFlowNodeRoleFilter() {
            BindDdlAssingType();
            CreateFlowNodeRoleSearchButton();

            //组名称回车筛选
            $("#txtDepartmentName").keypress(function (e) {
                var k = e.which;
                if (k == 13) {
                    $(szdwFlowNodeRoleSearchButton.button).trigger("click");
                }
            });
        }
        //#endregion 角色权限筛选控件加载

        //#region 下拉框执行事件:刷新数据
        function RefreshSzdwFlowNodeRole() {
            $(szdwFlowNodeRoleSearchButton.button).trigger("click");
        }
        //#endregion 下拉框执行事件

        //#region 指派类别下拉框
        function BindDdlAssingType() {
            var jsonList = [{ Id: 1, Name: "已添加" }, { Id: 2, Name: "未添加" }];
            var paramDdl = { jsonList: jsonList, fnInitial: InitialDdl };
            $("#ddlAssignType").dropDownList(paramDdl);
            $("#ddlAssignType").text("全部").data("value", 0);
        }
        //#endregion 指派类别下拉框

        //#region 通用下拉框初始化设置
        function InitialDdl(szdwDdl) {
            szdwDdl.jsonItemAll = { Id: 0, Name: "全部" };
            szdwDdl.fnItemClick = RefreshSzdwFlowNodeRole;
        }
        //#endregion 通用下拉框初始化设置

        //#region 用户筛选按钮
        var szdwFlowNodeRoleSearchButton = null;
        function CreateFlowNodeRoleSearchButton() {
            var nc = $("#txtDepartmentName").parent();
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = btnHeight;
            szdwFlowNodeRoleSearchButton = new SzdwButton(p, x, y, w, h);
            szdwFlowNodeRoleSearchButton.namingContainer = nc;
            szdwFlowNodeRoleSearchButton.imageWidth = btnImageWidth;
            szdwFlowNodeRoleSearchButton.image = imgFile.query; ;
            szdwFlowNodeRoleSearchButton.title = "部门名称筛选";
            szdwFlowNodeRoleSearchButton.Load();

            //单击事件
            var btn = szdwFlowNodeRoleSearchButton.button;
            $(btn).click(function (e) {
                szdwXg.paramJson["assignType"] = $("#ddlAssignType").data("value");

                szdwXg.paramJson["name"] = null;

                var name = $.trim($("#txtDepartmentName").val());
                szdwXg.paramJson["name"] = name;

                szdwXg.DataBind();
                e.stopPropagation();
            });
        }
        //#endregion 组筛选按钮

        //#endregion 添加组到角色筛选

        //#region 获取数据
        function GetFlowNodeRoleList() {
            //设置结果面板相关属性
            var rph = $("#rightPanel").height();
            var rpfph = $("#roleFilterPanel").outerHeight();
            var rc = $("#xgDataPanel");
            var position = "relative";
            var x = 0;
            var y = 0;
            var w = $("#rightPanel").width();
            var h = rph - rpfph;

            //创建Gridview并绑定数据
            CreateXgGridView(rc, position, x, y, w, h);
        }

        //#endregion 获取数据

        //#region 查询结果

        //#region 获取查询参数
        function GetXgParamJson() {
            var xuserId = xuserId;
            var departmentName = $.trim($("#txtDepartmentName").val());
            var paramJson = { xuserId: xuserId };

            if (departmentName.length > 0) {
                paramJson["Name"] = departmentName;
            }
            return paramJson;
        }
        //#endregion 获取查询参数

        //#region 创建Gridview并绑定数据
        var szdwXg = null;
        function CreateXgGridView(namingContainer, position, x, y, width, height) {
            if (szdwXg == null || typeof (szdwXg) == "undefined") {
                //创建SzdwGridViewt实例
                szdwXg = new SzdwGridView(position, x, y, width, height);
                szdwXg.namingContainer = namingContainer;
                szdwXg.fnInitial = InitialSzdwXg(szdwXg);
            }

            //异步加载数据
            if (szdwXg.pagination != null) {
                szdwXg.pagination.ResetBar();
            }

            var paramJson = GetXgParamJson();
            paramJson["pageSize"] = szdwXg.pageSize;
            paramJson["MethodName"] = "FlowNodeDepartmentGetList";
            szdwXg.requestUrl = "FlowNodeDepartmentProcess.ashx";
            szdwXg.paramJson = paramJson;
        }
        //#endregion 创建Gridview并绑定数据

        //#region 初始化Gridview属性
        function InitialSzdwXg(szdwXg) {
            //个性样式设置
            szdwXg.dataPanelCssJson = { "background-color": "White" };
            szdwXg.paginationCssJson = { "background-color": "White", "font-family": "微软雅黑", "font-size": "small", "border-top": "1px solid Silver" };
            szdwXg.minHeight = 300;

            //dataPanel设置
            szdwXg.hasSumRow = false;
            szdwXg.hasButtonPanel = true;
            szdwXg.freezeCols = 2;
            szdwXg.scrollKeeingType = 1;

            //head设置
            szdwXg.headCssName = "gridHead2";
            szdwXg.headHeight = 30;
            szdwXg.fieldJsonData = [{ "Field": "RowNumber", "Text": "序号", "Width": 50 },
                                    { "Field": "Department", "Text": "部门名称", "Width": 250, "OrderField": "Department" },
                                    { "Field": "AssignGroup", "Text": "添加部门到节点", "Width": 350, "FnControlColumn": CreateCellControl, "Style": { "text-align": "center", "color": "red" } }
            ];

            szdwXg.cellCssJson = {
                "Department": { "text-align": "left" },
                "Memo": { "text-align": "left" },
                "AssignGroup": { "text-align": "left" }
            };
        }
        //#endregion 初始化Gridview属性

        //#region 自定义控件列
        //被审批人设置控件
        function CreateCellControl(jsonList, cell) {
            var rowIndex = $(cell).data("rowIndex");
            var isAssigned = jsonList[rowIndex].IsAssigned;
            var departmentId = jsonList[rowIndex].DepartmentId;

            //列中的控件box
            var c = document.createElement("div");
            $(c).css({ "height": 25, "line-height": "25px" });

            //checkbox
            var chk = document.createElement("input");
            $(chk).attr("type", "checkbox").attr("id", "chkRole").attr("disabled", true);
            $(chk).css({ "float": "left", "height": 18, "line-height": "18px" });
            $(chk).prop("checked", isAssigned);

            var s = document.createElement("label");
            $(s).css({ "float": "left", "height": 25, "line-height": "25px" });
            var flowNode = szdwXg.paramJson["flowNode"];

            if (isAssigned) {
                $(s).text("已添加到节点:" + flowNode);
                $(s).css("color", "red");
            }

            $(c).append(chk).append(s);


            //按钮
            if (permission.insertPermission && permission.deletePermission && permission.modifyPermission) {
                var btn = document.createElement("input");
                $(btn).attr("type", "button").addClass("button2");
                $(btn).css({ "float": "right", "width": 45, "height": 25 });
                var text = isAssigned ? "移除" : "添加";
                $(btn).val(text);
                $(btn).val(text).appendTo(c);
                //绑定事件
                $(btn).click(function () {
                    if (isAssigned) {
                        var flowNodeId = jsonList[rowIndex].FlowNodeId;
                        var flowId = jsonList[rowIndex].FlowId;
                        var paramJson = { departmentId: departmentId, flowNodeId: flowNodeId, flowId: flowId, xuserId: xuserId };
                        FlowNodeDepartmentDelete(paramJson);
                    } else {
                        var creatorId = xuserId;
                        var flowNodeId = szdwXg.paramJson["flowNodeId"];
                        var flowId = szdwXg.paramJson["flowId"];
                        var paramJson = { departmentId: departmentId, flowNodeId: flowNodeId, flowId: flowId, creatorId: creatorId };
                        FlowNodeDepartmentInsert(paramJson);
                    }
                });

            }

            return c;
        }

        //#region 添加或移除角色
        //添加用户
        function FlowNodeDepartmentInsert(paramJson) {
            var objDataBind = szdwXg;
            var requestUrl = "FlowNodeDepartmentProcess.ashx";
            paramJson["MethodName"] = "FlowNodeDepartmentInsert";
            SzdwAjaxDataOperate.ajaxInsert(objDataBind, requestUrl, paramJson);
        }

        //移除角色
        function FlowNodeDepartmentDelete(paramJson) {
            var objDataBind = szdwXg;
            var requestUrl = "FlowNodeDepartmentProcess.ashx";
            paramJson["MethodName"] = "FlowNodeDepartmentDelete";
            SzdwAjaxDataOperate.ajaxDelete(objDataBind, requestUrl, paramJson);
        }
        //#endregion 添加或移除角色
        //#endregion 自定义控件列
        //#endregion 查询结果
        //#endregion 右面板

    </script>
</body>
</html>
