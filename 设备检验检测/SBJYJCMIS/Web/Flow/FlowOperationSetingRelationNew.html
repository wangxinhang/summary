<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="../Styles/Page.css" rel="stylesheet" type="text/css" />
    <link href="../Styles/Query.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwDropDownList.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwGridView.js" type="text/javascript"></script>
    <link href="../SzdwControls/SzdwGridView.css" rel="stylesheet" type="text/css" />
    <script src="../SzdwControls/SzdwPagination.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwButton.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwPopupWindow.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwAjaxDataOperate.js" type="text/javascript"></script>
    <script src="../Scripts/myparm.js" type="text/javascript"></script>
    <script src="../SzdwControls/domCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwInfoPanel.js" type="text/javascript"></script>
    <style type="text/css">
        input::-ms-clear {
            display: none;
        }
    </style>
</head>
<body style="background-color: #EEEEEE">
    <form action="">
        <div id="leftPanel">
            <div id="flowOperationFilterPanel" style="height: 25px; padding-bottom: 10px;">
                <div id="rfpCell00" class="cellDiv" style="color: #1B60C3; font-size: 12pt; font-family: 微软雅黑;">
                    <input id="ddlFlow" type="text" class="dropDownList" style="width:100px; background-color: transparent; text-align:center;" />
                </div>
                <div>
                    <div id="rfpCell01" class="cellDiv" style="border-left: 1px solid #DDDDDD; margin-left: 10px;">
                        <input id="txtFlowOperationName" type="text" class="textBox2" style="background-color: transparent;
                    border-right: 0px;" />
                    </div>
                </div>
            </div>
            <div id="flowOperationDataPanel" class="dataPanel">
            </div>
        </div>
        <div id="rightPanel" >
            <div id="flowRuleDiv" style="height:290px; margin-top:10px;">
                <div id="roleFilterPanel" style="height: 25px; padding-bottom: 0px;">
                    <div id="rpfpCell00" class="cellDiv" style="color: #1B60C3; font-size: 12pt; font-family: 微软雅黑;">
                        设置流程操作与流程规则
                    </div>
                </div>
                <div id="xgDataPanel" class="dataPanel" style="height:250px;">
                </div>
            </div>
            <div id="flowStatusDiv" style="height:290px; ">
                <div id="StatusFilterPanel" style="height: 25px; padding-bottom: 0px;">
                    <div id="rpfpStatusCell00" class="cellDiv" style="color: #1B60C3; font-size: 12pt; font-family: 微软雅黑;">
                        设置流程操作与流程状态关联
                    </div>
                </div>
                <div id="flowStatusDataPanel" class="dataPanel" style="height:250px; ">
                </div>
            </div>
            <div id="RectificationTypeDiv" style="height:290px; ">
                <div id="RectificationTypeFilterPanel" style="height: 25px; padding-bottom: 0px;">
                    <div id="rpfpRectificationTypeCell00" class="cellDiv" style="color:#1B60C3; font-size:12pt; font-family:微软雅黑;">
                        设置流程操作与处理类别关联
                    </div>
                </div>
                <div id="RectificationTypeDataPanel" class="dataPanel" style="height:250px;">
                </div>
            </div>
            <div id="HandleResultDiv" style="height:290px; ">
                <div id="HandleResultFilterPanel" style="height: 25px; padding-bottom: 0px;">
                    <div id="rpfpHandleResultCell00" class="cellDiv" style="color:#1B60C3; font-size:12pt; font-family:微软雅黑;">
                        设置流程操作与处理结果关联
                    </div>
                </div>
                <div id="HandleResultDataPanel" class="dataPanel" style="height:250px;">
                </div>
            </div>
        </div>
    </form>
    <script type="text/javascript">
        //#region 全局变量
        var xuserId, xmenuId, permission = null; //用户及权限：json格式
        var ml = 20; mt = 20; //ml:margin-left;mt:margin-top;
        var btnWidth = 90; btnHeight = 26; btnImageWidth = 25; //btnWidth:按钮宽;btnHeight:按钮高;btnImageWidth:按钮图片宽
        //#endregion 全局变量

        //#region 网页加载

        //#region 初始加载
        $(document).ready(function () {
            //获取用户Id和MenuId
            xuserId = GetXuserId();
            xmenuId = GetXmenuId();
            permission = GetPermission();

            bodyWidth = Math.max($(document.body).width(), minWidth);
            bodyHeight = Math.max($(document.body).height(), minHeight);

            //设置查询面板
            SetLeftPanel();

            //设置结果面板
            SetRightPanel();

            //窗口调整大小
            $(window).resize(function () {
                var body = document.body;
                bodyWidth = Math.max($(document.body).width(), minWidth);
                bodyHeight = Math.max($(document.body).height(), minHeight);
                panelWidth = bodyWidth;
                ResizeControls();
            });
        });
        //#endregion 初始加载

        //#region 重设元素位置尺寸

        //#region 重设位置尺寸
        //重设网页元素位置
        function RepositionControls() {
            var lw = GetLeftPanelWidth();
            var lx = GetLeftPanelX();
            var ly = GetLeftPanelY();

            //设置结果集
            var rx = lx + lw + mt;
            var ry = ly;
            $("#rightPanel").css({ "left": rx, "top": ry });
        }

        //重设网页元素尺寸
        function ResizeControls() {
            var lp = $("#leftPanel");
            var rp = $("#rightPanel");
            var dh = bodyHeight;
            var pw = bodyWidth;
            var lx = GetLeftPanelX();
            var ly = GetLeftPanelY();
            var lw = GetLeftPanelWidth();
            var lh = dh - ly - mt;

            if (szdwFlowOperation) {
                $("#leftPanel").outerHeight(lh);
                var fofph = $("#flowOperationFilterPanel").outerHeight();
                szdwFlowOperation.Resize(lw, lh - fofph);
            }

            if (szdwXg) {
                var rx = lx + lw + ml;
                var rw = pw - rx - ml;
                var rh = lh;

                $("#rightPanel").outerWidth(rw).outerHeight(rh);
                szdwXg.Resize(rw-10, "250px");
            }
            if (szdwFlowStatus) {
                var rx = lx + lw + ml;
                var rw = pw - rx - ml;
                var rh = lh;

                $("#rightPanel").outerWidth(rw).outerHeight(rh);
                szdwFlowStatus.Resize(rw - 10, "250px");
            }
            if (szdwRectificationType) {
                var rx = lx + lw + ml;
                var rw = pw - rx - ml;
                var rh = lh;

                $("#rightPanel").outerWidth(rw).outerHeight(rh);
                szdwRectificationType.Resize(rw - 10, "250px");
            }
            if (szdwHandleResult) {
                var rx = lx + lw + ml;
                var rw = pw - rx - ml;
                var rh = lh;

                $("#rightPanel").outerWidth(rw).outerHeight(rh);
                szdwHandleResult.Resize(rw - 10, "250px");
            }
        }
        //#endregion 重设位置尺寸

        //#region 获取查询面板位置尺寸
        //获取查询面板高度
        function GetLeftPanelWidth() {
            var p = $("#leftPanel");
            return $(p).css("display") == "none" ? 0 : $(p).outerWidth(true);
        }

        function GetLeftPanelHeight() {
            var p = $("#leftPanel");
            return $(p).css("display") == "none" ? 0 : $(p).outerHeight(true);
        }

        //获取查询面板纵坐标
        function GetLeftPanelY() {
            var p = $("#leftPanel");
            return $(p).css("display") == "none" ? 0 : $(p).offset().top;
        }

        //获取查询面板横坐标
        function GetLeftPanelX() {
            var p = $("#leftPanel");
            return $(p).offset().left;
        }
        //#endregion 获取查询面板位置尺寸

        //#endregion 重设元素尺寸

        //#endregion 网页加载

        //#region 用户权限
        //获取用户Id
        function GetXuserId() {
            return $.parseJSON(SzdwCommon.getUrlParam("paramJson")).xuserId;

        }

        //获取菜单ID:xMenuId
        function GetXmenuId() {
            return $.parseJSON(SzdwCommon.getUrlParam("paramJson")).xmenuId;
        }

        //获取权限
        function GetPermission() {
            var jsonList = $.parseJSON(SzdwCommon.getUrlParam("paramJson")).permissionJsonList;
            return SzdwCommon.getPermission(jsonList);
        }
        //#endregion 用户权限

        //#region 左面板

        //#region 设置左面板
        function SetLeftPanel() {
            var lp = $("#leftPanel");
            var x = ml;
            var y = mt;
            var w = 320;
            var h = bodyHeight - y - mt;
            $(lp).css({ "position": "absolute", "left": x, "top": y }).outerWidth(w).outerHeight(h);

            //组筛选按钮
            CreateFlowOperationSearchButton();

            //节点名称文本框默认值设置
            var defaultValue = "操作名称筛选";
            $("#txtFlowOperationName").val(defaultValue);
            $("#txtFlowOperationName").css("color", "gray");

            //鼠标点进txtFlowNodeName时默认值消失
            $("#txtFlowOperationName").focus(function () {
                $("#txtFlowOperationName").val("");
                $("#txtFlowOperationName").css("color", "");
            }).blur(function () {
                var len = $.trim($("#txtFlowOperationName").val()).length;
                if (len <= 0) {
                    $("#txtFlowOperationName").val(defaultValue);
                    $("#txtFlowOperationName").css("color", "gray");
                }
                else {
                    $("#txtFlowOperationName").css("color", "");
                }
            });


            //节点名称回车筛选
            $("#txtFlowOperationName").keypress(function (e) {
                var k = e.which;
                if (k == 13) {
                    $(szdwFlowOperationSearchButton.button).trigger("click");
                }
            });

            //初始加载结果数据
            BindDdlFlow();
            GetFlowOperationList();
        }
        //#endregion 设置右面板

        //#region 节点筛选按钮
        var szdwFlowOperationSearchButton = null;
        function CreateFlowOperationSearchButton() {
            var nc = $("#txtFlowOperationName").parent();
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = btnHeight;
            szdwFlowOperationSearchButton = new SzdwButton(p, x, y, w, h);
            szdwFlowOperationSearchButton.namingContainer = nc;
            szdwFlowOperationSearchButton.imageWidth = btnImageWidth;
            szdwFlowOperationSearchButton.image = imgFile.query;
            szdwFlowOperationSearchButton.title = "操作名称筛选";
            szdwFlowOperationSearchButton.Load();

            //单击事件
            var btn = szdwFlowOperationSearchButton.button;
            $(btn).click(function (e) {
                var defaultValue = "操作名称筛选";
                var FlowOperationName = $("#txtFlowOperationName").val();
                if (FlowOperationName == defaultValue) {
                    FlowOperationName = "";
                }
                szdwFlowOperation.paramJson["name"] = FlowOperationName;
                szdwFlowOperation.paramJson["flowId"] = $.trim($("#ddlFlow").data("value"));
                szdwFlowOperation.DataBind();
                e.stopPropagation();
            });
        }
        //#endregion 组筛选按钮

        //#region 流程类别列表下拉框
        var szdwDdlFlow = null;
        function BindDdlFlow() {
            var requestUrl = "../Permission/PermissionDropDwonListProcess.ashx";
            //部门下拉框
            var paramJson = { MethodName: "GetFlowList" };
            var paramDdlDep = { requestUrl: requestUrl, paramJson: paramJson, fnInitial: InitialDdlFlow, maxHeight: 300 };
            $("#ddlFlow").dropDownList(paramDdlDep);
            $("#ddlFlow").val("检测报告审核");
            $("#ddlFlow").data("value", 1);
        }
        //通用下拉框初始化设置
        function InitialDdlFlow(szdwDdl) {
            szdwDdl.jsonItemAll = { Id: 0, Name: "全部" };
            szdwDdl.fnItemClick = function () {
                flowId = $.trim($("#ddlFlow").data("value"));
                $(szdwFlowOperationSearchButton.button).trigger("click");
            }
        }
        //#endregion 部门列表下拉框

        //#region 获取数据
        function GetFlowOperationList() {
            //设置结果面板相关属性
            var lph = GetLeftPanelHeight();
            var rfph = $("#flowOperationFilterPanel").outerHeight();
            var c = $("#flowOperationDataPanel");
            var position = "relative";
            var x = 0;
            var y = 0;
            var w = GetLeftPanelWidth();
            var h = lph - rfph;

            //创建Gridview并绑定数据
            CreateFlowOperationGridView(c, position, x, y, w, h);
        }
        //#endregion 获取数据

        //#region 查询结果

        //#region 获取查询参数
        function GetFlowOperationParamJson() {
            var xuserId = xuserId;
            var defaultValue = "操作名称筛选";
            var flowOperationName = $.trim($("#txtFlowOperationName").val());
            if (flowOperationName == defaultValue) {
                flowOperationName = "";
            }
            var flowId = $("#ddlFlow").data("value");
            var paramJson = { flowId: flowId };

            if (flowOperationName.length > 0) {
                paramJson["name"] = flowOperationName;
            }

            return paramJson;
        }
        //#endregion 获取查询参数

        //#region 创建Gridview并绑定数据
        var szdwFlowOperation = null;
        function CreateFlowOperationGridView(namingContainer, position, x, y, width, height) {
            if (szdwFlowOperation == null || typeof (szdwFlowOperation) == "undefined") {
                //创建SzdwGridViewt实例
                szdwFlowOperation = new SzdwGridView(position, x, y, width, height);
                szdwFlowOperation.namingContainer = namingContainer;
                szdwFlowOperation.fnInitial = InitialSzdwFlowOperation(szdwFlowOperation);
                szdwFlowOperation.fnRowClick = FlowOperationRowClick;
                szdwFlowOperation.fnDataBindCallBack = InitialRowClick;
            }

            //异步加载数据
            if (szdwFlowOperation.pagination != null) {
                szdwFlowOperation.pagination.ResetBar();
            }

            var paramJson = GetFlowOperationParamJson();
            paramJson["pageSize"] = szdwFlowOperation.pageSize;
            paramJson["MethodName"] = "FlowOperationGetList";
            szdwFlowOperation.requestUrl = "FlowOperationRelationSetingProcess.ashx";
            szdwFlowOperation.paramJson = paramJson;
            szdwFlowOperation.DataBind();
        }


        //初次加载时默认选中第一行，并加载该Group对应的用户数据
        function InitialRowClick() {
            $(szdwFlowOperation.bodyRows[0]).trigger("click");
        }
        //#endregion 创建Gridview并绑定数据

        //#region 初始化Gridview属性
        function InitialSzdwFlowOperation(szdwFlowOperation) {
            //个性样式设置
            szdwFlowOperation.dataPanelCssJson = { "background-color": "White" };
            szdwFlowOperation.paginationCssJson = { "background-color": "White", "font-family": "微软雅黑", "font-size": "small", "border-top": "0px" };
            szdwFlowOperation.minHeight = 200;
            szdwFlowOperation.allowRowClickEvent = true;

            //dataPanel设置
            szdwFlowOperation.hasSumRow = false;
            szdwFlowOperation.hasPagination = false;
            szdwFlowOperation.hasButtonPanel = true;
            szdwFlowOperation.pageSize = 1000;

            //head设置
            szdwFlowOperation.headCssName = "gridHead2";
            szdwFlowOperation.headHeight = 30;
            szdwFlowOperation.fieldJsonData = [{ "Field": "RowNumber", "Text": "序号", "Width": 40 },
                                          { "Field": "Flow", "Text": "流程类别", "Width": 120 },
                                          { "Field": "Name", "Text": "流程操作名称", "Width": 150, "OrderField": "Name" }];

            szdwFlowOperation.cellCssJson = {
                "Name": { "text-align": "left" },
                "Memo": { "text-align": "left" }
            };
        }
        //#endregion 初始化Gridview属性

        //#region 行单击事件
        function FlowOperationRowClick(rowIndex) {
            var jsonList = szdwFlowOperation.recordSetJson;
            if (jsonList) {
                var jsonData = jsonList[rowIndex];
                var flowOperationId = jsonData.Id;
                var flowId = jsonData.FlowId;
                if (szdwXg) {
                    szdwXg.paramJson["flowOperationId"] = flowOperationId;
                    szdwXg.paramJson["flowId"] = flowId;
                    szdwXg.paramJson["flowOperation"] = jsonData.Name;
                    szdwXg.DataBind();
                }
                if (szdwFlowStatus) {
                    szdwFlowStatus.paramJson["flowOperationId"] = flowOperationId;
                    szdwFlowStatus.paramJson["flowId"] = flowId;
                    szdwFlowStatus.paramJson["flowOperation"] = jsonData.Name;
                    szdwFlowStatus.DataBind();
                }
                if (szdwRectificationType) {
                    szdwRectificationType.paramJson["flowOperationId"] = flowOperationId;
                    szdwRectificationType.paramJson["flowId"] = flowId;
                    szdwRectificationType.paramJson["flowOperation"] = jsonData.Name;
                    szdwRectificationType.DataBind();
                }
                if (szdwHandleResult) {
                    szdwHandleResult.paramJson["flowOperationId"] = flowOperationId;
                    szdwHandleResult.paramJson["flowId"] = flowId;
                    szdwHandleResult.paramJson["flowOperation"] = jsonData.Name;
                    szdwHandleResult.DataBind();
                }
            }
        }
        //#endregion 行单击事件

        //#endregion 查询结果
        //#endregion 右面板

        //#region 右面板

        //#region 设置右面板
        function SetRightPanel() {
            var lp = $("#leftPanel");
            var lw = GetLeftPanelWidth();
            var lh = GetLeftPanelHeight();
            var lx = GetLeftPanelX();
            var ly = GetLeftPanelY();
            var x = lx + lw + ml;
            var y = ly;
            var w = bodyWidth - x - ml;
            var h = lh;

            var rp = $("#rightPanel");
            $(rp).css({ "position": "absolute", "left": x, "top": y, "overflow": "hidden" }).outerWidth(w).outerHeight(h);
            //设置滚动条
            $(rp).addClass("scrollBar2");
            $(rp).mouseover(function () {
                $(this).css({ "overflow-y": "auto" });
            }).mouseleave(function () {
                $(this).css({ "overflow-y": "hidden" });
            });

            //初始加载流程曹组与流程规则关联列表
            GetFlowOperationRuleList();
            //初始加载流程曹组与流程状态关联列表
            GetFlowOperationStatusList();
            //初始加载流程曹组与处理类别关联表
            GetFlowOperationRectificationTypeList();
            //初始加载流程曹组与处理结果关联表
            GetFlowOperationHandleResultList();
        }
        //#endregion 设置右面板

        //#region 流程操作与流程触发规则关联

        //#region 获取数据
        function GetFlowOperationRuleList() {
            //设置结果面板相关属性
            var rph = $("#rightPanel").height();
            var rpfph = $("#roleFilterPanel").outerHeight();
            var rc = $("#xgDataPanel");
            var position = "relative";
            var x = 0;
            var y = 0;
            var w = $("#rightPanel").width() - 10;
            var h = rc.outerHeight();

            //创建Gridview并绑定数据
            CreateXgGridView(rc, position, x, y, w, h);
        }

        //#endregion 获取数据

        //#region 查询结果

        //#region 获取查询参数
        function GetXgParamJson() {
            var xuserId = xuserId;
            var flowId = $("#ddlFlow").data("value");
            var paramJson = { xuserId: xuserId, flowId: flowId };
            return paramJson;
        }
        //#endregion 获取查询参数

        //#region 创建Gridview并绑定数据
        var szdwXg = null;
        function CreateXgGridView(namingContainer, position, x, y, width, height) {
            if (szdwXg == null || typeof (szdwXg) == "undefined") {
                //创建SzdwGridViewt实例
                szdwXg = new SzdwGridView(position, x, y, width, height);
                szdwXg.namingContainer = namingContainer;
                szdwXg.fnInitial = InitialSzdwXg(szdwXg);
            }

            //异步加载数据
            if (szdwXg.pagination != null) {
                szdwXg.pagination.ResetBar();
            }

            var paramJson = GetXgParamJson();
            paramJson["pageSize"] = szdwXg.pageSize;
            paramJson["MethodName"] = "FlowRuleGetList";
            szdwXg.requestUrl = "FlowOperationRelationSetingProcess.ashx";
            szdwXg.paramJson = paramJson;
        }
        //#endregion 创建Gridview并绑定数据

        //#region 初始化Gridview属性
        function InitialSzdwXg(szdwXg) {
            //个性样式设置
            szdwXg.dataPanelCssJson = { "background-color": "White", "border-bottom": "1px solid Silver" };
            szdwXg.paginationCssJson = { "background-color": "White", "font-family": "微软雅黑", "font-size": "small", "border": "1px solid Silver", "border-top": "0px" };
            szdwXg.minHeight = 300;

            //dataPanel设置
            szdwXg.hasSumRow = false;
            szdwXg.hasButtonPanel = true;
            szdwXg.hasPagination = false;


            //head设置
            szdwXg.headCssName = "gridHead2";
            szdwXg.headHeight = 30;
            szdwXg.fieldJsonData = [{ "Field": "RowNumber", "Text": "序号", "Width": 50 },
                                            { "Field": "Name", "Text": "流程触发名称", "Width": 100 },
                                            { "Field": "AssignRole", "Text": "与流程操作关联", "Width": 250, "FnControlColumn": CreateCellControl, "Style": { "text-align": "center", "color": "red" } }
            ];

            szdwXg.cellCssJson = {
                "Memo": { "text-align": "left" },
                "AssignGroup": { "text-align": "left" }
            };
        }
        //#endregion 初始化Gridview属性

        //#region 自定义控件列
        //被审批人设置控件
        function CreateCellControl(jsonList, cell) {
            var rowIndex = $(cell).data("rowIndex");
            var isAssigned = jsonList[rowIndex].IsAssigned;
            var Id = jsonList[rowIndex].Id;

            //列中的控件box
            var c = document.createElement("div");
            $(c).css({ "height": 25, "line-height": "25px" });

            //checkbox
            var chk = document.createElement("input");
            $(chk).attr("type", "checkbox").attr("id", "chkRole").attr("disabled", true);
            $(chk).css({ "float": "left", "height": 18, "line-height": "18px" });
            $(chk).prop("checked", isAssigned);

            var s = document.createElement("label");
            $(s).css({ "float": "left", "height": 25, "line-height": "25px" });
            var flowOperation = szdwXg.paramJson["flowOperation"];
            if (isAssigned) {
                $(s).text("与" + flowOperation + " 已关联");
                $(s).css("color", "red");
            }
            $(c).append(chk).append(s);

            //按钮
            if (permission.insertPermission && permission.deletePermission && permission.modifyPermission) {
                var btn = document.createElement("input");
                $(btn).attr("type", "button").addClass("button2");
                $(btn).css({ "float": "right", "width": 45, "height": 25 });
                var text = isAssigned ? "移除" : "添加";
                $(btn).val(text).appendTo(c);

                //绑定事件
                $(btn).click(function () {
                    if (isAssigned) {
                        var flowOperationId = szdwXg.paramJson["flowOperationId"];
                        var flowId = szdwXg.paramJson["flowId"];
                        var Id = jsonList[rowIndex].Id;
                        var modifierId = xuserId;
                        var paramJson = { flowOperationId: flowOperationId, Id: Id, flowId: flowId, modifierId: modifierId };
                        FlowOperationRuleRelationDelete(paramJson);
                    } else {
                        var creatorId = xuserId;
                        var flowOperationId = szdwXg.paramJson["flowOperationId"];
                        var flowId = szdwXg.paramJson["flowId"];
                        var Id = jsonList[rowIndex].Id;
                        var paramJson = { flowOperationId: flowOperationId, Id: Id, flowId: flowId, creatorId: creatorId };
                        FlowOperationRuleRelationInsert(paramJson);
                    }
                });
            }
            return c;
        }

        //#region 添加或移除用户
        //添加用户
        function FlowOperationRuleRelationInsert(paramJson) {
            var objDataBind = szdwXg;
            var requestUrl = "FlowOperationRelationSetingProcess.ashx";
            paramJson["MethodName"] = "FlowOperationRuleRelationInsert";
            SzdwAjaxDataOperate.ajaxInsert(objDataBind, requestUrl, paramJson);
        }

        //移除用户
        function FlowOperationRuleRelationDelete(paramJson) {
            var objDataBind = szdwXg;
            var requestUrl = "FlowOperationRelationSetingProcess.ashx";
            paramJson["MethodName"] = "FlowOperationRuleRelationDelete";
            SzdwAjaxDataOperate.ajaxDelete(objDataBind, requestUrl, paramJson);
        }
        //#endregion 添加或移除用户
        //#endregion 自定义控件列
        //#endregion 查询结果
        //#endregion 流程操作与流程触发规则关联

        //#region 流程操作与流程状态关联

        //#region 获取数据
        function GetFlowOperationStatusList() {
            //设置结果面板相关属性
            var rpfph = $("#StatusFilterPanel").outerHeight();
            var rc = $("#flowStatusDataPanel");
            var position = "relative";
            var rpfpt = $("#StatusFilterPanel").offset().top;
            var x = 0;
            var y = 0;
            var w = $("#rightPanel").width() - 10;
            var h = rc.outerHeight();

            //创建Gridview并绑定数据
            CreateFlowStatusGridView(rc, position, x, y, w, h);
        }

        //#endregion 获取数据

        //#region 查询结果

        //#region 获取查询参数
        function GetFlowStatusParamJson() {
            var xuserId = xuserId;
            var flowId = $("#ddlFlow").data("value");
            var paramJson = { xuserId: xuserId, flowId: flowId };
            return paramJson;
        }
        //#endregion 获取查询参数

        //#region 创建Gridview并绑定数据
        var szdwFlowStatus = null;
        function CreateFlowStatusGridView(namingContainer, position, x, y, width, height) {
            if (szdwFlowStatus == null || typeof (szdwFlowStatus) == "undefined") {
                //创建SzdwGridViewt实例
                szdwFlowStatus = new SzdwGridView(position, x, y, width, height);
                szdwFlowStatus.namingContainer = namingContainer;
                szdwFlowStatus.fnInitial = InitialSzdwFlowStatus(szdwFlowStatus);
            }

            //异步加载数据
            if (szdwFlowStatus.pagination != null) {
                szdwFlowStatus.pagination.ResetBar();
            }

            var paramJson = GetFlowStatusParamJson();
            paramJson["pageSize"] = szdwFlowStatus.pageSize;
            paramJson["MethodName"] = "FlowStatusGetList";
            szdwFlowStatus.requestUrl = "FlowOperationRelationSetingProcess.ashx";
            szdwFlowStatus.paramJson = paramJson;
        }
        //#endregion 创建Gridview并绑定数据

        //#region 初始化Gridview属性
        function InitialSzdwFlowStatus(szdwFlowStatus) {
            //个性样式设置
            szdwFlowStatus.dataPanelCssJson = { "background-color": "White", "border-bottom": "1px solid Silver" };
            szdwFlowStatus.paginationCssJson = { "background-color": "White", "font-family": "微软雅黑", "font-size": "small", "border": "1px solid Silver", "border-top": "0px" };
            szdwFlowStatus.minHeight = 300;

            //dataPanel设置
            szdwFlowStatus.hasSumRow = false;
            szdwFlowStatus.hasPagination = false;
            szdwFlowStatus.hasButtonPanel = true;


            //head设置
            szdwFlowStatus.headCssName = "gridHead2";
            szdwFlowStatus.headHeight = 30;
            szdwFlowStatus.fieldJsonData = [{ "Field": "RowNumber", "Text": "序号", "Width": 50 },
                                            { "Field": "Name", "Text": "流程状态名称", "Width": 100, "OrderField": "Name" },
                                            { "Field": "AssignRole", "Text": "与流程操作关联", "Width": 250, "FnControlColumn": CreateFlowStatusCellControl, "Style": { "text-align": "center", "color": "red" } }
            ];

            szdwFlowStatus.cellCssJson = {
                "Memo": { "text-align": "left" },
                "AssignGroup": { "text-align": "left" }
            };
        }
        //#endregion 初始化Gridview属性

        //#region 自定义控件列
        //被审批人设置控件
        function CreateFlowStatusCellControl(jsonList, cell) {
            var rowIndex = $(cell).data("rowIndex");
            var isAssigned = jsonList[rowIndex].IsAssigned;
            var Id = jsonList[rowIndex].Id;

            //列中的控件box
            var c = document.createElement("div");
            $(c).css({ "height": 25, "line-height": "25px" });

            //checkbox
            var chk = document.createElement("input");
            $(chk).attr("type", "checkbox").attr("id", "chkRole").attr("disabled", true);
            $(chk).css({ "float": "left", "height": 18, "line-height": "18px" });
            $(chk).prop("checked", isAssigned);

            var s = document.createElement("label");
            $(s).css({ "float": "left", "height": 25, "line-height": "25px" });
            var flowOperation = szdwXg.paramJson["flowOperation"];
            if (isAssigned) {
                $(s).text("与" + flowOperation + " 已关联");
                $(s).css("color", "red");
            }
            $(c).append(chk).append(s);

            //按钮
            if (permission.insertPermission && permission.deletePermission && permission.modifyPermission) {
                var btn = document.createElement("input");
                $(btn).attr("type", "button").addClass("button2");
                $(btn).css({ "float": "right", "width": 45, "height": 25 });
                var text = isAssigned ? "移除" : "添加";
                $(btn).val(text).appendTo(c);

                //绑定事件
                $(btn).click(function () {
                    if (isAssigned) {
                        var flowOperationId = szdwFlowStatus.paramJson["flowOperationId"];
                        var flowId = szdwFlowStatus.paramJson["flowId"];
                        var Id = jsonList[rowIndex].Id;
                        var modifierId = xuserId;
                        var paramJson = { flowOperationId: flowOperationId, Id: Id, flowId: flowId, modifierId: modifierId };
                        FlowOperationStatusRelationDelete(paramJson);
                    } else {
                        var creatorId = xuserId;
                        var flowOperationId = szdwFlowStatus.paramJson["flowOperationId"];
                        var flowId = szdwFlowStatus.paramJson["flowId"];
                        var Id = jsonList[rowIndex].Id;
                        var paramJson = { flowOperationId: flowOperationId, Id: Id, flowId: flowId, creatorId: creatorId };
                        FlowOperationStatusRelationInsert(paramJson);
                    }
                });
            }
            return c;
        }

        //#region 添加或移除用户
        //添加用户
        function FlowOperationStatusRelationInsert(paramJson) {
            var objDataBind = szdwFlowStatus;
            var requestUrl = "FlowOperationRelationSetingProcess.ashx";
            paramJson["MethodName"] = "FlowOperationStatusRelationInsert";
            SzdwAjaxDataOperate.ajaxInsert(objDataBind, requestUrl, paramJson);
        }

        //移除用户
        function FlowOperationStatusRelationDelete(paramJson) {
            var objDataBind = szdwFlowStatus;
            var requestUrl = "FlowOperationRelationSetingProcess.ashx";
            paramJson["MethodName"] = "FlowOperationStatusRelationDelete";
            SzdwAjaxDataOperate.ajaxDelete(objDataBind, requestUrl, paramJson);
        }
        //#endregion 添加或移除用户
        //#endregion 自定义控件列
        //#endregion 查询结果
        //#endregion 流程操作与流程状态关联

        //#region 流程操作与处理类别关联

        //#region 获取数据
        function GetFlowOperationRectificationTypeList() {
            //设置结果面板相关属性
            var rpfph = $("#RectificationTypeFilterPanel").outerHeight();
            var rc = $("#RectificationTypeDataPanel");
            var position = "relative";
            var rpfpt = $("#RectificationTypeFilterPanel").offset().top;
            var x = 0;
            var y = 0;
            var w = $("#rightPanel").width() - 10;
            var h = rc.outerHeight();

            //创建Gridview并绑定数据
            CreateRectificationTypeGridView(rc, position, x, y, w, h);
        }

        //#endregion 获取数据

        //#region 查询结果

        //#region 获取查询参数
        function GetRectificationTypeParamJson() {
            var xuserId = xuserId;
            var flowId = $("#ddlFlow").data("value");
            var paramJson = { xuserId: xuserId, flowId: flowId };
            return paramJson;
        }
        //#endregion 获取查询参数

        //#region 创建Gridview并绑定数据
        var szdwRectificationType = null;
        function CreateRectificationTypeGridView(namingContainer, position, x, y, width, height) {
            if (szdwRectificationType == null || typeof (szdwRectificationType) == "undefined") {
                //创建SzdwGridViewt实例
                szdwRectificationType = new SzdwGridView(position, x, y, width, height);
                szdwRectificationType.namingContainer = namingContainer;
                szdwRectificationType.fnInitial = InitialSzdwRectificationType(szdwRectificationType);
            }

            //异步加载数据
            if (szdwRectificationType.pagination != null) {
                szdwRectificationType.pagination.ResetBar();
            }

            var paramJson = GetRectificationTypeParamJson();
            paramJson["pageSize"] = szdwRectificationType.pageSize;
            paramJson["MethodName"] = "InvestigationHandleResultTypeGetList";
            szdwRectificationType.requestUrl = "FlowOperationRelationSetingProcess.ashx";
            szdwRectificationType.paramJson = paramJson;
        }
        //#endregion 创建Gridview并绑定数据

        //#region 初始化Gridview属性
        function InitialSzdwRectificationType(szdwRectificationType) {
            //个性样式设置
            szdwRectificationType.dataPanelCssJson = { "background-color": "White", "border-bottom": "1px solid Silver" };
            szdwRectificationType.paginationCssJson = { "background-color": "White", "font-family": "微软雅黑", "font-size": "small", "border": "1px solid Silver", "border-top": "0px" };
            szdwRectificationType.minHeight = 300;

            //dataPanel设置
            szdwRectificationType.hasSumRow = false;
            szdwRectificationType.hasPagination = false;
            szdwRectificationType.hasButtonPanel = true;


            //head设置
            szdwRectificationType.headCssName = "gridHead2";
            szdwRectificationType.headHeight = 30;
            szdwRectificationType.fieldJsonData = [{ "Field": "RowNumber", "Text": "序号", "Width": 50 },
                                            { "Field": "Name", "Text": "处理类别名称", "Width": 100, "OrderField": "Name" },
                                            { "Field": "AssignRole", "Text": "与流程操作关联", "Width": 250, "FnControlColumn": CreateRectificationTypeCellControl, "Style": { "text-align": "center", "color": "red" } }
            ];

            szdwRectificationType.cellCssJson = {
                "Memo": { "text-align": "left" },
                "AssignGroup": { "text-align": "left" }
            };
        }
        //#endregion 初始化Gridview属性

        //#region 自定义控件列
        //被审批人设置控件
        function CreateRectificationTypeCellControl(jsonList, cell) {
            var rowIndex = $(cell).data("rowIndex");
            var isAssigned = jsonList[rowIndex].IsAssigned;
            var Id = jsonList[rowIndex].Id;

            //列中的控件box
            var c = document.createElement("div");
            $(c).css({ "height": 25, "line-height": "25px" });

            //checkbox
            var chk = document.createElement("input");
            $(chk).attr("type", "checkbox").attr("id", "chkRole").attr("disabled", true);
            $(chk).css({ "float": "left", "height": 18, "line-height": "18px" });
            $(chk).prop("checked", isAssigned);

            var s = document.createElement("label");
            $(s).css({ "float": "left", "height": 25, "line-height": "25px" });
            var flowOperation = szdwXg.paramJson["flowOperation"];
            if (isAssigned) {
                $(s).text("与" + flowOperation + " 已关联");
                $(s).css("color", "red");
            }
            $(c).append(chk).append(s);

            //按钮
            if (permission.insertPermission && permission.deletePermission && permission.modifyPermission) {
                var btn = document.createElement("input");
                $(btn).attr("type", "button").addClass("button2");
                $(btn).css({ "float": "right", "width": 45, "height": 25 });
                var text = isAssigned ? "移除" : "添加";
                $(btn).val(text).appendTo(c);

                //绑定事件
                $(btn).click(function () {
                    if (isAssigned) {
                        var flowOperationId = szdwRectificationType.paramJson["flowOperationId"];
                        var flowId = szdwRectificationType.paramJson["flowId"];
                        var Id = jsonList[rowIndex].Id;
                        var modifierId = xuserId;
                        var paramJson = { flowOperationId: flowOperationId, Id: Id, flowId: flowId, modifierId: modifierId };
                        FlowOperationRectificationTypeRelationDelete(paramJson);
                    } else {
                        var creatorId = xuserId;
                        var flowOperationId = szdwRectificationType.paramJson["flowOperationId"];
                        var flowId = szdwRectificationType.paramJson["flowId"];
                        var Id = jsonList[rowIndex].Id;
                        var paramJson = { flowOperationId: flowOperationId, Id: Id, flowId: flowId, creatorId: creatorId };
                        FlowOperationRectificationTypeRelationInsert(paramJson);
                    }
                });
            }
            return c;
        }

        //#region 添加或移除流程操作与处理类别关联
        //添加流程操作与处理类别关联
        function FlowOperationRectificationTypeRelationInsert(paramJson) {
            var objDataBind = szdwRectificationType;
            var requestUrl = "FlowOperationRelationSetingProcess.ashx";
            paramJson["MethodName"] = "FlowOperationRectificationTypeRelationInsert";
            SzdwAjaxDataOperate.ajaxInsert(objDataBind, requestUrl, paramJson);
        }

        //移除流程操作与处理类别关联
        function FlowOperationRectificationTypeRelationDelete(paramJson) {
            var objDataBind = szdwRectificationType;
            var requestUrl = "FlowOperationRelationSetingProcess.ashx";
            paramJson["MethodName"] = "FlowOperationRectificationTypeRelationDelete";
            SzdwAjaxDataOperate.ajaxDelete(objDataBind, requestUrl, paramJson);
        }
        //#endregion 添加或移除流程操作与处理类别关联
        //#endregion 自定义控件列
        //#endregion 查询结果
        //#endregion 流程操作与处理类别关联

        //#region 流程操作与处理解雇关联

        //#region 获取数据
        function GetFlowOperationHandleResultList() {
            //设置结果面板相关属性
            var rpfph = $("#HandleResultFilterPanel").outerHeight();
            var rc = $("#HandleResultDataPanel");
            var position = "relative";
            var rpfpt = $("#HandleResultFilterPanel").offset().top;
            var x = 0;
            var y = 0;
            var w = $("#rightPanel").width() - 10;
            var h = rc.outerHeight();

            //创建Gridview并绑定数据
            CreateHandleResultGridView(rc, position, x, y, w, h);
        }

        //#endregion 获取数据

        //#region 查询结果

        //#region 获取查询参数
        function GetHandleResultParamJson() {
            var xuserId = xuserId;
            var flowId = $("#ddlFlow").data("value");
            var paramJson = { xuserId: xuserId, flowId: flowId };
            return paramJson;
        }
        //#endregion 获取查询参数

        //#region 创建Gridview并绑定数据
        var szdwHandleResult = null;
        function CreateHandleResultGridView(namingContainer, position, x, y, width, height) {
            if (szdwHandleResult == null || typeof (szdwHandleResult) == "undefined") {
                //创建SzdwGridViewt实例
                szdwHandleResult = new SzdwGridView(position, x, y, width, height);
                szdwHandleResult.namingContainer = namingContainer;
                szdwHandleResult.fnInitial = InitialSzdwHandleResult(szdwHandleResult);
            }

            //异步加载数据
            if (szdwHandleResult.pagination != null) {
                szdwHandleResult.pagination.ResetBar();
            }

            var paramJson = GetHandleResultParamJson();
            paramJson["pageSize"] = szdwHandleResult.pageSize;
            paramJson["MethodName"] = "FlowHandleResultGetList";
            szdwHandleResult.requestUrl = "FlowOperationRelationSetingProcess.ashx";
            szdwHandleResult.paramJson = paramJson;
        }
        //#endregion 创建Gridview并绑定数据

        //#region 初始化Gridview属性
        function InitialSzdwHandleResult(szdwHandleResult) {
            //个性样式设置
            szdwHandleResult.dataPanelCssJson = { "background-color": "White", "border-bottom": "1px solid Silver" };
            szdwHandleResult.paginationCssJson = { "background-color": "White", "font-family": "微软雅黑", "font-size": "small", "border": "1px solid Silver", "border-top": "0px" };
            szdwHandleResult.minHeight = 300;

            //dataPanel设置
            szdwHandleResult.hasSumRow = false;
            szdwHandleResult.hasPagination = false;
            szdwHandleResult.hasButtonPanel = true;


            //head设置
            szdwHandleResult.headCssName = "gridHead2";
            szdwHandleResult.headHeight = 30;
            szdwHandleResult.fieldJsonData = [{ "Field": "RowNumber", "Text": "序号", "Width": 50 },
                                            { "Field": "Name", "Text": "处理结果名称", "Width": 100, "OrderField": "Name" },
                                            { "Field": "AssignRole", "Text": "与流程操作关联", "Width": 250, "FnControlColumn": CreateHandleResultCellControl, "Style": { "text-align": "center", "color": "red" } },
            ];

            szdwHandleResult.cellCssJson = {
                "Memo": { "text-align": "left" },
                "AssignGroup": { "text-align": "left" }
            };
        }
        //#endregion 初始化Gridview属性

        //#region 自定义控件列
        //被审批人设置控件
        function CreateHandleResultCellControl(jsonList, cell) {
            var rowIndex = $(cell).data("rowIndex");
            var isAssigned = jsonList[rowIndex].IsAssigned;
            var Id = jsonList[rowIndex].Id;

            //列中的控件box
            var c = document.createElement("div");
            $(c).css({ "height": 25, "line-height": "25px" });

            //checkbox
            var chk = document.createElement("input");
            $(chk).attr("type", "checkbox").attr("id", "chkRole").attr("disabled", true);
            $(chk).css({ "float": "left", "height": 18, "line-height": "18px" });
            $(chk).prop("checked", isAssigned);

            var s = document.createElement("label");
            $(s).css({ "float": "left", "height": 25, "line-height": "25px" });
            var flowOperation = szdwXg.paramJson["flowOperation"];
            if (isAssigned) {
                $(s).text("与" + flowOperation + " 已关联");
                $(s).css("color", "red");
            }
            $(c).append(chk).append(s);

            //按钮
            if (permission.insertPermission && permission.deletePermission && permission.modifyPermission) {
                var btn = document.createElement("input");
                $(btn).attr("type", "button").addClass("button2");
                $(btn).css({ "float": "right", "width": 45, "height": 25 });
                var text = isAssigned ? "移除" : "添加";
                $(btn).val(text).appendTo(c);

                //绑定事件
                $(btn).click(function () {
                    if (isAssigned) {
                        var flowOperationId = szdwHandleResult.paramJson["flowOperationId"];
                        var flowId = szdwHandleResult.paramJson["flowId"];
                        var Id = jsonList[rowIndex].Id;
                        var modifierId = xuserId;
                        var paramJson = { flowOperationId: flowOperationId, Id: Id, flowId: flowId, modifierId: modifierId };
                        FlowOperationHandleResultRelationDelete(paramJson);
                    } else {
                        var creatorId = xuserId;
                        var flowOperationId = szdwHandleResult.paramJson["flowOperationId"];
                        var flowId = szdwHandleResult.paramJson["flowId"];
                        var Id = jsonList[rowIndex].Id;
                        var paramJson = { flowOperationId: flowOperationId, Id: Id, flowId: flowId, creatorId: creatorId };
                        FlowOperationHandleResultRelationInsert(paramJson);
                    }
                });
            }
            return c;
        }

        //#region 添加或移除流程操作与处理类别关联
        //添加流程操作与处理类别关联
        function FlowOperationHandleResultRelationInsert(paramJson) {
            var objDataBind = szdwHandleResult;
            var requestUrl = "FlowOperationRelationSetingProcess.ashx";
            paramJson["MethodName"] = "FlowOperationHandleResultRelationInsert";
            SzdwAjaxDataOperate.ajaxInsert(objDataBind, requestUrl, paramJson);
        }

        //移除流程操作与处理类别关联
        function FlowOperationHandleResultRelationDelete(paramJson) {
            var objDataBind = szdwHandleResult;
            var requestUrl = "FlowOperationRelationSetingProcess.ashx";
            paramJson["MethodName"] = "FlowOperationHandleResultRelationDelete";
            SzdwAjaxDataOperate.ajaxDelete(objDataBind, requestUrl, paramJson);
        }
        //#endregion 添加或移除流程操作与处理类别关联
        //#endregion 自定义控件列
        //#endregion 查询结果
        //#endregion 流程操作与处理类别关联

        //#endregion 右面板

    </script>
</body>
</html>
