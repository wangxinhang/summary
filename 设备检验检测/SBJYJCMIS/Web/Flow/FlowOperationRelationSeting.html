<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title></title>
    <link href="../Styles/Page.css" rel="stylesheet" type="text/css" />
    <link href="../Styles/Query.css" rel="stylesheet" type="text/css" />    
    <script src="../Scripts/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwDropDownList.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwGridView.js" type="text/javascript"></script>
    <link href="../SzdwControls/SzdwGridView.css" rel="stylesheet" type="text/css" />
    <script src="../SzdwControls/SzdwPagination.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwButton.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwPopupWindow.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCheckBoxList.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwAjaxDataOperate.js" type="text/javascript"></script>
        
    <style type="text/css">
        input::-ms-clear{display:none;} 
    </style>
</head>
<body style="background-color:White">
    <form action="">
        <div id="leftPanel">
            <div id="roleFilterPanel" style="height:25px;padding-bottom:10px; margin-top:20px;">
                <div id="rfpCell00" class="cellDiv" style="color:#1B60C3;font-size:12pt; font-family:微软雅黑;">流程操作列表</div>
                <div id="rfpCell01" class="cellDiv" style="border-left:1px solid #DDDDDD;margin-left:10px;border: 1px solid Silver; border-right:0px;">                    
                    <input id="txtFlowOperationName" type="text" class="textBox2" style="background-color:transparent;border-right:0px;width:120px;border: none;" />
                </div>
                <div id="rfpCell02" class="cellDiv" style="padding-left:0px;"></div>
                <div id="rfCell03"  style="padding-left:0px; margin-left:20px; "></div>
            </div>
            <div id="roleDataPanel" class="dataPanel"></div>
        </div>
        <div id="rightPanel" >        
            <div id="rpFilterPanel" style="height:25px;padding-bottom:10px;margin-top:20px;">
                <div id="rpfpCell00" class="cellDiv" style="color:#1B60C3;font-size:12pt; font-family:微软雅黑;">关联设置</div>
                <div id="rpfpCell01" class="cellDiv" style="border-left:1px solid #DDDDDD;margin-left:10px;">
                    <div id="ddlPermissionType" class="dropDownList" style="width:100px;"></div>
                </div>
                <div id="rpfpCell05" class="cellDiv" style="padding-left:5px">
                    <input id="txtItemName" type="text" class="textBox2" style="background-color:transparent;border-right:0px;width:120px; " />
                </div>
                
                 <div id="rpfpCell04" style="padding-left:0px; margin-left:20px; "></div>
            </div>
            <div id="rpDataPanel" class="dataPanel"></div>
        </div>
    </form>  
    
    <script type="text/javascript">
        //#region 全局变量
        var xuserId, xmenuId, permission = null, defaultValue; //用户及权限：json格式 
        var bodyWidth = $(document.body).width();
        var bodyHeight = $(document.body).height(); 
        var ml = 20; mt = 20; //ml:margin-left;mt:margin-top;
        var btnWidth = 90; btnHeight = 26; btnImageWidth = 25; //btnWidth:按钮宽;btnHeight:按钮高;btnImageWidth:按钮图片宽
        var panelWidth = 1030; bodyWidth - ml * 2;//面板宽度       
        var panelMinWidth = 1030; //面板最小宽度        
        //#endregion 全局变量

        //#region 网页加载 

        //#region 初始加载
        $(document).ready(function () {
            //获取用户Id和MenuId
            xuserId = GetXuserId();
            xmenuId = GetXmenuId();
            permission = GetPermission();

            //设置查询面板
            SetLeftPanel();

            //设置结果面板
            SetRightPanel();

            //窗口调整大小
            $(window).resize(function () {
                var body = document.body;
                bodyWidth = $(body).width();
                bodyHeight = $(body).height();
                panelWidth = bodyWidth;
                RepositionControls();
                ResizeControls();
            });
        });
        //#endregion 初始加载

        //#region 重设元素位置尺寸

        //#region 重设位置尺寸
        //重设网页元素位置
        function RepositionControls() {
            var lw = GetLeftPanelWidth();
            var lx = GetLeftPanelX();
            var ly = GetLeftPanelY();  

            //重设弹窗位置
            var t = document.body;
            var pw = t.popupWindow;
            if (pw) {
                var bw = $(t).width();
                var w = pw.width;
                var x = bw - w - ml - 1;
                var y = pw.y;
                pw.RePosition(x, y);
            }
        }

        //重设网页元素尺寸
        function ResizeControls() {
            var lp=$("#leftPanel");
            var rp=$("#rightPanel");
            var dh = bodyHeight;
            var pw = Math.max(panelWidth, panelMinWidth);

            var lx = GetLeftPanelX();
            var ly = GetLeftPanelY();
            var lw = GetLeftPanelWidth();
            var lh = dh - ly-2;

            if (szdwFlowOperation) {
                $(lp).outerHeight(lh);
                var srh = lh - $("#roleFilterPanel").outerHeight();
                szdwFlowOperation.Resize(lw, srh);
            }

            if (szdwGvRp) {
                var rx = lx + lw + ml + ml;
                var rw = pw - rx - ml;
                var rh = lh-2;
                $(rp).outerWidth(rw).outerHeight(rh);

                var srph = rh - $("#rpFilterPanel").outerHeight();
                szdwGvRp.Resize(rw, srph);
            }

            //重设弹窗尺寸
            var t = document.body;
            var pw = t.popupWindow;
            if (pw) {
                var w = pw.width;
                var h = $(szdwGvRp.body).height();
                pw.ReSize(w, h);
            }
        }
        //#endregion 重设位置尺寸

        //#region 获取查询面板位置尺寸
        //获取查询面板高度
        function GetLeftPanelWidth() {
            var p = $("#leftPanel");
            return $(p).css("display") == "none" ? 0 : $(p).outerWidth(true);
        }

        function GetLeftPanelHeight() {
            var p = $("#leftPanel");
            return $(p).css("display") == "none" ? 0 : $(p).outerHeight(true);
        }

        //获取查询面板纵坐标
        function GetLeftPanelY() {
            var p = $("#leftPanel");
            return $(p).css("display") == "none" ? 0 : $(p).offset().top;
        }

        //获取查询面板横坐标
        function GetLeftPanelX() {
            var p = $("#leftPanel");
            return $(p).offset().left;
        }
        //#endregion 获取查询面板位置尺寸              

        //#endregion 重设元素尺寸
        
        //#endregion 网页加载

        //#region 用户权限
        //获取用户Id
        function GetXuserId() {
            return $.parseJSON(SzdwCommon.getUrlParam("paramJson")).xuserId;

        }

        //获取菜单ID:xMenuId
        function GetXmenuId() {
            return $.parseJSON(SzdwCommon.getUrlParam("paramJson")).xmenuId;
        }
        //获取权限
        function GetPermission() {
            var jsonList = $.parseJSON(SzdwCommon.getUrlParam("paramJson")).permissionJsonList;
            return SzdwCommon.getPermission(jsonList);
        }
        //获取导出打印权限
        function GetExportPrintPermission() {
            var xUserId = xuserId;
            var xMenuId = xmenuId;
            var url = "../Permission/XuserPermissionProcess.ashx";
            var paramJson = { xUserId: xUserId, xMenuId: xMenuId, MethodName: "GetXUserPermission" };
            $.ajax({ url: url, type: "post", data: paramJson, dataType: "json", async: false,
                success: function (jsData) {
                    if (!$.isEmptyObject(jsData)) {
                        permission = jsData;
                        ShowExportButton();
                      
                    }
                }
            });
        }
        //#endregion 用户权限
        
        //#region 左面板
        //#region 设置左面板
        function SetLeftPanel() {
            var lp = $("#leftPanel");           
            var x = ml;
            var y = mt;
            var w = 417;
            var h = bodyHeight - y - mt;
            $(lp).css({ "position": "absolute", "left": 5, "top": 0 }).outerWidth(w).outerHeight(h);

            //流程操作筛选按钮
            CreateFlowOperationSearchButton();
            CreateInsertButton();

            //起始设置
             defaultValue = "操作名称查询";
            $("#txtFlowOperationName").val(defaultValue);
            $("#txtFlowOperationName").css("color", "silver");

            //操作名称获取焦点
            $("#txtFlowOperationName").focus(function (e) {
                if (this.value == defaultValue) {
                    this.value = "";
                    this.style.color = "";
                }
            });


            //操作名称回车筛选
            $("#txtFlowOperationName").keypress(function (e) {
                var k = e.which;
                if (k == 13) {
                    $(szdwFlowOperationSearchButton.button).trigger("click");
                }
            });
                        
            //初始加载结果数据
            GetFlowOperationList();
        }
        //#endregion 设置右面板

        //#region 流程操作名称筛选
        var szdwFlowOperationSearchButton = null;
        function CreateFlowOperationSearchButton() {
            var nc = $("#rfpCell02");
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = btnHeight;
            szdwFlowOperationSearchButton = new SzdwButton(p, x, y, w, h);
            szdwFlowOperationSearchButton.namingContainer = nc;
            szdwFlowOperationSearchButton.imageWidth = btnImageWidth;
            szdwFlowOperationSearchButton.image = "../Image/query20b.png";
            szdwFlowOperationSearchButton.title = "流程操作名称筛选";
            szdwFlowOperationSearchButton.Load();

            //单击事件
            var btn = szdwFlowOperationSearchButton.button;
            $(btn).click(function (e) {
                if ($("#txtFlowOperationName").val() == defaultValue) {
                    szdwFlowOperation.paramJson["name"] = "";
                }
                else {
                    szdwFlowOperation.paramJson["name"] = $("#txtFlowOperationName").val();
                }
                szdwFlowOperation.DataBind();
                e.stopPropagation();
            });
        }
        //#endregion 流程操作名称筛选 

        //#region 新增按钮
        var szdwInsertButton = null;
        function CreateInsertButton() {
            var nc = $("#rfCell03");
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0; // btnWidth;
            var h = btnHeight;
            szdwInsertButton = new SzdwButton(p, x, y, w, h);
            szdwInsertButton.namingContainer = nc;
            szdwInsertButton.image = "../Image/new21b3.png";
            szdwInsertButton.text = "新增";
            szdwInsertButton.btnCssJson["border"] = "1px";
            szdwInsertButton.btnCssJson["background-color"] = "#DDDDDD";
            szdwInsertButton.btnHoverCssJson = { "color": "#017BBA" };
            szdwInsertButton.btnHoverCssJson["background-color"] = "silver";
            szdwInsertButton.imageWidth = btnImageWidth;
            szdwInsertButton.Load();

            //单击事件
            var btn = szdwInsertButton.button;
            $(btn).click(function () {
                FlowOperationInsert();
            });
        }
        //#endregion 新增按钮

        //#region 获取数据
        function GetFlowOperationList() {
            //设置结果面板相关属性
            var lph = GetLeftPanelHeight();
            var rfph = $("#roleFilterPanel").outerHeight();
            var c = $("#roleDataPanel");
            var position = "relative";
            var x = 0;
            var y = 0;
            var w = GetLeftPanelWidth();
            var h = lph - rfph;

            //创建Gridview并绑定数据
            CreateFlowOperationGridView(c, position, x, y, w, h);
        }
        //#endregion 获取数据

        //#region 查询结果

        //#region 获取查询参数
        function GetFlowOperationParamJson() {
            var xuserId = xuserId;
            var flowOperationName = $.trim($("#txtFlowOperationName").val());
            var paramJson = { xuserId: xuserId };

            if ($("#txtFlowOperationName").val() != defaultValue && flowOperationName.length > 0) {
                paramJson["name"] = flowOperationName;
            }

            return paramJson;
        }
        //#endregion 获取查询参数

        //#region 创建Gridview并绑定数据
        var szdwFlowOperation = null;
        function CreateFlowOperationGridView(namingContainer, position, x, y, width, height) {
            if (szdwFlowOperation == null || typeof (szdwFlowOperation) == "undefined") {
                //创建SzdwGridViewt实例
                szdwFlowOperation = new SzdwGridView(position, x, y, width, height);
                szdwFlowOperation.namingContainer = namingContainer;
                szdwFlowOperation.fnInitial = InitialSzdwFlowOperation(szdwFlowOperation);
                szdwFlowOperation.fnRowClick = szdwFlowOperationRowClick;
                szdwFlowOperation.fnDataBindCallBack = InitialRowClick;
                szdwFlowOperation.fnDeleting = FlowOperationDelete;
                szdwFlowOperation.fnEditing = FlowOperationUpdate;
            }

            //异步加载数据
            if (szdwFlowOperation.pagination != null) {
                szdwFlowOperation.pagination.ResetBar();
            }

            var paramJson = GetFlowOperationParamJson();
            paramJson["pageSize"] = szdwFlowOperation.pageSize;
            paramJson["MethodName"] = "FlowOperationGetList";
            szdwFlowOperation.requestUrl = "FlowOperationRelationSetingProcess.ashx";
            szdwFlowOperation.paramJson = paramJson;
            szdwFlowOperation.DataBind();
        }


        //初次加载时默认选中第一行，并加载该Group对应的用户数据
        function InitialRowClick() {
            $(szdwFlowOperation.bodyRows[0]).trigger("click");
        }
        //#endregion 创建Gridview并绑定数据

        //#region 初始化Gridview属性
        function InitialSzdwFlowOperation(szdwFlowOperation) {
            //个性样式设置    
            szdwFlowOperation.dataPanelCssJson = { "background-color": "White", "border": "0px solid Silver" };
            szdwFlowOperation.paginationCssJson = { "background-color": "White", "font-family": "微软雅黑", "font-size": "small", "border-top": "1px solid #CCCCCC" };
            szdwFlowOperation.minHeight = 300;
            szdwFlowOperation.allowRowClickEvent = true;

            //dataPanel设置
            szdwFlowOperation.hasSumRow = false;
            szdwFlowOperation.hasPagination = false;
            szdwFlowOperation.hasButtonPanel = true;
            szdwFlowOperation.pageSize = 1000;
            szdwFlowOperation.permission.modifyPermission = true;
            szdwFlowOperation.permission.deletePermission = true;

            //head设置
            szdwFlowOperation.headCssName = "gridHead2";
            szdwFlowOperation.headHeight = 30;
            szdwFlowOperation.fieldJsonData = [{ "Field": "RowNumber", "Text": "序号", "Width": 40 },
                                       { "Field": "Name", "Text": "流程操作名称", "Width": 120,"OrderField": "Name" },
                                       { "Field": "Memo", "Text": "描述", "Width": 120 }];

            szdwFlowOperation.cellCssJson = {
                "Name": { "text-align": "left" },
                "Memo": { "text-align": "left" }
            };
        }
        //#endregion 初始化Gridview属性

        //#region 行单击事件
        function szdwFlowOperationRowClick(rowIndex) {
            var jsonList = szdwFlowOperation.recordSetJson;
            if (jsonList) {
                var jsonData = jsonList[rowIndex];
                if (szdwGvRp) {
                    szdwGvRp.paramJson["flowOperationId"] = jsonData.Id;
                    szdwGvRp.paramJson["flowOperation"] = jsonData.Name;
                    szdwGvRp.DataBind();
                }   
            }
        }
        //#endregion 行单击事件

        //#endregion 查询结果
        //#endregion 右面板

        //#region 右面板
        //#region 设置右面板
        function SetRightPanel() {
            var lp = $("#leftPanel");
            var lw = GetLeftPanelWidth();
            var lh = GetLeftPanelHeight();
            var lx = GetLeftPanelX();
            var ly = GetLeftPanelY();
            var x = lx + lw + ml;
            var y = ly;
            var bw = Math.max(bodyWidth, panelMinWidth);
            var w = bw - x-ml+100;
            var h = lh;

            var rp = $("#rightPanel");
            $(rp).css({ "position": "absolute", "left": x, "top": y }).outerWidth(w).outerHeight(h);

            //默认首次加载  流程规则
            //各项筛选控件加载
            CreateItemFilter();            

            //初始加载结果数据
            GetItemDataList();
        }
        //#endregion 设置右面板

        //#region 角色权限筛选
        //#region 角色权限筛选控件加载
        function CreateItemFilter() {
            BindDdlPermissionType();
            //BindDdlAssingType();
            CreateSearchButton();
            CreateItemInsertButton();

            //名称回车筛选
            $("#txtItemName").keypress(function (e) {
                var k = e.which;
                if (k == 13) {
                    $(szdwSearchButton.button).trigger("click");
                }
            });
        }
        //#endregion 角色权限筛选控件加载

        //#region 下拉框执行事件:刷新数据
        function RefreshSzdwGvRp() {
            $(szdwSearchButton.button).trigger("click");
        }
        //#endregion 下拉框执行事件

        //#region 权限类别下拉框
        function BindDdlPermissionType() {
            var jsonList = [{ Id: 1, Name: "触发规则" }, { Id: 2, Name: "流程状态" }, { Id: 3, Name: "处理类别" }, { Id: 4, Name: "处理结果"}];
            var paramDdl = { jsonList: jsonList, fnInitial: InitialDdlPt };
            $("#ddlPermissionType").dropDownList(paramDdl);
            $("#ddlPermissionType").text("触发规则").data("value", 1);
        }

        function InitialDdlPt(szdwDdl) {
            var pt = szdwDdl.value;
            if (pt == 1) {
                szdwGvRp.paramJson["MethodName"] = "FlowRuleGetList";
            }
            if (pt == 2) {
                szdwGvRp.paramJson["MethodName"] = "FlowStatusGetList";
            }
            if (pt == 3) {
                szdwGvRp.paramJson["MethodName"] = "InvestigationHandleResultTypeGetList";
            }
            if (pt == 4) {
                szdwGvRp.paramJson["MethodName"] = "FlowHandleResultGetList";
            }
            szdwDdl.fnItemClick = ReLoadGridview;
        }

         //重新加载不同权限设置的数据列表
        function ReLoadGridview() {
            //判断是否显示新增按钮
             SetDdlCtrl();
            //加载权限设置的数据列表
            var rc = $("#rpDataPanel");
            $(rc).empty();
            szdwGvRp = null;
            GetItemDataList();

            var rowIndex = szdwFlowOperation.selectedRow.rowIndex;
            var jsonData = szdwFlowOperation.recordSetJson[rowIndex];
            szdwGvRp.paramJson["flowOperationId"] = jsonData.Id;
            szdwGvRp.paramJson["flowOperation"] = jsonData.Name;
            szdwGvRp.DataBind();
        }

        //设置下拉框控件
        function SetDdlCtrl() {
            var pt = $("#ddlPermissionType").data("value");
            if (pt == 1) {
                szdwItemInsertButton.text = "新增流程规则";
                
                if (szdwItemInsertButton.btnCssJson["display"] == "none") {
                    szdwItemInsertButton.btnCssJson["display"] = "block";
                    szdwItemInsertButton.Show();
                }
            }
            if (pt == 2) {
                szdwItemInsertButton.text = "新增流程状态";
                if (szdwItemInsertButton.btnCssJson["display"] == "none") {
                    szdwItemInsertButton.btnCssJson["display"] = "block";
                    szdwItemInsertButton.Show();
                }
            }
            if (pt == 4) {
                szdwItemInsertButton.text = "新增流程处理结果";
                if (szdwItemInsertButton.btnCssJson["display"] == "none") {
                    szdwItemInsertButton.btnCssJson["display"] = "block";
                    szdwItemInsertButton.Show();
                }
            }
            if (pt == 3) {
                szdwItemInsertButton.btnCssJson["display"] = "none";
                szdwItemInsertButton.Hide();
            }
        }
        //#endregion 权限类别下拉框

        //#region 权限指派类别下拉框
        function BindDdlAssingType() {
            var jsonList = [{ Id: 1, Name: "已指派" }, { Id: 2, Name: "未指派"}];
            var paramDdl = { jsonList: jsonList, fnInitial: InitialDdl };
            $("#ddlAssignType").dropDownList(paramDdl);
            $("#ddlAssignType").text("全部").data("value", 0);
        }
        //#endregion 权限指派类别下拉框

        //#region 通用下拉框初始化设置
        function InitialDdl(szdwDdl) {
            szdwDdl.jsonItemAll = { Id: 0, Name: "全部" };
            szdwDdl.fnItemClick = RefreshSzdwGvRp;
        }
        //#endregion 通用下拉框初始化设置

        //#region 资源筛选按钮
        var szdwSearchButton = null;
        function CreateSearchButton() {
            var nc = $("#txtItemName").parent();
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = btnHeight;
            szdwSearchButton = new SzdwButton(p, x, y, w, h);
            szdwSearchButton.namingContainer = nc;
            szdwSearchButton.imageWidth = btnImageWidth;
            szdwSearchButton.image = "../Image/query20b.png";
            szdwSearchButton.title = "名称筛选";
            szdwSearchButton.Load();

            //单击事件
            var btn = szdwSearchButton.button;
            $(btn).click(function (e) {
                szdwGvRp.paramJson["assignType"] = $("#ddlAssignType").data("value");
                szdwGvRp.paramJson["resourceTypeId"] = $("#ddlResourceType").data("value");
                szdwGvRp.paramJson["permissionTypeId"] = $("#ddlPermissionType").data("value");
                szdwGvRp.paramJson["itemName"] = $("#txtItemName").val();
                
                szdwGvRp.DataBind();
                e.stopPropagation();
            });
        }
        //#endregion 资源筛选按钮 

        //#region 新增按钮
        var szdwItemInsertButton = null;
        function CreateItemInsertButton() {
            var nc = $("#rpfpCell04");
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0; // btnWidth;
            var h = btnHeight;
            szdwItemInsertButton = new SzdwButton(p, x, y, w, h);
            szdwItemInsertButton.namingContainer = nc;
            szdwItemInsertButton.image = "../Image/new21b3.png";
            szdwItemInsertButton.btnCssJson["border"] = "1px";
            szdwItemInsertButton.btnCssJson["display"] = "block";
            szdwItemInsertButton.text = "新增流程数据";
            szdwItemInsertButton.btnCssJson["background-color"] = "#DDDDDD";
            szdwItemInsertButton.btnHoverCssJson["background-color"] = "silver";
            szdwItemInsertButton.imageWidth = btnImageWidth;
            szdwItemInsertButton.Load();

            //单击事件
            var btn = szdwItemInsertButton.button;
            $(btn).click(function () {
                ItemSetingInsert();
            });
        }
        //#endregion 新增按钮

        //#endregion 角色权限筛选

        //#region 获取数据
        function GetItemDataList() {
            //设置结果面板相关属性
            var rph = $("#rightPanel").height();
            var rpfph = $("#rpFilterPanel").outerHeight();
            var rc = $("#rpDataPanel");
            var position = "relative";
            var x = 0;
            var y = 0; 
            var w = $("#rightPanel").width();
            var h = rph - rpfph;

            //创建Gridview并绑定数据
            CreateRpGridView(rc, position, x, y, w, h);
        }

        //#endregion 获取数据

        //#region 查询结果
             
        //#region 获取查询参数
        function GetItemDataParamJson() {
            var xuserId = xuserId;
            var paramJson = { xuserId: xuserId };
            var assignType = $("#ddlAssignType").data("value");
            var resourceTypeId = $("#ddlResourceType").data("value");
            var itemName = $("#txtItemName").val();

            return paramJson;
        }
        //#endregion 获取查询参数

        //#region 创建Gridview并绑定数据
        var szdwGvRp = null;
        function CreateRpGridView(namingContainer, position, x, y, width, height) {
            if (szdwGvRp == null || typeof (szdwGvRp) == "undefined") {
                //创建SzdwGridViewt实例
                szdwGvRp = new SzdwGridView(position, x, y, width, height);
                szdwGvRp.namingContainer = namingContainer;
                szdwGvRp.fnInitial = InitialSzdwGvRp(szdwGvRp);
                var pt = $("#ddlPermissionType").data("value");
                if (pt == 1) {
                    szdwGvRp.fnDeleting = FlowRuleDelete;
                    szdwGvRp.fnEditing = FlowRuleUpdate;
                }
                if (pt == 2) {
                    szdwGvRp.fnDeleting = FlowStatusDelete;
                    szdwGvRp.fnEditing = FlowStatusUpdate;
                }
                if (pt == 4) {
                    szdwGvRp.fnDeleting = FlowHandleResultDelete;
                    szdwGvRp.fnEditing = FlowHandleResultUpdate;
                }
            }

            //异步加载数据
            if (szdwGvRp.pagination != null) {
                szdwGvRp.pagination.ResetBar();
            }

            var pt = $("#ddlPermissionType").data("value");
            var paramJson = GetItemDataParamJson();
            paramJson["pageSize"] = szdwGvRp.pageSize;
            if (pt == 1) {
                paramJson["MethodName"] = "FlowRuleGetList";
            }
            if (pt == 2) {
                paramJson["MethodName"] = "FlowStatusGetList";
            }
            if (pt == 3) {
                paramJson["MethodName"] = "InvestigationHandleResultTypeGetList";
            }
            if (pt == 4) {
                paramJson["MethodName"] = "FlowHandleResultGetList";
            }
            szdwGvRp.requestUrl = "FlowOperationRelationSetingProcess.ashx";
            szdwGvRp.paramJson = paramJson;
            //szdwGvRp.DataBind();
        }
        //#endregion 创建Gridview并绑定数据

        //#region 初始化Gridview属性
        function InitialSzdwGvRp(szdwGvRp) {            
            //个性样式设置    
            szdwGvRp.dataPanelCssJson = { "background-color": "White", "border": "0px solid Silver"};
            szdwGvRp.paginationCssJson = { "background-color": "White", "font-family": "微软雅黑", "font-size": "small", "border-top": "1px solid #CCCCCC"};
            szdwGvRp.minHeight = 300;

            //dataPanel设置
            szdwGvRp.hasSumRow = false;
            szdwGvRp.hasButtonPanel = true;

            //head设置
            szdwGvRp.headCssName = "gridHead2";
            szdwGvRp.headHeight = 30;
            var pt = $("#ddlPermissionType").data("value");
            if (pt == 3) {
                szdwGvRp.permission.modifyPermission = false;
                szdwGvRp.permission.deletePermission = false;
            }
            else {
                szdwGvRp.permission.modifyPermission = true;
                szdwGvRp.permission.deletePermission = true;
            }
            szdwGvRp.fieldJsonData = [{ "Field": "RowNumber", "Text": "序号", "Width": 50 },
                                            { "Field": "Name", "Text": "名称", "Width": 120, "OrderField": "Name" },
                                            { "Field": "AssignRole", "Text": "与流程操作关联", "Width": 250, "FnControlColumn": CreateCellControl, "Style": { "text-align": "center", "color": "red"} },
                                            { "Field": "Memo", "Text": "备注", "Width": 100, "OrderField": "Memo" }
                                           ];

            szdwGvRp.cellCssJson = {
                "Name": { "text-align": "left" },
                "AssignRole": { "text-align": "left" }
            };
        }
        //#endregion 初始化Gridview属性

        //#region 自定义控件列
        //被审批人设置控件
        function CreateCellControl(jsonList, cell) {
            var rowIndex = $(cell).data("rowIndex");
            var isAssigned = jsonList[rowIndex].IsAssigned;
            var Id = jsonList[rowIndex].Id;

            //列中的控件box
            var c = document.createElement("div");
            $(c).css({ "height": 25, "line-height": "25px" });

            //checkbox
            var chk = document.createElement("input");
            $(chk).attr("type", "checkbox").attr("id", "chkRole").attr("disabled", true);
            $(chk).css({ "float": "left", "height": 18, "line-height": "18px" });
            $(chk).prop("checked", isAssigned);

            var s = document.createElement("label");
            $(s).css({ "float": "left", "height": 25, "line-height": "25px" });
            var flowOperation = szdwGvRp.paramJson["flowOperation"];
            if (isAssigned) {
                $(s).text("与" + flowOperation+" 已关联");
                $(s).css("color", "red");
            }
            $(c).append(chk).append(s);

            //按钮
            if (permission.insertPermission && permission.deletePermission && permission.modifyPermission) {
                var btn = document.createElement("input");
                $(btn).attr("type", "button").addClass("button2");
                $(btn).css({ "float": "right", "width": 45, "height": 25 });
                var text = isAssigned ? "移除" : "添加";
                $(btn).val(text).appendTo(c);

                //绑定事件
                $(btn).click(function () {
                    if (isAssigned) {
                        var flowOperationId = szdwGvRp.paramJson["flowOperationId"];
                        var Id = jsonList[rowIndex].Id;
                        var permissionTypeId = $("#ddlPermissionType").data("value");
                        var modifierId = xuserId;
                        var paramJson = { flowOperationId: flowOperationId, Id: Id, permissionTypeId: permissionTypeId, modifierId: modifierId };
                        FlowOperationRelationDelete(paramJson);
                    } else {
                        var creatorId = xuserId;
                        var flowOperationId = szdwGvRp.paramJson["flowOperationId"];
                        var Id = jsonList[rowIndex].Id;
                        var permissionTypeId = $("#ddlPermissionType").data("value");
                        var paramJson = { flowOperationId: flowOperationId, Id: Id,permissionTypeId: permissionTypeId, creatorId: creatorId };
                        FlowOperationRelationInsert(paramJson);
                    }
                });
            }
            return c;
        }

        //#region 添加或移除用户
        //添加用户
        function FlowOperationRelationInsert(paramJson) {
            var objDataBind = szdwGvRp;
            var requestUrl = "FlowOperationRelationSetingProcess.ashx";
            paramJson["MethodName"] = "FlowOperationRelationInsert";
            SzdwAjaxDataOperate.ajaxInsert(objDataBind, requestUrl, paramJson);
        }

        //移除用户
        function FlowOperationRelationDelete(paramJson) {
            var objDataBind = szdwGvRp;
            var requestUrl = "FlowOperationRelationSetingProcess.ashx";
            paramJson["MethodName"] = "FlowOperationRelationDelete";
            SzdwAjaxDataOperate.ajaxDelete(objDataBind, requestUrl, paramJson);
        }
        //#endregion 添加或移除用户
        //#endregion 自定义控件列     
        //#endregion 查询结果
        //#endregion 右面板

        //#region 流程操作数据操作：增删改
        //流程操作插入新记录
        function FlowOperationInsert() {
            var body = document.body;
            var bw = $(body).width();
            var bh = $(body).height();
            var pageUrl = "FlowOperationInsert.html";
            var titleText = "添加流程操作";
            var paramJson = null;
            var w = 330;
            var h = $(roleDataPanel).height() - 4;
            var x = bw - w - ml - 2;
            var y = $(roleDataPanel).offset().top + 2;
            var hasAnimation = false;
            SzdwCommon.openPopupWindow(titleText, pageUrl, paramJson, 5, y, w, h);
        }
        //流程操作删除
        function FlowOperationDelete(rowIndex) {
            var jsData = szdwFlowOperation.recordSetJson[rowIndex];
            var id = jsData.Id;
            var paramJson = { id: id, modifierId: xuserId };
            var objDataBind =szdwFlowOperation;
            var url = "FlowOperationProcess.ashx";
            paramJson["MethodName"] = "FlowOperationDelete";
            SzdwAjaxDataOperate.ajaxInsert(objDataBind, url, paramJson, InsertCallBack);
        }
        function InsertCallBack() {
            alert("删除成功。");
            szdwFlowOperation.DataBind();
        }
        // 流程操作编辑
        function FlowOperationUpdate(rowIndex) {
            var jsData = szdwFlowOperation.recordSetJson[rowIndex];
            var body = document.body;
            var bw = $(body).width();
            var bh = $(body).height();
            var titleText = "编辑流程操作信息";
            var pageUrl = "FlowOperationUpdate.html";
            var paramJson = { id: jsData.Id, name: jsData.Name, memo: jsData.Memo, modifierId: xuserId };
            var w = 330;
            var h = $(roleDataPanel).height() - 4;
            var x = bw - w - ml - 2;
            var y = $(roleDataPanel).offset().top + 2;
            var hasAnimation = false;
            SzdwCommon.openPopupWindow(titleText, pageUrl, paramJson, 5, y, w, h);
        }

        //#endregion 流程操作数据操作：增删改

        //#region 流程触发规则数据操作：增删改
        //流程触发规则删除
        function FlowRuleDelete(rowIndex) {
            var jsData = szdwGvRp.recordSetJson[rowIndex];
            var id = jsData.Id;
            var paramJson = { id: id, modifierId: xuserId };
            var objDataBind = szdwGvRp;
            var url = "FlowRuleProcess.ashx";
            paramJson["MethodName"] = "FlowRuleDelete";
            SzdwAjaxDataOperate.ajaxInsert(objDataBind, url, paramJson, InsertCallBack);
        }
        function InsertCallBack() {
            alert("删除成功。");
            szdwFlowOperation.DataBind();
        }
        // 流程触发规则编辑
        function FlowRuleUpdate(rowIndex) {
            var jsData = szdwGvRp.recordSetJson[rowIndex];
            var body = document.body;
            var bw = $(body).width();
            var bh = $(body).height();
            var titleText = "编辑流程操作信息";
            var pageUrl = "FlowRuleUpdate.html";
            var paramJson = { id: jsData.Id, name: jsData.Name, memo: jsData.Memo, modifierId: xuserId };
            var w = 330;
            var h = $(rpDataPanel).height() - 4;
            var x = bw - w - ml - 2 - ml;
            var y = $(rpDataPanel).offset().top + 2;
            var hasAnimation = false;
            SzdwCommon.openPopupWindow(titleText, pageUrl, paramJson, x, y, w, h);
        }

        //#endregion 流程触发规则数据操作：增删改

        //#region 流程状态数据操作：增删改
        //插入新记录
        function ItemSetingInsert() {
            var body = document.body;
            var bw = $(body).width();
            var bh = $(body).height();
            var pt = $("#ddlPermissionType").data("value");
            if (pt == 1) {
                szdwItemInsertButton.btnText = "新增流程规则";
                var pageUrl = "FlowRuleInsert.html";
                var titleText = "新增流程规则";
            }
            if (pt == 2) {
                szdwItemInsertButton.text = "新增流程状态";
                var pageUrl = "FlowStatusInsert.html";
                var titleText = "新增流程状态";
            }
            if (pt == 4) {
                szdwItemInsertButton.text = "新增流程处理结果";
                var pageUrl = "FlowHandleResultInsert.html";
                var titleText = "新增流程处理结果";
            }
            var paramJson = null;
            var w = 330;
            var h = $(rpDataPanel).height() - 4;
            var x = bw - w - ml- 2-ml;
            var y = $(rpDataPanel).offset().top + 2;
            var hasAnimation = false;
            SzdwCommon.openPopupWindow(titleText, pageUrl, paramJson, x, y, w, h);
        }
        // 流程状态编辑
        function FlowStatusUpdate(rowIndex) {
            var jsData = szdwGvRp.recordSetJson[rowIndex];
            var body = document.body;
            var bw = $(body).width();
            var bh = $(body).height();
            var titleText = "编辑流程状态信息";
            var pageUrl = "FlowStatusUpdate.html";
            var paramJson = { id: jsData.Id, name: jsData.Name, memo: jsData.Memo, modifierId: xuserId };
            var w = 330;
            var h = $(rpDataPanel).height() - 4;
            var x = bw - w - ml - 2 - ml;
            var y = $(rpDataPanel).offset().top + 2;
            var hasAnimation = false;
            SzdwCommon.openPopupWindow(titleText, pageUrl, paramJson, x, y, w, h);
        }
        //流程触发规则删除
        function FlowStatusDelete(rowIndex) {
            var jsData = szdwGvRp.recordSetJson[rowIndex];
            var id = jsData.Id;
            var paramJson = { id: id, modifierId: xuserId };
            var objDataBind = szdwGvRp;
            var url = "FlowStatusProcess.ashx";
            paramJson["MethodName"] = "FlowStatusDelete";
            SzdwAjaxDataOperate.ajaxInsert(objDataBind, url, paramJson, InsertCallBack);
        }
        //#endregion 流程触发规则数据操作：增删改

        //#region 流程处理结果数据操作：增删改
        //流程处理结果删除
        function FlowHandleResultDelete(rowIndex) {
            var jsData = szdwGvRp.recordSetJson[rowIndex];
            var id = jsData.Id;
            var paramJson = { id: id, modifierId: xuserId };
            var objDataBind = szdwGvRp;
            var url = "FlowHandleResultProcess.ashx";
            paramJson["MethodName"] = "FlowHandleResultDelete";
            SzdwAjaxDataOperate.ajaxInsert(objDataBind, url, paramJson, InsertCallBack);
        }
        function InsertCallBack() {
            alert("删除成功。");
            szdwFlowOperation.DataBind();
        }
        // 流程处理结果编辑
        function FlowHandleResultUpdate(rowIndex) {
            var jsData = szdwGvRp.recordSetJson[rowIndex];
            var body = document.body;
            var bw = $(body).width();
            var bh = $(body).height();
            var titleText = "编辑处理结果信息";
            var pageUrl = "FlowHandleResultUpdate.html";
            var paramJson = { id: jsData.Id, name: jsData.Name, memo: jsData.Memo, modifierId: xuserId };
            var w = 330;
            var h = $(rpDataPanel).height() - 4;
            var x = bw - w - ml - 2 - ml;
            var y = $(rpDataPanel).offset().top + 2;
            var hasAnimation = false;
            SzdwCommon.openPopupWindow(titleText, pageUrl, paramJson, x, y, w, h);
        }

        //#endregion 流程触发规则数据操作：增删改

    </script>
</body>
</html>