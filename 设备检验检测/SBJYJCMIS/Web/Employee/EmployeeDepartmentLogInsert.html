<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="../Styles/Query.css" rel="stylesheet" type="text/css" />
    <link href="../Styles/ScrollBar.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwAjaxDataOperate.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwDropDownList.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwDatePicker.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwValidator.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwOnOff.js" type="text/javascript"></script>
    <script src="../SzdwControls/domCommon.js" type="text/javascript"></script>
    <style type="text/css">
        input::-ms-clear {
            display: none;
        }
    </style>
</head>
<body>
    <form>
        <div id="operatePanel">
            <div id="basicInfoTitle" class="groupTitle" style="cursor: pointer;">
                <label>
                    人员单位调动信息
                </label>
                <div id="expBasic" style="float: right">
                </div>
            </div>
            <div id="basicInfoGroup" class="groupPanel">
                <div class="pwRow">
                    <div id="cell12" class="cellDiv">
                        <label class="pwLabel">人员姓名:</label>
                        <div style="float:right;">
                            <div id="txtEmployee" class="pwLabel" style="width: 174px; text-align:left;"></div>
                        </div>
                    </div>
                </div>
                <div class="pwRow">
                    <div id="Div2" class="cellDiv">
                        <label class="pwLabel">原单位名称:</label>
                        <div style="float:right;">
                            <div id="txtOldDepartment" class="pwLabel" style="width: 174px; text-align:left;"></div>
                        </div>
                    </div>
                </div>
                <div class="pwRow">
                    <div id="Div1" class="cellDiv">
                        <label class="pwLabel">
                            新单位名称:
                        </label>
                        <input id="ddlDepartment" type="text" class="pwDropDownList" style="width: 171px;
                        float: right" />
                    </div>
                </div>
                <div class="pwRow">
                    <div id="Div3" class="cellDiv">
                        <label for="txtReason" class="pwLabel">
                            调动原因:
                        </label>
                        <input id="txtReason" type="text" class="pwTextBox" style="width: 168px; float: right" />
                    </div>
                </div>
                <div class="pwRow">
                    <div id="cell40" class="cellDiv">
                        <label class="pwLabel">
                            调动日期:
                        </label>
                        <div id="btnDate" class="pwBtnDate" style="float: right">
                        </div>
                        <input id="txtDate" type="text" class="pwTextBox" style="width: 142px; float: right" />
                    </div>
                </div>
                <div class="pwRow" style="height:45px;">
                    <div id="Div4" class="cellDiv">
                        <label class="pwLabel">
                            调动描述:
                        </label>
                        <textarea id="txtMemo" rows="2" cols="1" class="pwTextarea" style="width: 168px;
                        height: 50px; float: right"></textarea>
                    </div>
                </div>
            </div>
        </div>
        <div id="buttonPanel">
            <input id="btnCancel" type="button" value="取消" class="pwButton2" style="float: right;" />
            <input id="btnSave" type="button" value="提交保存" class="pwKeyButton2" style="float: right" />
        </div>
    </form>
    <script type="text/javascript">

        //#region 全局变量
        var xuserId, permission = null;
        var bodyWidth = $(document.body).width();
        var opw = parent.document.body.popupWindow;
        var bodyHeight = opw.pagePanelHeight;
        var ml = 10; mt = 10; btnHeight = 32; btnPanelHeight = 35;
        var maxHeight = bodyHeight - btnPanelHeight - 28;
        var panelWidth = bodyWidth - ml * 2;

        var oldDepartmentId;
        var employeeId;
        var existedFlowNodeDefaultSetting = false;
        //#endregion 全局变量

        //#region 网页加载

        //#region 初始加载
        $(document).ready(function () {

            xuserId = parent.xuserId;
            oldDepartmentId = parent.oldDepartmentId;

            //设置录入面板
            SetOperatePanel();

            //设置按钮面板
            SetButtonPanel();

            FlowNodeDefaultSettingIsExisted();
            //窗口调整大小
            $(window).resize(function () {
                var pw = parent.document.body.popupWindow;
                SzdwCommon.rePositionButtonPanel(pw, $("#buttonPanel"));
                SzdwCommon.reSizeOperatePanel(pw, $("#operatePanel"), $("#buttonPanel"));
            });
        });

        //#endregion 初始加载

        //#endregion 网页加载

        //#region 数据操作面板

        //#region 设置录入面板
        function SetOperatePanel() {
            var p = $("#operatePanel");
            var x = 0;
            var y = 0;
            var w = bodyWidth - x * 2;
            var h = bodyHeight - btnPanelHeight;
            $(p).addClass("queryPanel").css({ "left": x, "top": y, "min-width": 0, "margin-bottom": "3px", "padding": "0px 0px 15px 0px", "overflow": "hidden" }).outerWidth(w).outerHeight(h, true);

            var cw = w - ml * 2;
            $(".cellDiv").outerWidth(cw);

            //设置滚动条
            $(p).addClass("scrollBar2");
            $(p).mouseover(function () {
                $(this).css({ "overflow-y": "auto" });
            }).mouseleave(function () {
                $(this).css({ "overflow-y": "hidden" });
            });

            //#region 信息分组

            //基本信息
            SetBasicInfoTitle();
            SetBasicInfoGroup();
            //#endregion 信息分组

            BindDdlDepartment();
            SetDate();
            //#region 加载验证器
            LoadValidaor();
            //#endregion 加载验证器
        }

        //#endregion 设置录入面板

        //#region 信息分组

        //#region 基本信息

        //#region 基本信息标题
        function SetBasicInfoTitle() {
            var p = $("#basicInfoTitle");
            var x = 0;
            var y = 0;
            var w = bodyWidth;
            $(p).css({ "position": "relative", "left": x, "top": y }).outerWidth(w);

            //绑定事件
            $(p).click(function () {
                SzdwCommon.infoGroupTitleClick(szdwExpBasic, basicInfoValidators);
            }).mouseover(function () {
                if (szdwExpBasic.onOff) szdwExpBasic.Show();
            }).mouseleave(function () {
                if (szdwExpBasic.onOff) szdwExpBasic.Hide();
            });

            //加载组显隐开关
            LoadSzdwExpBasic();
        }
        //#endregion 基本信息标题

        //#region 基本信息显隐
        var szdwExpBasic = null;
        function LoadSzdwExpBasic() {
            if (!szdwExpBasic) {
                var p = "relative";
                var x = 0;
                var y = 0;
                var w = 56;
                var h = 22;
                szdwExpBasic = new SzdwOnOff(p, x, y, w, h);
                szdwExpBasic.namingContainer = $("#expBasic");
                szdwExpBasic.visible = false;
                szdwExpBasic.onOff = true;
                szdwExpBasic.backColorOn = parent.themeColor ? parent.themeColor : parent.parent.themeColor;
                szdwExpBasic.fnClickCallBack = FnExpBasic;
                szdwExpBasic.Load();
            }
        }

        //显隐回调函数
        var basicInfoValidators = []; //存储验证器对象的数组
        function FnExpBasic() {
            var arrValidators = basicInfoValidators;
            //隐藏验证器
            $.each(arrValidators, function (i, item) {
                $(item.panel).css({ "display": "none" });
                item.showing = false;
            });

            //组面板显示完毕后执行验证
            var g = $("#basicInfoGroup");
            $(g).slideToggle(300, null, function () {
                SzdwCommon.setGroupValidatorsPosition(arrValidators);
                SzdwCommon.scrollToView(g, $(g).parent());
            });
        }
        //#endregion 基本信息显隐

        //#region 基本信息组
        function SetBasicInfoGroup() {
            $("#basicInfoGroup").css({ "position": "relative" }).outerWidth(bodyWidth);
        }

        //#endregion 基本信息组

        //#endregion 基本信息

        //#endregion 信息分组

        //#region 单位下拉框
        //绑定
        function BindDdlDepartment() {
            var requestUrl = "../Department/DepartmentHandler.ashx";
            var paramJson = { xuserId: xuserId, oldDepartmentId: oldDepartmentId, newDepartmentId: 0, MethodName: "DepartmentGetListByOldDepartmentIdAndNewDepartmentId" };
            var fnInitial = InitialDdlDepartment;

            //流程名称下拉框
            var param = { requestUrl: requestUrl, paramJson: paramJson, fnInitial: fnInitial, maxHeight: maxHeight };
            $("#ddlDepartment").dropDownList(param);
        }

        //下拉框初始化设置
        function InitialDdlDepartment(szdwDdl) {
            szdwDdl.hasSearchBox = 1;
            szdwDdl.namingContainer = $("#operatePanel");
        }

        //#endregion 单位下拉框

        //#region 设置日期
        function SetDate() {
            var d = $("#txtDate");
            $(d).val(new Date().format("yyyy-MM-dd"));
            $(d).datePicker({ relateControl: $("#btnDate"), namingContainer: $("#operatePanel") });
        }
        //#endregion 设置日期

        //#region 验证

        function LoadValidaor() {
            var wt = 3;

            var ncBsc = $("#basicInfoGroup");

            $("#ddlDepartment").szdwValidate({
                widthType: wt,
                fnInitial: function (szdwCtrl) {
                    szdwCtrl.namingContainer = ncBsc;
                    szdwCtrl.offsetMode = 0;
                    basicInfoValidators.push(szdwCtrl);
                }
            });

            $("#txtDate").szdwValidate({
                widthType: wt,
                fnInitial: function (szdwCtrl) {
                    szdwCtrl.namingContainer = ncBsc;
                    szdwCtrl.offsetMode = 0;
                    szdwCtrl.ruleJson = { required: false, date: true };
                    basicInfoValidators.push(szdwCtrl);
                }
            });
        }

        //#endregion 验证

        //#endregion 数据操作面板

        //#region 按钮面板

        //#region 设置按钮面板
        function SetButtonPanel() {

            //设置位置属性
            var p = $("#buttonPanel");
            var w = bodyWidth;
            var h = 35;
            var x = 0;
            var y = bodyHeight - h - 2;
            $(p).css({ "position": "relative", "left": x, "top": y, "border-top": "0px solid #E2E2E2", "padding": "5px 10px 5px 5px" });
            $(p).outerWidth(w).outerHeight(h);

            //绑定按钮事件
            BindButtonHandler();
        }

        //#endregion 设置按钮面板 结束

        //#region 绑定按钮事件
        function BindButtonHandler() {
            var szdwGv = parent.szdwGv;
            var pw = parent.document.body.popupWindow;

            var qsJson = $.parseJSON(SzdwCommon.getQueryString("paramJson"));
            var IsIE8 = navigator.appName == "Microsoft Internet Explorer" && navigator.appVersion.match(/8./i) == "8.";
            var employee = qsJson.employee;
            employeeId = qsJson.employeeId;

            var oldDepartment = qsJson.oldDepartment;
            var OldDepartmentId = qsJson.oldDepartmentId;

            var txtEmployee = $("#txtEmployee");
            var txtOldDepartment = $("#txtOldDepartment");

            $(txtEmployee).text(employee);
            $(txtOldDepartment).text(oldDepartment);

            //提交申请按钮
            $("#btnSave").click(function () {
                var isValid = GetValidResult();
                if (isValid) {
                    if (!existedFlowNodeDefaultSetting) {
                        var NewDepartmentId = $("#ddlDepartment").data("value");

                        if (NewDepartmentId == OldDepartmentId) {
                            alert("新单位名称与原单位名称相同，请重新选择单位名称");
                        }

                        else {
                            //显示操作信息
                            SzdwCommon.showOperateInfoPanel(parent.opInfoPanel, parent.CreateOperateInfoPanel, "正在添加记录…");
                            var oldAllowRecoverRow = szdwGv.allowRecoverRowStyleWhenDataBinding;
                            szdwGv.allowRecoverRowStyleWhenDataBinding = false;

                            var NewDepartmentId = $("#ddlDepartment").data("value");
                            var Reason = $.trim($("#txtReason").val());
                            var Date = $.trim($("#txtDate").val());
                            var memo = $.trim($("#txtMemo").val());

                            var objDataBind = szdwGv;
                            var requestUrl = "CollectEmployeeDepartmentLog.ashx";
                            var paramJson = {
                                EmployeeId: employeeId, OldDepartmentId: OldDepartmentId, NewDepartmentId: NewDepartmentId, Reason: Reason, Date: Date, memo: memo, creatorId: xuserId, MethodName: "EmployeeDepartmentLogInsert"
                            };
                            SzdwAjaxDataOperate.ajaxInsert(null, requestUrl, paramJson, function () {
                                SzdwCommon.hideOperateInfoPanel(parent.opInfoPanel, "添加记录成功", parent.RecoverSelectedRow);
                                if (szdwGv) { szdwGv.DataBind(); szdwGv.allowRecoverRowStyleWhenDataBinding = oldAllowRecoverRow; }
                                pw.Hide();
                            });
                        }
                    }
                    else {
                        alert("此人员为隐患处理中的默认处理人，请先将此人在“节点默认设置”中的默认人员修改之后，在进行人员单位调动操作");
                    }
                }
            });

            //关闭按钮
            $("#btnCancel").click(function () {
                //获取弹窗
                pw.Hide();
                parent.RecoverSelectedRow();
            });

            //重置按钮
            $("#btnReset").click(function () {
                $("#txtReason").val("");
                $("#ddlDepartment").val("");
                $("#ddlDepartment").data("value", 0);
                ivSzdwGv.DataBind();
            });
        }

        //#endregion 绑定按钮事件

        //#region 获取验证结果
        function GetValidResult() {
            var basicValid = SzdwCommon.getGroupValidation(basicInfoValidators);
            if (!basicValid && !szdwExpBasic.onOff) {
                szdwExpBasic.Click();
            }

            var isValid = basicValid;

            return isValid;
        }
        //#endregion 获取验证结果

        //#endregion 按钮面板

        //#region 根据条件获取数据
        //获取人员在处理安排默认之中是否存在
        function FlowNodeDefaultSettingIsExisted() {

            var url = "../Employee/CollectEmployee.ashx";
            var paramJson = { employeeId: employeeId, MethodName: "FlowNodeDefaultSettingIsExistedByEmployeeId" };
            //重置密码
            $.ajax({
                url: url, type: "post", data: paramJson, dataType: "json",
                success: function (jsonData) {
                    if (jsonData.isExisted) {
                        existedFlowNodeDefaultSetting = true;
                    }
                }
            });
        }

        //#endregion 根据条件获取数据

    </script>
</body>
</html>
