<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="../Styles/Query.css" rel="stylesheet" type="text/css" />
    <link href="../Styles/ScrollBar.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="../SzdwControls/domCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwAjaxDataOperate.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwDropDownList.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwValidator.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwOnOff.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwMark.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCommon.js" type="text/javascript"></script>
    <style type="text/css">
        input::-ms-clear {
            display: none;
        }
    </style>
</head>
<body>
    <form action="">
    <div id="operatePanel">
        <div id="basicInfoTitle" class="groupTitle" style="cursor: pointer;">
            <label>基本信息</label>
            <div id="expBasic" style="float: right"></div>
        </div>
        <div id="basicInfoGroup" class="groupPanel">
            <div class="pwRow" style="display:none;">
                <div id="cell10" class="cellDiv">
                    <label class="pwLabel">单位类别:</label>
                    <input id="ddlDepartmentType" class="pwDropDownList" style="float: right; width: 208px;" />
                </div>
            </div>
            <div class="pwRow">
                <div id="cell30" class="cellDiv">
                    <label class="pwLabel">上级部门:</label>
                    <input id="ddlParentDepartment" class="pwDropDownList" style="float: right; width: 208px;" />
                </div>
            </div>
            <div class="pwRow">
                <div id="cell00" class="cellDiv">
                    <label class="pwLabel">部门名称:</label>
                    <input id="txtName" type="text" class="pwTextBox" style="float: right; width: 205px;" />
                </div>
            </div>
			<div class="pwRow">
				<div id="cell00" class="cellDiv">
					<label class="pwLabel">简    称:</label>
					<input id="txtShortName" type="text" class="pwTextBox" style="float: right; width: 205px;" />
				</div>
			</div>
            <div class="pwRow" style="display:none;">
                <div id="cell20" class="cellDiv">
                    <label class="pwLabel">负责人:</label>
                    <input id="ddlLeader" type="text" class="pwDropDownList" style="float: right; width: 208px;" />
                </div>
            </div>
            <div class="pwRow" style="display:none;">
                <div id="cell10" class="cellDiv">
                    <label class="pwLabel">部门性质:</label>
                    <input id="ddlProperty" class="pwDropDownList" style="float: right; width: 208px;" />
                </div>
            </div>
            <div class="pwRow" style="display:none;">
                <div id="cell40" class="cellDiv">
                    <label class="pwLabel">行政区划:</label>
                    <input id="ddlRegion" class="pwDropDownList" style="float: right; width: 208px;" />
                </div>
            </div>
            <div class="pwRow" style="display:none;">
                <div id="cell00" class="cellDiv">
                    <label class="pwLabel">经度:</label>
                    <input id="txtLongitude" type="text" class="pwTextBox" style="float:right;width: 205px; " />
                </div>
            </div>
            <div class="pwRow" style="display:none;">
                <div id="cell00" class="cellDiv">
                    <label class="pwLabel">维度:</label>
                    <input id="txtLatitude" type="text" class="pwTextBox" style="float:right;width: 205px; " />
                </div>
            </div>
            <div class="pwRow" style="height:43px;">
                <div id="cell50" class="cellDiv">
                    <label class="pwLabel">部门描述:</label>
                    <textarea id="txtMemo" rows="2" cols="1" class="pwTextarea" style="float: right;
                        width: 205px; height: 50px;"></textarea>
                </div>
            </div>
        </div>
    </div>
    <div id="buttonPanel" class="pwBtnPanel">
        <input id="chkClose" type="checkbox" checked="checked" class="pwCheckbox" />
        <label for="chkClose" class="pwLabel">提交后关闭</label>
        <input id="btnCancel" type="button" value="取消" class="pwButton2" style="float: right;" />
        <input id="btnSave" type="button" value="提交保存" class="pwKeyButton2" style="float: right" />
    </div>
    </form>
    <script type="text/javascript">

        //#region 全局变量
        var xuserId, permission = null;
        var bodyWidth = $(document.body).width();
        var opw = parent.document.body.popupWindow;
        var bodyHeight = opw.pagePanelHeight;
        var ml = 10; mt = 10; btnHeight = 32; btnPanelHeight = 35;
        var maxHeight = bodyHeight - btnPanelHeight - 28;
        var panelWidth = bodyWidth - ml * 2;
        var departmentTypeId = 5;
        var parentDepartmentId = 0;
        //#endregion 全局变量

        //#region 网页加载

        //#region 初始加载
        $(document).ready(function () {
            xuserId = parent.xuserId;

            SetOperatePanel();
            $("#ddlRegion").val("").data("value", "");
            LoadValidaor();

            //设置按钮面板
            SetButtonPanel();

            //按钮事件绑定
            ButtonHandler();

            //ClearOperatePanelData();

            //窗口调整大小
            $(window).resize(function () {
                var pw = parent.document.body.popupWindow;
                SzdwCommon.rePositionButtonPanel(pw, $("#buttonPanel"));
                SzdwCommon.reSizeOperatePanel(pw, $("#operatePanel"), $("#buttonPanel"));
            });
        });

        function RePositionControls() {
            var pw = parent.document.body.popupWindow;
            if (pw) {
                var p = $("#buttonPanel");
                var ph = pw.pagePanelHeight;
                var h = $(p).outerHeight();
                var x = 0;
                var y = ph - h - 2;
                $(p).css({ "left": x, "top": y });
            }
        }
        //#endregion 初始加载

        //#endregion 网页加载  

        //#region 录入面板

        //#region 设置录入面板
        function SetOperatePanel() {
            var p = $("#operatePanel");
            var x = 0;
            var y = 0;
            var w = bodyWidth - x * 2;
            var h = bodyHeight - btnPanelHeight;
            $(p).addClass("queryPanel").css({ "left": x, "top": y, "min-width": 0, "margin-bottom": "3px", "padding": "0px 0px 15px 0px", "overflow": "hidden" }).outerWidth(w).outerHeight(h, true);

            var cw = w - ml * 2;
            $(".cellDiv").outerWidth(cw);

            //设置滚动条
            $(p).addClass("scrollBar2");
            $(p).mouseover(function () {
                $(this).css({ "overflow-y": "auto" });
            }).mouseleave(function () {
                $(this).css({ "overflow-y": "hidden" });
            });

            //绑定下拉框到目标控件
            BindDropDownLists();

            //部门基本信息
            SetBasicInfoTitle();
            LoadSzdwExpBasic();
            SetBasicInfoGroup();
        }

        //#endregion 设置录入面板    

        //#region 信息分组

        //#region 人员基本信息

        //#region 基本信息标题
        function SetBasicInfoTitle() {
            var p = $("#basicInfoTitle");
            var x = 0;
            var y = 0;
            var w = bodyWidth;
            $(p).css({ "position": "relative", "left": x, "top": y }).outerWidth(w);

            //绑定事件
            $(p).click(function () {
                InfoTitleClick(szdwExpBasic, basicInfoValidators);
            }).mouseover(function () {
                if (szdwExpBasic.onOff) szdwExpBasic.Show();
            }).mouseleave(function () {
                if (szdwExpBasic.onOff) szdwExpBasic.Hide();
            });
        }
        //#endregion 基本信息标题   

        //#region 基本信息显隐
        var szdwExpBasic = null;
        function LoadSzdwExpBasic() {
            if (!szdwExpBasic) {
                var p = "relative";
                var x = 0;
                var y = 0;
                var w = 56;
                var h = 22;
                szdwExpBasic = new SzdwOnOff(p, x, y, w, h);
                szdwExpBasic.namingContainer = $("#expBasic");
                szdwExpBasic.visible = false;
                szdwExpBasic.onOff = true;
                szdwExpBasic.backColorOn = parent.themeColor ? parent.themeColor : parent.parent.themeColor;
                szdwExpBasic.fnClickCallBack = FnExpBasic;
                szdwExpBasic.Load();
            }
        }

        //显隐回调函数
        var basicInfoValidators = []; //存储验证器对象的数组
        function FnExpBasic() {
            var arrValidators = basicInfoValidators;
            //隐藏验证器
            $.each(arrValidators, function (i, item) {
                $(item.panel).css({ "display": "none" });
                item.showing = false;
            });

            //组面板显示完毕后执行验证
            var g = $("#basicInfoGroup");
            $(g).slideToggle(300, null, function () {
                SetValidatorsPosition(arrValidators);
                InfoGroupScroll(g);
            });
        }

        //获取组验证结果
        function GetBasicInfoGroupValidation() {
            var isValid = true;
            $.each(basicInfoValidators, function (i, item) {
                var t = item.targetControl;
                $(t).trigger("blur");
                isValid = isValid && $(t).data("isValid");
            });

            return isValid;
        }
        //#endregion 基本信息显隐

        //#region 基本信息组
        function SetBasicInfoGroup() {
            var p = $("#basicInfoGroup");
            var w = bodyWidth;
            $(p).css({ "position": "relative" }).outerWidth(w);
        }

        //#endregion 基本信息组    

        //#endregion 人员基本信息

         //#region 组标题通用点击事件

        //标题点击事件
        function InfoTitleClick(objSzdwOnOff, arrValidators) {
            if (objSzdwOnOff.onOff) {
                //收起
                var isValid = GetValidation(arrValidators);
                objSzdwOnOff.allowClickEvent = isValid;
                if (isValid) {
                    objSzdwOnOff.Click();
                }
            } else {
                //展开
                objSzdwOnOff.Click();

            }
        }
        //#endregion 组标题通用点击事件

        //#region 滚动组到完全可视位置
        function InfoGroupScroll(objGroup) {
            var g = objGroup;
            var p = $("#operatePanel");
            var ph = $(p).height();
            var y = $(g).offset().top;
            var h = $(g).outerHeight();
            var oh = h - (ph - y);
            oh = oh > ph ? ph : oh;
            var st = $(p).scrollTop() + oh;
            $(p).animate({ scrollTop: st }, 300);
        }
        //#endregion 滚动组到完全可视位置

        //#endregion 信息分组

        //#region 下拉框

        //#region 加载下拉框
        function BindDropDownLists() {
            //绑定下拉框到目标控件
            BindDdlDepartmentType();
            BindDdlParentDepartment();
            BindDdlProperty();
            BindDdlLeader();
            BindDdlRegion();
        }
        //#endregion 加载下拉框 

        //#region 单位类别下拉框

        //绑定下拉框到目标控件
        function BindDdlDepartmentType() {

            var requestUrl = "../Department/DepartmentTypeProcess.ashx";

            //部门下拉框
            var paramJson = { MethodName: "GetDepartmentTypeNameList" };
            var paramDdlDep = { requestUrl: requestUrl, paramJson: paramJson, fnInitial: InitialDdlDepartmentType, maxHeight: maxHeight };
            $("#ddlDepartmentType").dropDownList(paramDdlDep);
            $("#ddlDepartmentType").val("管理部门").data("value","1");
        }

        //通用下拉框初始化设置
        function InitialDdlDepartmentType(szdwDdl) {
            szdwDdl.namingContainer = $("#operatePanel");
            szdwDdl.fnItemClick = function () {
            	departmentTypeId = $("#ddlDepartmentType").data("value");
                var v = $(szdwDdl.targetControl).data("validator");
                if (v) {
                    $(v.panel).css({ "display": "none" });
                }

                var name = $("#txtName").data("validator");
                if (name) {
                    name.fnGetParm = ParentChangeGetParamJson;
                }

                $("#txtName").trigger("blur");

                var shortName = $("#txtShortName").data("validator");
                if (shortName) {
                    shortName.fnGetParm = ParentChangeGetParamJson;
                }

                $("#txtShortName").trigger("blur");
            
            }
        }

        //#endregion 单位类别下拉框

        //#region 部门性质下拉框
        //绑定下拉框到目标控件
        var szdwDdlProperty = null;
        function BindDdlProperty() {
            //var requestUrl = "../Department/CollectDepartmentProperty.ashx";

            //部门下拉框
            //var paramJson = { XuserId: xuserId, MethodName: "DepartmentPropertyGetNameList" };
            //var paramDdlDep = { requestUrl: requestUrl, paramJson: paramJson, fnInitial: InitialDdlProperty, maxHeight: maxHeight };
            //$("#ddlProperty").dropDownList(paramDdlDep);
            $("#ddlProperty").val("普通").data("value", "1");
        }

        //通用下拉框初始化设置
        function InitialDdlProperty(szdwDdl) {
            szdwDdl.namingContainer = $("#operatePanel");
        }
        //#endregion 部门性质下拉框

        //#region 行政区划下拉框
        //绑定下拉框到目标控件
        function BindDdlRegion() {
            var requestUrl = "../Region/RegionHandler.ashx";

            //下拉框
            var pjDdlDep = { Id: "41",length:2, hasSelf: 0, MethodName: "GetRegionListByShortID" };
            var paramDdlDep = { requestUrl: requestUrl, paramJson: pjDdlDep, fnInitial: InitialDdlRegion, maxHeight: maxHeight };
            //$("#ddlRegion").val("河南省");
            //$("#ddlRegion").data("value", "410000");
            $("#ddlRegion").dropDownList(paramDdlDep);
        }

        //初始化部门设置
        function InitialDdlRegion(szdwDdl) {
            szdwDdl.namingContainer = $("#operatePanel");
            //szdwDdl.jsonItemAll = { Id: "41", Name: "河南省" };
            szdwDdl.hasSearchBox = true;
        }

        //#endregion 行政区划下拉框

        //#region 负责人下拉框
        function BindDdlLeader() {

            var requestUrl = "../Permission/PermissionDropDwonListProcess.ashx";
            var paramJson = { xuserId: xuserId, MethodName: "EmployeeGetList" };

            //流程名称下拉框
            var param = { requestUrl: requestUrl, paramJson: paramJson, fnInitial: InitialDdlLeader, maxHeight: maxHeight };
            $("#ddlLeader").dropDownList(param);
        }

        //通用下拉框初始化设置
        function InitialDdlLeader(szdwDdl) {
            szdwDdl.namingContainer = $("#operatePanel");
        }

        //#endregion 负责人下拉框

        //#region 上级部门下拉框
        //绑定下拉框到目标控件
        function BindDdlParentDepartment() {

            var requestUrl = "../Department/DepartmentHandler.ashx";

            //部门下拉框
            var paramJson = { XuserId: xuserId, MethodName: "GetDepartmentListByDepartmentTypeId", departmentTypeId: "1" };
            var paramDdlDep = { requestUrl: requestUrl, paramJson: paramJson, fnInitial: InitialDdlParentDepartment, maxHeight: maxHeight };
            $("#ddlParentDepartment").dropDownList(paramDdlDep);

        }

        //通用下拉框初始化设置
        function InitialDdlParentDepartment(szdwDdl) {
            szdwDdl.hasSearchBox = 1;
            szdwDdl.nonCascadeItemLength = 1;
            szdwDdl.namingContainer = $("#operatePanel");
            szdwDdl.fnItemClick = function () {
                parentDepartmentId = $("#ddlParentDepartment").data("value");
                var name = $("#txtName").data("validator");
                if (name) {
                    name.fnGetParm = ParentChangeGetParamJson;
                }

                $("#txtName").trigger("blur");

                var shortName = $("#txtShortName").data("validator");
                if (shortName) {
                    shortName.fnGetParm = ParentChangeGetParamJson;
                }

                $("#txtShortName").trigger("blur");
            }
        }

        //#endregion 上级部门下拉框

        //#region 上级单位及单位类别改变事件
        function ParentChangeGetParamJson() {
            var param = { departmentTypeId: departmentTypeId, parentId: parentDepartmentId };
            return param;
        }
        //#endregion 上级单位及单位类别改变事件

        //#endregion 下拉框

        //#region 验证

        //#region 加载验证
        function LoadValidaor() {
            var wt = 3;

            var ncBsc = $("#basicInfoGroup");
            $("#txtName").szdwValidate({
                widthType: wt,
                fnInitial: function (szdwCtrl) {
                    szdwCtrl.namingContainer = ncBsc;
                    szdwCtrl.offsetMode = 0;
                    szdwCtrl.ruleJson = { required: true, existence: true };
                    szdwCtrl.existenceRequestUrl = "DepartmentHandler.ashx";
                    szdwCtrl.existenceRequestMethodName = "IsExistedByName";
                    szdwCtrl.existenceParamJson = { departmentTypeId: departmentTypeId, parentId: parentDepartmentId };
                    szdwCtrl.existenceParamName = "name";
                    szdwCtrl.fnGetParm = ParentChangeGetParamJson;
                    basicInfoValidators.push(szdwCtrl);
                }
            });
            $("#txtShortName").szdwValidate({
            	widthType: wt,
            	fnInitial: function (szdwCtrl) {
            		szdwCtrl.namingContainer = ncBsc;
            		szdwCtrl.offsetMode = 0;
            		szdwCtrl.ruleJson = { required: true, existence: true };
            		szdwCtrl.existenceRequestUrl = "DepartmentHandler.ashx";
            		szdwCtrl.existenceRequestMethodName = "IsExistedByShortName";
            		szdwCtrl.existenceParamJson = { departmentTypeId: departmentTypeId, parentId: parentDepartmentId };
            		szdwCtrl.existenceParamName = "shortName";
            		szdwCtrl.fnGetParm = ParentChangeGetParamJson;
            		basicInfoValidators.push(szdwCtrl);
            	}
            });
            //$("#ddlDepartmentType").szdwValidate({
            //    widthType: wt,
            //    fnInitial: function (szdwCtrl) { 
            //        szdwCtrl.namingContainer = ncBsc;
            //        szdwCtrl.offsetMode = 0;
            //        basicInfoValidators.push(szdwCtrl);
            //    }
            //});

            //$("#ddlRegion").szdwValidate({
            //    widthType: wt,
            //    fnInitial: function (szdwCtrl) {
            //        szdwCtrl.namingContainer = ncBsc;
            //        szdwCtrl.offsetMode = 0;
            //        basicInfoValidators.push(szdwCtrl);
            //    }
            //});
            //$("#ddlTradeType").szdwValidate({
            //    widthType: wt,
            //    fnInitial: function (szdwCtrl) {
            //        szdwCtrl.namingContainer = ncBsc;
            //        szdwCtrl.offsetMode = 0;
            //        basicInfoValidators.push(szdwCtrl);
            //    }
            //});
            //$("#ddlProperty").szdwValidate({
            //    widthType: wt,
            //    fnInitial: function (szdwCtrl) {
            //        szdwCtrl.namingContainer = ncBsc;
            //        szdwCtrl.offsetMode = 0;
            //        basicInfoValidators.push(szdwCtrl);
            //    }
            //});
        }

        //#endregion 加载验证

        //#region 重设组内验证器位置
        function SetValidatorsPosition(arrValidators) {
            $.each(arrValidators, function (i, item) {
                var t = item.targetControl;
                $(t).trigger("blur");
                var isValid = $(t).data("isValid");
                if (!isValid) {
                    item.SetPosition();
                    item.Show();
                }
            });
        }
        //#endregion 重设组内验证器位置

        //#region 获取组验证结果
        function GetValidation(arrValidators) {
            var isValid = true;
            $.each(arrValidators, function (i, item) {
                var t = item.targetControl;
                $(t).trigger("blur");
                isValid = isValid && $(t).data("isValid");
            });

            return isValid;
        }
        //#endregion 获取组验证结果

        //#endregion 验证

        //#endregion 录入面板

        //#region 按钮面板

        //#region 设置按钮面板
        function SetButtonPanel() {
            var p = $("#buttonPanel");
            var w = bodyWidth;
            var h = 35;
            var x = 0;
            var y = bodyHeight - h - 2;
            $(p).css({ "position": "relative", "left": x, "top": y, "border-top": "0px solid #E2E2E2", "padding": "5px 10px 5px 5px" });
            $(p).outerWidth(w).outerHeight(h);
        }
        //#endregion 设置按钮面板        

        //#region 按钮事件
        function ButtonHandler() {
            //获取弹窗
            var szdwGv = parent.szdwGv;

            $("#btnSave").click(function () {
                //验证
                var isValid = GetValidResult();
                if (isValid) {
                    InsertDepartment();
                }
            });

            $("#btnCancel").click(function () {
                parent.document.body.popupWindow.Hide();
            });
        }

        //#region 回调函数

        function InsertCallBack() {
            SzdwCommon.hideOperateInfoPanel(parent.opInfoPanel, "添加记录成功");
            parent.RefreshDataAfterInsert();

            if ($("#chkClose").prop("checked")) {
                $("#btnCancel").trigger("click");
            }

            else {
                ClearOperatePanelData();
            }
        }

        //#endregion 回调函数  

        //#region 清空插入面板数据

        function ClearOperatePanelData() {
            $("#txtName").val("");
            $("#txtShortName").val("");
            $("#ddlDepartmentType").data("value", 5).val("");
            //$("#ddlTradeType").data("value", 0).val("");
            //$("#ddlProperty").data("value", 0).val("");
            $("#ddlRegion").data("value", "").val("");
            $("#ddlParentDepartment").data("value", 0).val("");
            
            $("#ddlLeader").data("value", 0).val("");
            $("#txtMemo").val("");
            departmentTypeId = 5;
            parentDepartmentId = 0;
        }

        //#endregion 清空插入面板数据
     
        //#region 插入隐患信息
        function InsertDepartment() {
            var szdwGv = parent.szdwGv;

            //显示操作信息
            SzdwCommon.showOperateInfoPanel(parent.opInfoPanel, parent.CreateOperateInfoPanel, "正在添加记录…");

            var name = $("#txtName").val();
            var shortName = $("#txtShortName").val();
            var departmentTypeId = $("#ddlDepartmentType").data("value");
            var regionId = $("#ddlRegion").data("value");
            //var tradeTypeId = $.trim($("#ddlTradeType").data("value"));
            //var propertyId = $.trim($("#ddlProperty").data("value"));
            var leaderId = $("#ddlLeader").data("value");
            var memo = $("#txtMemo").val();
            var creatorId = parent.xuserId;
            var objDataBind = szdwGv;
            var requestUrl = "DepartmentHandler.ashx";
            var paramJson = {
                Name: name, shortName: shortName, DepartmentTypeId: departmentTypeId, LeaderId: leaderId, ParentDepartmentId: parentDepartmentId, RegionId:regionId, PropertyId: 0, Memo: memo, CreatorId: creatorId, MethodName: "InsertDepartment"
            };
            $.ajax({
                url: requestUrl, type: "post", data: paramJson, dataType: "json",
                success: function (jsondata) {
                    if (jsondata.isInserted) {
                        InsertCallBack();
                    }
                    else {
                        SzdwCommon.hideOperateInfoPanel(parent.opInfoPanel, "添加失败");
                    }
                }
            });
        }

        //#endregion 插入隐患信息

        //#region 获取验证结果
        //获取验证结果
        function GetValidResult() {
            var basicValid = GetValidation(basicInfoValidators);
            if (!basicValid && !szdwExpBasic.onOff) {
                szdwExpBasic.Click();
            }

            var isValid = basicValid;

            return isValid;
        }

        //#endregion 获取验证结果

        //#endregion 按钮面板

    </script>
</body>
</html>
