<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title></title>
    <link href="../Styles/Page.css" rel="stylesheet" type="text/css" />
    <link href="../Styles/Query.css" rel="stylesheet" type="text/css" />    
    <script src="../Scripts/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="../SzdwControls/domCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwDropDownList.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwGridView.js" type="text/javascript"></script>
    <link href="../SzdwControls/SzdwGridView.css" rel="stylesheet" type="text/css" />
    <script src="../SzdwControls/SzdwPagination.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwButton.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwPopupWindow.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwAjaxDataOperate.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCommon.js" type="text/javascript"></script>
    <script src="../Scripts/CommonJScript.js" type="text/javascript"></script>
    <script src="../Scripts/myparm.js" type="text/javascript"></script>
</head>
<body style="background-color:#EEEEEE">
    <form action="">
        <div id="leftFilterPanel" style="height:25px;padding-bottom:10px;">
            <div id="rfpCell00" class="cellDiv" style="color:#1B60C3;font-size:12pt; font-family:微软雅黑;">组列表</div>
            <div id="rfpCell01" class="cellDiv" style="border-left:1px solid #DDDDDD;margin-left:10px;">
                <input id="txtGroupName" type="text" class="textBox2" style="background-color:transparent;border-right:0px;" />
            </div>
        </div>
        <div id="leftDataPanel"></div>
        <div id="rightFilterPanel" style="height:25px;padding-bottom:10px;">
            <div id="rpfpCell00" class="cellDiv" style="color:#1B60C3;font-size:12pt; font-family:微软雅黑;">添加用户到选定的组</div>
            <div id="rpfpCell01" class="cellDiv" style="border-left:1px solid #DDDDDD;margin-left:10px;">
                <div id="ddlAssignType" class="dropDownList" style="width:80px;"></div>
            </div>
            <div id="rpfpCell02" class="cellDiv" style="padding-left:5px">
                <input id="txtXuserName" type="text" class="textBox2" style="background-color:transparent;border-right:0px;width:120px;" />
            </div>
        </div>
        <div id="rightDataPanel"></div>
    </form>  
    
    <script type="text/javascript">
        //#region 全局变量
        var xuserId, xmenuId, permission = null; //用户及权限：json格式
        var leftWidth = 320;
        btnHeight = 26;
        //#endregion 全局变量

        $(document).ready(function () {    
            //获取用户Id和MenuId
            var paramJson = SzdwCommon.getJsonParm();
            xuserId = paramJson.xuserId;
            xmenuId = paramJson.xmenuId;
            permission = SzdwCommon.getPermission(paramJson.permissionJsonList);
            bodyWidth = Math.max($(document.body).width(), minWidth);
            bodyHeight = Math.max($(document.body).height(), minHeight);
            //设置查询面板
            SetLeftPanel();
            //设置结果面板
            SetRightPanel();
            //窗口调整大小
            $(window).resize(function () {
                bodyWidth = Math.max($(document.body).width(), minWidth);
                bodyHeight = Math.max($(document.body).height(), minHeight);
                ResizeControls();
            });
        });

        //#region 位置尺寸
        function ResizeControls() {
            $("#rightFilterPanel").outerWidth(bodyWidth - leftWidth - 3 * mt);
            $("#leftDataPanel").outerHeight(bodyHeight - 25 - 3 * mt);
            $("#rightDataPanel").outerWidth(bodyWidth - leftWidth - 3 * mt).outerHeight(bodyHeight - 25 - 3 * mt);
            if (szdwGroup) {
                szdwGroup.Resize(leftWidth, bodyHeight - 25 - 3 * mt);
            }
            if (szdwXg) {                
                szdwXg.Resize(bodyWidth - leftWidth - 3 * mt, bodyHeight - 25 - 3 * mt);
            }
        }
        //#endregion

        //#region 左面板
        function SetLeftPanel() {
            $("#leftFilterPanel")
                .css({ "position": "absolute", "left": ml, "top": mt })
                .outerWidth(leftWidth)
                .outerHeight(25);
            $("#leftDataPanel")
                .css({ "position": "absolute", "left": ml, "top": 25 + 2 * mt })
                .outerWidth(leftWidth)
                .outerHeight(bodyHeight - 3 * mt - 25);
            //组筛选按钮
            CreateGroupSearchButton();
            //角色名称回车筛选
            $("#txtGroupName").keypress(function (e) {
                var k = e.which;
                if (k == 13) {
                    $(szdwGroupSearchButton.button).trigger("click");
                }
            });
            //初始加载结果数据
            GetGroupList();
        }
        
        var szdwGroupSearchButton = null;
        function CreateGroupSearchButton() {
            var nc = $("#txtGroupName").parent();
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = btnHeight;
            szdwGroupSearchButton = new SzdwButton(p, x, y, w, h);
            szdwGroupSearchButton.namingContainer = nc;
            szdwGroupSearchButton.imageWidth = btnImageWidth;
            szdwGroupSearchButton.image = imgFile.query;
            szdwGroupSearchButton.title = "组名称筛选";
            szdwGroupSearchButton.Load();

            //单击事件
            var btn = szdwGroupSearchButton.button;
            $(btn).click(function (e) {
                szdwGroup.paramJson["name"] = $("#txtGroupName").val();
                szdwGroup.DataBind();
                e.stopPropagation();
            });
        }

        function GetGroupList() {
            var c = $("#leftDataPanel");
            var position = "absolute";
            var x = 0;
            var y = 0;
            var w = c.width();
            var h = c.height();
            //创建Gridview并绑定数据
            CreateGroupGridView(c, position, x, y, w, h);
        }

        function GetGroupParamJson() {
            var xuserId = xuserId;
            var groupName = $.trim($("#txtGroupName").val());
            var paramJson = { xuserId: xuserId };

            if (groupName.length > 0) {
                paramJson["name"] = groupName;
            }

            return paramJson;
        }

        var szdwGroup = null;
        function CreateGroupGridView(namingContainer, position, x, y, width, height) {
            if (szdwGroup == null || typeof (szdwGroup) == "undefined") {
                //创建SzdwGridViewt实例
                szdwGroup = new SzdwGridView(position, x, y, width, height);
                szdwGroup.namingContainer = namingContainer;
                szdwGroup.fnInitial = InitialSzdwGroup(szdwGroup);
                szdwGroup.fnRowClick = SzdwGroupRowClick;
                szdwGroup.fnDataBindCallBack = InitialRowClick;
            }

            //异步加载数据
            if (szdwGroup.pagination != null) {
                szdwGroup.pagination.ResetBar();
            }

            var paramJson = GetGroupParamJson();
            paramJson["pageSize"] = szdwGroup.pageSize;
            paramJson["MethodName"] = "GroupOnlyGetList";
            szdwGroup.requestUrl = "../Group/GroupProcess.ashx";
            szdwGroup.paramJson = paramJson;
            szdwGroup.DataBind();
        }

        function InitialSzdwGroup(szdwGroup) {
            //个性样式设置    
            szdwGroup.dataPanelCssJson = { "background-color": "White", "border": "1px solid Silver" };
            szdwGroup.paginationCssJson = { "background-color": "White", "font-family": "微软雅黑", "font-size": "small", "border": "1px solid Silver", "border-top": "0px" };
            szdwGroup.minHeight = 300;
            szdwGroup.allowRowClickEvent = true;

            //dataPanel设置
            szdwGroup.hasSumRow = false;
            szdwGroup.hasPagination = false;
            szdwGroup.hasButtonPanel = true;
            szdwGroup.pageSize = 1000;

            //head设置
            szdwGroup.headCssName = "gridHead2";
            szdwGroup.headHeight = 30;
            szdwGroup.fieldJsonData = [{ "Field": "RowNumber", "Text": "序号", "Width": 40 },
                                       { "Field": "Name", "Text": "组名称", "Width": 200, "OrderField": "Name" },
                                       { "Field": "Memo", "Text": "组描述", "Width": 120 }];

            szdwGroup.cellCssJson = {
                "Name": { "text-align": "left" },
                "Memo": { "text-align": "left" }
            };
        }

        function SzdwGroupRowClick(rowIndex) {
            var jsonList = szdwGroup.recordSetJson;
            if (jsonList) {
                var jsonData = jsonList[rowIndex];
                var groupId = jsonData.Id;
                if (szdwXg) {
                    szdwXg.paramJson["groupId"] = groupId;
                    szdwXg.paramJson["group"] = jsonData.Name;
                    szdwXg.DataBind();
                }
            }
        }

        function InitialRowClick() {
            $(szdwGroup.bodyRows[0]).trigger("click");
        }

        //#endregion

        //#region 右面板
        function SetRightPanel() {
            $("#rightFilterPanel")
                .css({ "position": "absolute", "left": leftWidth + 2 * ml, "top": mt })
                .outerWidth(bodyWidth - 320 - 3 * ml)
                .outerHeight(25);
            $("#rightDataPanel")
                .css({ "position": "absolute", "left": leftWidth + 2 * ml, "top": 25 + 2 * mt })
                .outerWidth(bodyWidth - 320 - 3 * ml)
                .outerHeight(bodyHeight - 3 * mt - 25);
            //组筛选控件加载
            CreateXuserGroupFilter();
            //初始加载结果数据
            GetXuserGroupList();
        }

        function CreateXuserGroupFilter() {
            BindDdlAssingType();
            CreateXuserGroupSearchButton();
            //组名称回车筛选
            $("#txtXuserName").keypress(function (e) {
                var k = e.which;
                if (k == 13) {
                    $(szdwXuserGroupSearchButton.button).trigger("click");
                }
            });
        }

        function BindDdlAssingType() {
            var jsonList = [{ Id: 1, Name: "已添加" }, { Id: 2, Name: "未添加" }];
            var paramDdl = { jsonList: jsonList, fnInitial: InitialDdl };
            $("#ddlAssignType").dropDownList(paramDdl);
            $("#ddlAssignType").text("全部").data("value", 0);
        }

        function InitialDdl(szdwDdl) {
            szdwDdl.jsonItemAll = { Id: 0, Name: "全部" };
            szdwDdl.fnItemClick = RefreshSzdwXuserGroup;
        }

        function RefreshSzdwXuserGroup() {
            $(szdwXuserGroupSearchButton.button).trigger("click");
        }

        var szdwXuserGroupSearchButton = null;
        function CreateXuserGroupSearchButton() {
            var nc = $("#txtXuserName").parent();
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = btnHeight;
            szdwXuserGroupSearchButton = new SzdwButton(p, x, y, w, h);
            szdwXuserGroupSearchButton.namingContainer = nc;
            szdwXuserGroupSearchButton.imageWidth = btnImageWidth;
            szdwXuserGroupSearchButton.image = imgFile.query;
            szdwXuserGroupSearchButton.title = "用户名称筛选";
            szdwXuserGroupSearchButton.Load();

            //单击事件
            var btn = szdwXuserGroupSearchButton.button;
            $(btn).click(function (e) {
                szdwXg.paramJson["assignType"] = $("#ddlAssignType").data("value");

                szdwXg.paramJson["name"] = null;
                szdwXg.paramJson["nameCN"] = null;

                var name = $.trim($("#txtXuserName").val());
                var reg = /[\u4e00-\u9fa5]/;
                if (reg.test(name)) {
                    szdwXg.paramJson["nameCN"] = $("#txtXuserName").val();
                } else {
                    szdwXg.paramJson["name"] = $("#txtXuserName").val();
                }

                szdwXg.DataBind();
                e.stopPropagation();
            });
        }

        function GetXuserGroupList() {
            var c = $("#rightDataPanel");
            var position = "absolute";
            var x = 0;
            var y = 0;
            var w = c.width();
            var h = c.height();
            //创建Gridview并绑定数据
            CreateXgGridView(c, position, x, y, w, h);
        }

        function GetXgParamJson() {
            var xuserId = xuserId;
            var xuserName = $.trim($("#txtXuserName").val());
            var paramJson = { xuserId: xuserId };

            if (name.length > 0) {
                paramJson["xuserName"] = xuserName;
            }
            return paramJson;
        }

        var szdwXg = null;
        function CreateXgGridView(namingContainer, position, x, y, width, height) {
            if (szdwXg == null || typeof (szdwXg) == "undefined") {
                //创建SzdwGridViewt实例
                szdwXg = new SzdwGridView(position, x, y, width, height);
                szdwXg.namingContainer = namingContainer;
                szdwXg.fnInitial = InitialSzdwXg(szdwXg);
            }

            //异步加载数据
            if (szdwXg.pagination != null) {
                szdwXg.pagination.ResetBar();
            }

            var paramJson = GetXgParamJson();
            paramJson["pageSize"] = szdwXg.pageSize;
            paramJson["MethodName"] = "XuserGroupGetList";
            szdwXg.requestUrl = "XuserGroupProcess.ashx";
            szdwXg.paramJson = paramJson;
            szdwXg.DataBind();
        }

        function InitialSzdwXg(szdwXg) {
            //个性样式设置    
            szdwXg.dataPanelCssJson = { "background-color": "White", "border": "1px solid Silver" };
            szdwXg.paginationCssJson = { "background-color": "White", "font-family": "微软雅黑", "font-size": "small", "border": "1px solid Silver", "border-top": "0px" };
            szdwXg.minHeight = 300;

            //dataPanel设置
            szdwXg.hasSumRow = false;
            szdwXg.hasButtonPanel = true;
            szdwXg.freezeCols = 2;
            szdwXg.scrollKeeingType = 1;

            //head设置 
            szdwXg.headCssName = "gridHead2";
            szdwXg.headHeight = 30;
            szdwXg.fieldJsonData = [{ "Field": "RowNumber", "Text": "序号", "Width": 50 },
                                    { "Field": "XuserName", "Text": "用户名称", "Width": 100, "OrderField": "XuserName" },
                                    { "Field": "XuserNameCN", "Text": "中文姓名", "Width": 100, "OrderField": "XuserNameCN" },
                                    { "Field": "AssignGroup", "Text": "添加用户到组", "Width": 280, "FnControlColumn": CreateCellControl, "Style": { "text-align": "center", "color": "red" } },
                                    { "Field": "Memo", "Text": "用户描述", "Width": 120 }
            ];

            szdwXg.cellCssJson = {
                "Memo": { "text-align": "left" },
                "AssignGroup": { "text-align": "left" }
            };
        }

        function CreateCellControl(jsonList, cell) {
            var rowIndex = $(cell).data("rowIndex");
            var isAssigned = jsonList[rowIndex].IsAssigned;
            var userId = jsonList[rowIndex].XuserId;

            //列中的控件box
            var c = document.createElement("div");
            $(c).css({ "height": 25, "line-height": "25px" });

            //checkbox
            var chk = document.createElement("input");
            $(chk).attr("type", "checkbox").attr("id", "chkRole").attr("disabled", true);
            $(chk).css({ "float": "left", "height": 18, "line-height": "18px" });
            $(chk).prop("checked", isAssigned);

            var s = document.createElement("label");
            $(s).css({ "float": "left", "height": 25, "line-height": "25px" });
            var group = szdwXg.paramJson["group"];
            if (isAssigned) {
                $(s).text("已添加到组:" + group);
                $(s).css("color", "red");
            }

            $(c).append(chk).append(s);

            //按钮
            if (permission.insertPermission && permission.deletePermission && permission.modifyPermission) {
                var btn = document.createElement("input");
                $(btn).attr("type", "button").addClass("button2");
                $(btn).css({ "float": "right", "width": 45, "height": 25 });
                var text = isAssigned ? "移除" : "添加";
                $(btn).val(text);
                $(btn).val(text).appendTo(c);

                if (xuserId == userId) {
                    $(btn).attr("disabled", true);
                } else {
                    //绑定事件
                    $(btn).click(function () {
                        if (isAssigned) {
                            var groupId = jsonList[rowIndex].GroupId;
                            var paramJson = { xuserId: userId, groupId: groupId };
                            XuserGroupDelete(paramJson);
                        } else {
                            var creatorId = xuserId;
                            var groupId = szdwXg.paramJson["groupId"];
                            var paramJson = { xuserId: userId, groupId: groupId, creatorId: creatorId };
                            XuserGroupInsert(paramJson);
                        }
                    });
                }
            }

            return c;
        }
        function XuserGroupInsert(paramJson) {
            var objDataBind = szdwXg;
            var requestUrl = "XuserGroupProcess.ashx";
            paramJson["MethodName"] = "XuserGroupInsert";
            SzdwAjaxDataOperate.ajaxInsert(objDataBind, requestUrl, paramJson);
        }

        //移除用户
        function XuserGroupDelete(paramJson) {
            var objDataBind = szdwXg;
            var requestUrl = "XuserGroupProcess.ashx";
            paramJson["MethodName"] = "XuserGroupDelete";
            SzdwAjaxDataOperate.ajaxDelete(objDataBind, requestUrl, paramJson);
        }
        //#endregion
    </script>
</body>
</html>