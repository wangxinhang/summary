<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title></title>
    <link href="../Styles/Query.css" rel="stylesheet" type="text/css" />
    <link href="../Styles/ScrollBar.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="../SzdwControls/domCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCheckBoxList.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwAjaxDataOperate.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwOnOff.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCommon.js" type="text/javascript"></script>
</head>
<body> 
    <form action="">
        <div id="operatePanel">
            <div id="basicInfoTitle" class="groupTitle" style="cursor:pointer;">
                <label>可用权限列表</label>
                <div id="expBasic" style="float:right"></div>
            </div>
            <div id="basicInfoGroup" class="groupPanel"></div>
        </div>
        <div id="buttonPanel">
            <input id="btnCancel" type="button" value="取消" class="pwButton2" style="float:right;"/>
            <input id="btnSave" type="button" value=" 保存" class="pwKeyButton2" style="float:right"/>
        </div>          
    </form>
      
    <script type="text/javascript">
        //#region 全局变量
        var permission = null; 
        var bodyWidth = $(document).width();
        var bodyHeight = $(document).height();
        var ml = 10; mt = 10; btnHeight = 32; btnPanelHeight = 35;
        var panelWidth = bodyWidth - ml * 2;
        //#endregion 全局变量

        //#region 网页加载 
        $(document).ready(function () {
            //设置录入面板
            SetOperatePanel();

            //设置按钮面板
            SetButtonPanel();

            //窗口调整大小
            $(window).resize(function () {
                var pw = parent.document.body.popupWindow;
                SzdwCommon.rePositionButtonPanel(pw, $("#buttonPanel"));
                SzdwCommon.reSizeOperatePanel(pw, $("#operatePanel"), $("#buttonPanel"));
            });
        });
        //#endregion 网页加载  

        //#region 数据操作面板

        //#region 设置面板
        function SetOperatePanel() {
            //#region 设置面板
            var p = $("#operatePanel");
            var x = 0;
            var y = 0;
            var w = bodyWidth - x * 2;
            var h = bodyHeight - btnPanelHeight;
            $(p).addClass("queryPanel").css({ "left": x, "top": y, "min-width": 0, "margin-bottom": "3px", "padding": "0px 0px 15px 0px", "overflow": "hidden" }).outerWidth(w).outerHeight(h, true);

            var cw = w - ml * 2;
            $(".cellDiv").outerWidth(cw);

            //设置滚动条
            $(p).addClass("scrollBar2");
            $(p).mouseover(function () {
                $(this).css({ "overflow-y": "auto" });
            }).mouseleave(function () {
                $(this).css({ "overflow-y": "hidden" });
            });

            //#endregion 设置面板

            //#region 信息分组 

            //基本信息
            SetBasicInfoTitle();
            SetBasicInfoGroup();
            //#endregion 信息分组 

            //#region 加载权限列表
            LoadSzdwChkl();
            //#endregion 加载权限CheckBoxList 
        }
        //#endregion 设置面板        

        //#region 信息分组

        //#region 列表标题
        function SetBasicInfoTitle() {
            var p = $("#basicInfoTitle");
            var x = 0;
            var y = 0;
            var w = bodyWidth;
            $(p).css({ "position": "relative", "left": x, "top": y }).outerWidth(w);

            //绑定事件
            $(p).click(function () {
                szdwExpBasic.Click();
            }).mouseover(function () {
                if (szdwExpBasic.onOff) szdwExpBasic.Show();
            }).mouseleave(function () {
                if (szdwExpBasic.onOff) szdwExpBasic.Hide();
            });

            //加载组显隐开关
            LoadSzdwExpBasic();
        }
        //#endregion 列表标题   

        //#region 列表显隐
        var szdwExpBasic = null;
        function LoadSzdwExpBasic() {
            if (!szdwExpBasic) {
                var p = "relative";
                var x = 0;
                var y = 0;
                var w = 56;
                var h = 22;
                szdwExpBasic = new SzdwOnOff(p, x, y, w, h);
                szdwExpBasic.namingContainer = $("#expBasic");
                szdwExpBasic.visible = false;
                szdwExpBasic.onOff = true;
                szdwExpBasic.backColorOn = parent.themeColor ? parent.themeColor : parent.parent.themeColor;
                szdwExpBasic.fnClickCallBack = FnExpBasic;
                szdwExpBasic.Load();
            }
        }

        //显隐回调函数
        function FnExpBasic() {
            var g = $("#basicInfoGroup");
            $(g).slideToggle(300, null, function () { InfoGroupScroll(g); });
        }
        //#endregion 列表显隐

        //#region 列表组
        function SetBasicInfoGroup() {
            $("#basicInfoGroup").css({ "position": "relative" }).outerWidth(bodyWidth);
        }

        //#endregion 列表组    
        
        //#region 滚动组到完全可视位置
        function InfoGroupScroll(objGroup) {
            var g = objGroup;
            var p = $("#operatePanel");
            var ph = $(p).height();
            var y = $(g).offset().top;
            var h = $(g).outerHeight();
            var oh = h - (ph - y);
            oh = oh > ph ? ph : oh;
            var st = $(p).scrollTop() + oh;
            $(p).animate({ scrollTop: st }, 300);
        }
        //#endregion 滚动组到完全可视位置

        //#endregion 信息分组   

        //#region 权限列表

        //#region 加载权限列表
        var szdwChkl = null;
        function LoadSzdwChkl() {
            var p = $("#basicInfoGroup");
            var jsonList = $.parseJSON(SzdwCommon.getQueryString("paramJson"));
            if (!szdwChkl) {
                szdwChkl = CreateCheckBoxList(jsonList, p);
                $(p).append(szdwChkl);
            }
            var ph = $(szdwChkl.panel).outerHeight();
            $(p).height(ph).css({ "padding-top": 0, "padding-bottom": 0 });
        }
        //#endregion 加载权限列表

        //#region 创建权限列表控件
        function CreateCheckBoxList(jsonList, namingContainer) {
            //#region 位置宽高属性
            var c = namingContainer;
            var position = "relative";
            var cw = $(c).width();
            var ch = $(c).height();
            var w = cw;
            var h = 0;
            var x = 0;
            var y = 0;
            //#endregion 位置宽高属性

            //#region 创建CheckBoxList
            var szdwChkl = new SzdwCheckBoxList(position, x, y, w, h);
            szdwChkl.namingContainer = c;
            szdwChkl.backgroundColor = "transparent";
            szdwChkl.direction = 1;
            szdwChkl.opacity = 1;
            szdwChkl.allowLeastOne = false;
            szdwChkl.itemCssJson["opacity"] = 1;
            szdwChkl.itemHoverCssJson = { "background-color": "#666666", "opacity": 0.8 };
            szdwChkl.panelCssJson["float"] = "left";
            if (jsonList[0].Operation) {
                szdwChkl.hasTitle = false;
                szdwChkl.fieldText = "Operation";
                szdwChkl.fieldValue = "Permissable";
            } else {
                szdwChkl.hasTitle = true;
                szdwChkl.titleHeight = 20;
                szdwChkl.titleText = jsonList[0].Department + " 的授权情况:";
                szdwChkl.titleTextCssJson["padding-left"] = "10px";
                szdwChkl.separatorMargin = 0;
                szdwChkl.separatorCssJson["opacity"] = 0;
            }
            szdwChkl.jsonList = jsonList;
            szdwChkl.Load();
            //#endregion 创建CheckBoxList

            return szdwChkl;
        }
        //#endregion 创建权限列表控件

        //#endregion 权限列表 
        
        //#endregion 数据操作面板

        //#region 按钮面板

        //#region 设置按钮面板
        function SetButtonPanel() {
            var p = $("#buttonPanel");
            var w = bodyWidth;
            var h = btnPanelHeight;
            var x = 0;
            var y = bodyHeight - h - 2;
            $(p).css({ "position": "relative", "left": x, "top": y, "padding": "5px 10px 0px 5px" });
            $(p).outerWidth(w).outerHeight(h);

            //按钮事件绑定
            ButtonHandler();
        }
        //#endregion 设置按钮面板        
        
        //#region 按钮事件
        function ButtonHandler() {
            $("#btnSave").click(function () {
                //更新选择后的可用权限
                var chklJsonList = szdwChkl.jsonList;
                var chklArray = szdwChkl.checkBoxArray;
                var pt = chklJsonList[0].Operation ? 1 : 2;
                var opList = new Array();
                var rdJson = null;
                if (pt == 1) {
                    for (i = 0; i < chklJsonList.length; i++) {
                        var checked = $(chklArray[i]).prop("checked");
                        if (chklJsonList[i]["Permissable"] != checked) {
                            chklJsonList[i]["Permissable"] = checked;
                            opList.push(chklJsonList[i]);
                        }
                    }
                } else {
                    rdJson = { RoleId: chklJsonList[0].RoleId, DepartmentId: chklJsonList[0].DepartmentId, CreatorId: chklJsonList[0].CreatorId,
                        Permissable: chklArray[0].checked, IsIncludingChildren: chklArray[1].checked
                    };

                }
                var creatorId = parent.xuserId;
                var objDataBind = parent.szdwGvRp;
                var requestUrl = "RolePermissionProcess.ashx";
                var paramJson = null;
                if (pt == 1) {
                    var operationList = $.toJSONString(opList);
                    paramJson = { jsonList: operationList, MethodName: "RolePermissionOperate" }
                } else {                    
                    var rdJsonData = $.toJSONString(rdJson);
                    paramJson = { jsonData: rdJsonData, MethodName: "RoleDepartmentOperate" };
                }
                SzdwAjaxDataOperate.ajaxDataOperateIgnoreReturnValue(objDataBind, requestUrl, paramJson, OperateCallBack);
            });

            $("#btnCancel").click(function () {
                parent.document.body.popupWindow.Hide();
                parent.szdwGvRp.RecoverSelectedRow();
            });
        }

        //回调函数
        function OperateCallBack() {
            parent.document.body.popupWindow.Hide();
            parent.szdwGvRp.RecoverSelectedRow();
        }
        //#endregion 按钮事件 

        //#endregion 按钮面板
    </script>
</body>
</html>