<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
    <title></title>
    <link href="../Styles/Page.css" rel="stylesheet" type="text/css" />
    <link href="../Styles/Query.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwAjaxDataOperate.js" type="text/javascript"></script>
    <script src="../SzdwControls/domCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwGridView.js" type="text/javascript"></script>
    <link href="../SzdwControls/SzdwGridView.css" rel="stylesheet" type="text/css" />
    <script src="../SzdwControls/SzdwPagination.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwButton.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwDropDownList.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwTree.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCommon.js" type="text/javascript"></script>
</head>
<body style="background-color: #EEEEEE">
    <div id="typePanel" style="position:absolute;left:10px;top:10px;background-color:White;font-family:微软雅黑;font-size:small;">
        <input id="ddlDepartmentType" type="text" class="dropDownList" style="width: 186px;"/>
    </div>
    <div id="departmentPanel" style="position:absolute;left:10px;top:45px;background-color:White;border:1px solid silver;font-family:微软雅黑;font-size:small;"></div>
    <div id="searchPanel" style="position:absolute;left:10px;top:10px;font-family:微软雅黑;font-size:small;">
        <input id="txtName" type="text" class="textBox2" style="width:144px; height:24px;border-right:0px;" />
    </div>
    <div id="employeePanel" style="position:absolute;top:45px;background-color:White;border:1px solid silver;font-family:微软雅黑;font-size:small;"></div>
    <script type="text/javascript">
        //#region 全局变量
        var xuserId, xmenuId, permission = null; //用户及权限：json格式
        var bodyWidth = $(document.body).width();
        var bodyHeight = $(document.body).height();
        var ml = 10; mt = 10; //ml:margin-left;mt:margin-top;
        var btnWidth = 90; btnHeight = 30; btnImageWidth = 26; //btnWidth:按钮宽;btnHeight:按钮高;btnImageWidth:按钮图片宽
        var panelWidth = bodyWidth - ml * 2; //面板宽度
        var panelMinWidth = 240; //面板最小宽度
        var noticeId = "";
        var receiversId = "";
        var receivers = "";
        var receiversIdAry = [];
        var receiversAry = [];
        var departmentId = 0;
        var departmentTypeId = 0;
        var id;
        var name;
        //#endregion 全局变量

        $(document).ready(function () {
            //获取用户Id和MenuId
            xuserId = parent.xuserId;
            var qsJson = JSON.parse(SzdwCommon.getQueryString("paramJson"));
            id = qsJson.id;
            name = qsJson.name;
            //设置查询面板
            SetPanel();
            bindDdlDepartmentType();
            CreateSearchButton();
            GetQueryResult();
            $("#txtName").keypress(function (e) {
                var k = e.which;
                if (k == 13) {
                    var btnPanel = szdwSearchButton.button;
                    $(btnPanel).trigger("click");
                }
            });
            //窗口调整大小
            $(window).resize(function () {
                var body = document.body;
                bodyWidth = $(body).width();
                bodyHeight = $(body).height();
                SetPanel();
                if (szdwTreeLeft) {
                    szdwTreeLeft.Resize(190-2, bodyHeight-56);
                }
                if (szdwGv) {
                    szdwGv.Resize(bodyWidth-190-30, bodyHeight-54+2);
                }
            });
        });

        function SetPanel() {
            var h = bodyHeight - 20;
            var w = bodyWidth - 30 - 190;
            $("#departmentPanel").outerWidth(190).outerHeight(h-36);
            $("#searchPanel").css({"left":210,"top":10}).outerWidth(w).outerHeight(26);
            $("#employeePanel").css({ "left": 210,"top":45 }).outerWidth(w).outerHeight(h-36);
        }

        function bindDdlDepartmentType() {
            $.ajax({
                url: "../Department/DepartmentTypeHandler.ashx",
                type: "post",
                data: {
                    MethodName: "GetDepartmentTypeNameList"
                },
                dataType: "json",
                success: function (jsData) {
                    if (jsData instanceof Array) {
                        var jsonList = new Array();
                        var len = jsData.length;
                        for (var i = 0; i < len; i++) {
                            jsonList.push({ Id: jsData[i].Id, Name: jsData[i].Name });
                        }
                        var paramDdl = { jsonList: jsonList, fnInitial: InitialDdlDepartmentType };
                        $("#ddlDepartmentType").dropDownList(paramDdl);
                        $("#ddlDepartmentType").val(jsonList[0].Name).data("value", jsonList[0].Id);
                        loadDepartmentTree(jsonList[0].Id);
                    }
                }
            });
        }
        function InitialDdlDepartmentType(szdwDdl) {
            szdwDdl.nonCascadeItemLength = 20;
            szdwDdl.fnItemClick = function () {
                departmentTypeId = $("#ddlDepartmentType").data("value");
                if (szdwTreeLeft){
                    szdwTreeLeft.paramJson["departmentTypeId"] = departmentTypeId;
                    szdwTreeLeft.ClearData();
                    szdwTreeLeft.Update();
                }
                //loadDepartmentTree(departmentTypeId);
                if (szdwGv) {
                    szdwGv.paramJson["departmentTypeId"] = departmentTypeId;
                    szdwGv.DataBind();
                }
            }
        }

        var szdwTreeLeft = null;
        function loadDepartmentTree(departmentTypeId) {
            var nc = $("#departmentPanel");
            var requestUrl = "../Department/DepartmentHandler.ashx";
            var position = "absolute";
            var paramJson = { departmentTypeId: departmentTypeId, MethodName: "GetDepartmentListByDepartmentTypeId" };
            var x = -1;
            var y = -1;
            var h = bodyHeight - 56;
            var w = 190-2;
            if (szdwTreeLeft == null || typeof (szdwTreeLeft) == "undefined") {
                szdwTreeLeft = new SzdwTree(position, x, y, w, h);
                szdwTreeLeft.namingContainer = nc;
            }

            szdwTreeLeft.requestUrl = requestUrl;
            szdwTreeLeft.paramJson = paramJson;
            szdwTreeLeft.hasSearchBox = 0;
            szdwTreeLeft.itemCssJson = {
                "font-size": "10pt",
                "background-color": "transparent",
            };
            szdwTreeLeft.fnItemClick = function (i) {
                var item = szdwTreeLeft.jsonList[i];
                departmentId = item.Id;
                var name = $.trim($("#txtName").val());
                if (szdwGv) {
                    szdwGv.paramJson["departmentId"] = departmentId;
                    szdwGv.paramJson["partName"] = name;
                    szdwGv.paramJson["partPinyin"] = name;
                    szdwGv.DataBind();
                }
            };
            szdwTreeLeft.ClearData();
            szdwTreeLeft.DataBind();
        }
        var szdwSearchButton = null;
        function CreateSearchButton() {
            var nc = $("#txtName").parent()
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = 26;
            szdwSearchButton = new SzdwButton(p, x, y, w, h);
            szdwSearchButton.namingContainer = nc;
            szdwSearchButton.imageWidth = btnImageWidth;
            szdwSearchButton.image = "../Image/query20b.png";
            szdwSearchButton.title = "员工名称筛选";
            szdwSearchButton.Load();

            //单击事件
            var btn = szdwSearchButton.button;
            $(btn).click(function (e) {
                var name = $.trim($("#txtName").val());
                szdwGv.paramJson["partName"] = name;
                szdwGv.paramJson["partPinyin"] = name;
                szdwGv.DataBind();
                e.stopPropagation();
            });
        }
        //查询按钮事件
        function GetQueryResult() {
            //设置结果面板相关属性
            var body = document.body;
            var c = $("#employeePanel");
            var position = "absolute";
            var x = -1;
            var y = -1;
            var w = $(c).width()+2;
            var h = $(c).height()+2;

            //创建Gridview并绑定数据
            CreateGridView(c, position, x, y, w, h);
        }

        //#region 获取查询参数
        function GetParamJson() {
            var departmentTypeId = $("#ddlDepartmentType").data("value");
            var name = $("#txtName").val();
            var paramJson = {
                xuserId: xuserId,
                departmentTypeId: departmentTypeId,
                departmentId: departmentId,
                partName: name,
                partPinyin: name,
                isMix:1,
                MethodName: "GetEmployeeNameListByDepartmentAndPartNameForGV",
                pageSize:15
            };
            return paramJson;
        }
        //#endregion 获取查询参数

        var szdwGv = null;
        function CreateGridView(namingContainer, position, x, y, width, height) {
            if (szdwGv == null || typeof (szdwGv) == "undefined") {
                //创建SzdwGridViewt实例
                szdwGv = new SzdwGridView(position, x, y, width, height);
                szdwGv.namingContainer = namingContainer;
                szdwGv.fnInitial = InitialGridview(szdwGv);
                szdwGv.fnRowClick = SzdwRowClick;
            }

            //异步加载数据
            if (szdwGv.pagination != null) {
                szdwGv.pagination.ResetBar();
            }

            var paramJson = GetParamJson();
            szdwGv.requestUrl = "../Employee/EmployeeHandler.ashx";
            szdwGv.paramJson = paramJson;
            szdwGv.DataBind();
        }
        function InitialGridview(szdwGv) {
            //个性样式设置
            szdwGv.dataPanelCssJson = { "background-color": "White", "border": "1px solid Silver" };
            szdwGv.paginationCssJson = { "background-color": "White", "font-family": "微软雅黑", "font-size": "small", "border": "1px solid Silver", "border-top": "0px" };

            //dataPanel设置
            szdwGv.hasSumRow = false;
            szdwGv.allowRowClickEvent = true;
            //head设置
            szdwGv.headCssName = "gridHead2";
            szdwGv.headHeight = 30;
            szdwGv.pageSize = 1000;
            szdwGv.hasPagination = false;
            szdwGv.hasSumRow = false;
            szdwGv.hasButtonPanel = true;
            szdwGv.fieldJsonData = [
                { "Field": "Name", "Text": "人员姓名", "Width": 150, "OrderField": "Name" }
            ];
            szdwGv.cellCssJson = {
                "Name": { "text-align": "left", "font-size": "small", "font-family": "宋体" }
            };
        }
        //#endregion 查询结果

        //#region 行单击事件
        function SzdwRowClick(rowIndex) {
            var jsonData = szdwGv.recordSetJson[rowIndex];
            var pagePanel = $(parent.document.body.popupWindow.pagePanel.contentWindow.document.body);
            pagePanel.find("#txtName").val(jsonData.PinYin);
            pagePanel.find("#hdnId").val(jsonData.Id);
            pagePanel.find("#txtNameCN").val(jsonData.Name);
            pagePanel.find("#ddlDepartment").val(jsonData.Department);
            parent.document.body.popupWindow.pagePanel.contentWindow.jQuery("#ddlDepartment").data("value",jsonData.DepartmentId);//, 
            $(parent.document.body.opEQuery.btnClose).trigger("click")
        }
        //#endregion 行单击事件

        //#endregion 结果集面板

    </script>
</body>
</html>