<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title></title>
    <link href="../Styles/Page.css" rel="stylesheet" type="text/css" />
    <link href="../Styles/ScrollBar.css" rel="stylesheet" type="text/css" />
    <link href="../Styles/Query.css" rel="stylesheet" type="text/css" />    
    <script src="../Scripts/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="../SzdwControls/domCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwMenu.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwDropDownList.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwGridView.js" type="text/javascript"></script>
    <link href="../SzdwControls/SzdwGridView.css" rel="stylesheet" type="text/css" />
    <script src="../SzdwControls/SzdwPagination.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwButton.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwPopupWindow.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwAjaxDataOperate.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwTabButtonList.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCommon.js" type="text/javascript"></script>
    <script src="../Scripts/CommonJScript.js" type="text/javascript"></script>
    <script src="../Scripts/myparm.js" type="text/javascript"></script>
</head>
<body style="background-color:#EEEEEE">
    <form action="">
        <div id="leftPanel" style="background-color:#000000;">
            <div id="moveBtnPanel" style="height:24px;padding:10px 0px 10px 0px;border-bottom:0px solid #333333">
                <div id="upPanel" class="cellDiv" style="padding:0px 10px 0px 10px;"></div>
                <div id="downPanel" class="cellDiv" style="padding:0px 10px 0px 10px"></div>            
            </div>
            <div id="menuPanel"></div>
        </div> 
        <div id="rightPanel" class="queryPanelNew" style="padding:10px 20px 20px 20px;border:1px solid silver;border-left:0px;">
            <div id="rowTab" style="margin-bottom:20px;height:32px;border-bottom:1px solid #EFEFEF"></div>
            <div id="rowInsertUpdate">
                <div id="rowName" style="margin-bottom:20px;height:24px;display:block;">
                    <div id="cellIu00" class="cellDiv">
                        <label for="txtName" class="label" style="line-height:28px;">菜单名称：</label>
                        <input id="txtName" type="text" class="textBox2" style="width:350px;height:28px;" />
                    </div>
                    <div id="cellIu01" class="cellDiv"></div>
                </div>
                <div id="rowMemo" style="margin-bottom:20px;padding-bottom:10px;height:50px;display:block;">
                    <div id="cellIu10" class="cellDiv">
                        <label for="txtMemo" class="label" style="line-height:28px;">菜单描述：</label>
                        <textarea id="txtMemo" rows="2" cols="1" class="textBox2" style="width:350px;height:50px;"></textarea>
                    </div>
                    <div id="cellIu11" class="cellDiv">
                    </div>
                </div>
            </div> 
            <div id="rowInsertPlus">
                <div style="margin-bottom:20px;height:28px;display:block;">
                    <div id="cellIp00" class="cellDiv">
                        <label for="ddlParent" class="label" style="line-height:28px;">上级菜单：</label>
                        <input id="ddlParent" class="dropDownList" style="width:352px;height:28px;"/>
                    </div>
                    <div id="cellIp01" class="cellDiv"></div>
                </div>
            </div>
            <div id="rowIconPage">            
                <div id="rowIcon" style="height:64px;">
                    <div id="cellImage" class="cellDiv" > </div>
                    <div id="cellCp00" class="cellDiv">
                        <label  id="lblIcon" class="label" style="line-height:28px;">菜单图标：</label>
                        <input id="txtIcon" type="text" class="textBox2" disabled="disabled" style="width:350px;height:28px;" />
                        <div id="iconSetting"></div>
                    </div>
                    <div id="cellCp01" class="cellDiv" style="padding-left:5px"></div>
                    <div id="iconBox" style="float:left;background-color:black;border:1px solid black;margin-left:5px;">
                        <div id="imgIcon" style="width:64px;height:64px;"></div>
                    </div>
                </div>
                <div id="rowXpage" style="display:none;margin-top:20px;height:28px;">
                    <div id="cellCp10" class="cellDiv" >
                        <label for="txtPage" class="label" style="line-height:28px;">关联页面：</label>
                        <input id="txtPage" type="text" class="textBox2" disabled="disabled" style="width:350px;height:28px;" />
                    </div>
                    <div id="cellCp11" class="cellDiv" style="padding-left:5px"></div>
                </div>
                <div id="rowOperation" style="margin-top:20px;padding-top:10px;border-top:1px solid #EEEEEE">                    
                    <div id="cellOp00" class="cellDiv"></div>
                </div>
            </div>
        </div>
    </form>
    <script type="text/javascript">
        //#region 全局变量
        var xuserId,xmenuId,permission = null;//用户及权限：json格式 
        var leftWidth = 200,btnWidth=25;
        //#endregion 全局变量

        $(document).ready(function () {    
            //获取用户Id和MenuId
            var paramJson = SzdwCommon.getJsonParm();
            xuserId = paramJson.xuserId;
            xmenuId = paramJson.xmenuId;
            permission = SzdwCommon.getPermission(paramJson.permissionJsonList);
            bodyWidth = Math.max($(document.body).width(), minWidth);
            bodyHeight = Math.max($(document.body).height(), minHeight);
                    
            //设置查询面板
            SetLeftPanel();

            //设置结果面板
            SetRightPanel();

            //窗口调整大小
            $(window).resize(function () {
                bodyWidth = Math.max($(document.body).width(), minWidth);
                bodyHeight = Math.max($(document.body).height(), minHeight);
                ResizeControls();
            });
        });

        //#region 位置尺寸
        //重设网页元素尺寸
        function ResizeControls() {
            $("#leftPanel").outerHeight(bodyHeight - 2 * mt);
            $("#rightPanel").outerWidth(bodyWidth-leftWidth-2*ml).outerHeight(bodyHeight-2*mt);
            if (szdwMenu) {
                szdwMenu.Resize(leftWidth, bodyHeight - 2 * mt);
            }
        }
        //#endregion
        //#region 左面板
        //#region 设置左面板
        function SetLeftPanel() {
            var lp = $("#leftPanel");           
            var x = ml;
            var y = mt;
            var h = bodyHeight - y - mt;
            var lpCssJson = { "position": "absolute", "left": x, "top": y };
            $(lp).css(lpCssJson).outerWidth(leftWidth).outerHeight(h);
            $("#moveBtnPanel").outerWidth(leftWidth);
            $("#upPanel").outerWidth(leftWidth / 2);
            $("#downPanel").outerWidth(leftWidth / 2);

            //菜单调序按钮
            if (permission.modifyPermission) {
                CreateMoveUpButton();
                CreateMoveDownButton();
            }

            //初始加载结果数据
            LoadMenu();
        }
        //#endregion 设置左面板

        //#region 菜单上移下移

        //#region 菜单上移按钮
        var szdwMoveUp = null;
        function CreateMoveUpButton() {
            var nc = $("#upPanel");
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = $("#moveBtnPanel").height(); //btnHeight;
            szdwMoveUpButton = new SzdwButton(p, x, y, w, h);
            szdwMoveUpButton.namingContainer = nc;
            szdwMoveUpButton.minWidth = 50;
            szdwMoveUpButton.image = "../Styles/image/upDown/ArrowUp20W.png";
            szdwMoveUpButton.text = "上移";
            szdwMoveUpButton.btnCssJson["float"] = "right";
            szdwMoveUpButton.btnCssJson["color"] = "white";
            szdwMoveUpButton.btnCssJson["opacity"] = 0.6;
            szdwMoveUpButton.btnCssJson["border"] = "0px";
            szdwMoveUpButton.btnHoverCssJson = { "opacity":1 }; 
            szdwMoveUpButton.imageWidth = 23;
            szdwMoveUpButton.Load();

            //单击事件
            var btn = szdwMoveUpButton.button;
            $(btn).click(function (e) {
                XmenuSwapSequence(0);
                e.stopPropagation();
            });
        }
        //#endregion 菜单上移按钮

        //#region 菜单下移按钮
        var szdwMoveDown = null;
        function CreateMoveDownButton() {
            var nc = $("#downPanel");
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = $("#moveBtnPanel").height(); //btnHeight;
            szdwMoveDownButton = new SzdwButton(p, x, y, w, h);
            szdwMoveDownButton.namingContainer = nc;
            szdwMoveDownButton.minWidth = 50;
            szdwMoveDownButton.image = "../Styles/image/upDown/ArrowDown20W.png";
            szdwMoveDownButton.text = "下移";
            szdwMoveDownButton.btnCssJson["float"] = "left";
            szdwMoveDownButton.btnCssJson["color"] = "white";
            szdwMoveDownButton.btnCssJson["opacity"] = 0.6;
            szdwMoveDownButton.btnCssJson["border"] = "0px";
            szdwMoveDownButton.btnHoverCssJson = { "opacity":1 }; 
            szdwMoveDownButton.imageWidth = 23;
            szdwMoveDownButton.Load();

            //单击事件
            var btn = szdwMoveDownButton.button;
            $(btn).click(function (e) {
                XmenuSwapSequence(1);
                e.stopPropagation();
            });
        }
        //#endregion 菜单下移按钮

        //#region 菜单交换顺序
        function XmenuSwapSequence(type) {
            if (szdwMenu.jsonList) {
                var val = szdwMenu.value;
                var di = szdwMenu.dataIndex;
                if (di != null) {
                    var pId = szdwMenu.jsonList[di].ParentId;
                    var jsonList = szdwMenu.GetChildJsonList(pId);
                    var i = GetIndexOfJsonList(jsonList, "Id", val);
                    var maxI = jsonList.length - 1;

                    if (type == 0 && i == 0) {
                        alert("已经是该层级菜单的第一个了。");
                    } else if (type == 1 && i == maxI) {
                        alert("已经是该层级菜单的最后一个了。");
                    } else {
                        var xmenuId = jsonList[i].Id;
                        var xmenuName = jsonList[i].Name;
                        var swapXmenuId = type == 0 ? jsonList[i - 1].Id : jsonList[i + 1].Id;
                        var paramJson = { xmenuId: xmenuId, swapXmenuId: swapXmenuId, modifierId: xuserId };
                        paramJson["MethodName"] = "XmenuSwapSequenceByXmenuId";
                        var requestUrl = "XmenuProcess.ashx";
                        szdwMenu.jsonList = null;
                        SzdwAjaxDataOperate.ajaxDataOperateIgnoreReturnValue(szdwMenu, requestUrl, paramJson);

                    }
                }
            }
        }

        //获取json值在json对象数组中的索引
        function GetIndexOfJsonList(jsonList, itemField, itemValue) {
            var index = null;
            if (jsonList) {
                var fId = itemField;
                $.each(jsonList, function (i, item) {
                    if (item[fId] == itemValue) {
                        index = i;
                    }
                });
            }
            return index;
        }
        //#endregion 菜单交换顺序函数

        //#endregion 菜单上移下移
                  
        //#region 创建Menu

        //#region 载入Menu 
        function LoadMenu() {
            //获取父容器及其相关属性
            var lpw = leftWidth;
            var lph = bodyHeight-2*mt;
            var mbh = $("#moveBtnPanel").outerHeight();
            var c = $("#menuPanel");// document.body;
            var ch = lph - mbh;
            $(c).outerHeight(ch);
            //创建Menu并绑定数据
            CreateMenu(c, "relative", 0, 0, leftWidth, bodyHeight-2*mt-mbh);
        }
        //#endregion 单击按钮事件

        //#region 创建SzdwMenu并绑定数据
        var szdwMenu = null;
        function CreateMenu(namingContainer, position, x, y, width, height) {
            if (szdwMenu == null || typeof (szdwMenu) == "undefined") {
                //创建SzdwGridViewt实例
                szdwMenu = new SzdwMenu(position, x, y, width, height);
                szdwMenu.namingContainer = namingContainer;
                szdwMenu.fnItemClick = MenuItemClick;
                szdwMenu.fnItemDelete = MenuItemDelete;
                szdwMenu.haveItemDeleteButton = permission.deletePermission;
            }
            var fxMenuId = 0;
            var paramJson = { xuserId: xuserId, parentXmenuId: fxMenuId };
            paramJson["MethodName"] = "XmenuGetList";
            szdwMenu.requestUrl = "XmenuProcess.ashx";
            szdwMenu.paramJson = paramJson;
            szdwMenu.defaultItemText = "权限管理";
            szdwMenu.value = fxMenuId + 1;
            szdwMenu.panelCssJson["padding-right"] = "1px";
            szdwMenu.DataBind();

            var p = szdwMenu.listPanel;
            $(p).addClass("scrollBar").outerHeight($(szdwMenu.panel).height());
            $(p).mouseover(function () {
                $(this).css({ "overflow-y": "auto" });
            }).mouseleave(function () {
                $(this).css({ "overflow-y": "hidden" });
            });
        }

        //点击菜单载入页面函数
        function MenuItemClick(dataIndex) {
            var jsonList = szdwMenu.jsonList;
            var jsonData = jsonList[dataIndex];
            if (szdwOperateBtnList.selectedValue > 0) {
                //菜单名称和备注
                var name = jsonData.Name;
                $("#txtName").val(name);
                var parentId = jsonData.ParentId;
                var parentName = "无";
                var len = jsonList.length;
                for (var i = 0; i < len; i++) {
                    if (jsonList[i].Id == parentId) {
                        parentName = jsonList[i].Name;
                        break;
                    }
                }
                console.log(parentName);
                $("#ddlParent").val(parentName).data("value", parentId);
                var memo = jsonData.Memo;
                $("#txtMemo").val(memo);

                //菜单图标
                var iconUrl = jsonData.IconUrl;
                $("#txtIcon").val(iconUrl);
                $("#imgIcon").css({ "background": "url(" + iconUrl + ") center no-repeat" });

                //菜单关联页面
                var pageUrl = jsonData.PageUrl;
                $("#txtPage").val(pageUrl);
            }
        }
       
        //#endregion 创建SzdwMenu并绑定数据  
                     
        //#region 菜单项删除事件
        function MenuItemDelete(dataIndex) {
            var i = dataIndex;
            var xmenuId = szdwMenu.jsonList[i].Id;
            var childCount = szdwMenu.GetChildJsonList(xmenuId).length;
            if (childCount > 0) {
                alert("该菜单下有子菜单，不能执行删除操作！");
            } else {
                var requestUrl = "XmenuProcess.ashx";
                var paramJson = { xmenuId: xmenuId, MethodName: "XmenuDeleteTranById" };
                szdwMenu.jsonList = null;
                SzdwAjaxDataOperate.ajaxDataOperateIgnoreReturnValue(szdwMenu, requestUrl, paramJson);
            }
        }
        //#endregion 菜单项删除事件 

        //#endregion 创建Menu 

        //#endregion 左面板

        //#region 右面板

        //#region 设置右面板
        function SetRightPanel() {
            $("#rightPanel").css({ "position": "absolute", "left": leftWidth+ml, "top": mt }).outerWidth(bodyWidth-leftWidth-2*ml).outerHeight(bodyHeight-2*mt);

            //加载
            //$("#rowIcon").hide();
            $("#rowXpage").hide();
            CreateOperateButtonList();

            if (permission.insertPermission || permission.modifyPermission) {
                $("#rowInsertUpdate").show();
                $("#rowInsertPlus").show();
                if (!permission.insertPermission) { $("#txtName").val(szdwMenu.defaultItemText); } 
                CreateIconButton();
                BindDropdownListToTarget();
                CreateResetButton();
                CreateSaveButton();
            } else {
                $("#rowInsertUpdate").hide();
                $("#rowInsertPlus").hide();
                $("#rowIconPage").hide();
            }

            if (permission.modifyPermission) {                
                CreateDeleteIconButton();
                //CreateIconBackColorButton();
                CreatePageButton();
                CreateDeletePageButton()
            }

        }
        //#endregion 设置右面板
        
        //#region 操作类别按钮组
        var szdwOperateBtnList = null;
        function CreateOperateButtonList() {
            var nc = $("#rowTab");
            $(nc).css({ "padding-left": "0px" });

            var tabBtnJsonList = new Array();
            if (permission.insertPermission) {
                tabBtnJsonList.push({ Text: "新增菜单", Value: 0, FnClick: FnInsert });
            }

            if (permission.modifyPermission) {
                tabBtnJsonList.push({ Text: "编辑菜单", Value: 1, FnClick: FnUpdate });
                tabBtnJsonList.push({ Text: "设置图标和关联页面", Value: 2, FnClick: FnIconPage });
            }

            var position = "relative";
            var x = 0;
            var y = 0;
            var h = 0;
            szdwOperateBtnList = new SzdwTabButtonList(position, x, y, h);
            szdwOperateBtnList.namingContainer = nc;
            szdwOperateBtnList.btnHeight = 32;
            szdwOperateBtnList.btnMinWidth =60;
            szdwOperateBtnList.btnJsonList = tabBtnJsonList;
            szdwOperateBtnList.btnCssJson["border"] = "0px";
            szdwOperateBtnList.btnCssJson["border-bottom"] = "2px solid transparent";
            szdwOperateBtnList.btnHoverCssJson["border"] = "0px";
            szdwOperateBtnList.btnHoverCssJson["border-bottom"] = "2px solid #017BBA";
            szdwOperateBtnList.btnHoverCssJson["background-color"] = "transparent";
            szdwOperateBtnList.btnHoverCssJson["color"] = "#017BBA";
            szdwOperateBtnList.btnSelectedCssJson["border"] = "0px";
            szdwOperateBtnList.btnSelectedCssJson["border-bottom"] = "2px solid #017BBA";
            szdwOperateBtnList.btnSelectedCssJson["background-color"] = "transparent";
            szdwOperateBtnList.btnSelectedCssJson["color"] = "#017BBA";
            szdwOperateBtnList.panelCssJson["float"] = "left";
            szdwOperateBtnList.Load();

            //if (permission.insertPermission) {
                szdwOperateBtnList.SetSelectedButton(szdwOperateBtnList.arrButton[0]);
//            } else {
//                if (permission.modifyPermission) {
//                    szdwOperateBtnList.SetSelectedButton(szdwOperateBtnList.arrButton[0]);
//                }
//            }
        }

        //新增菜单
        function FnInsert() {
            $("#rowXpage").css("display", "none");
            $("#rowName").slideDown(200);
            $("#rowMemo").slideDown(200);
            $("#rowIcon").slideDown(200);
            $("#rowInsertPlus").slideDown(200);
            $("#rowOperation").slideDown(200);
             
            var jsonData = szdwMenu.jsonList[szdwMenu.dataIndex];
             //菜单名称和备注
            $("#txtName").val("");
            $("#txtMemo").val("");

            //菜单图标
            $("#txtIcon").val("");
            $("#imgIcon").css({ "background": "" });

            //菜单关联页面
            $("#txtPage").val("");
        }

        //编辑菜单
        function FnUpdate() {
            $("#rowIcon").slideUp(200);
            $("#rowXpage").slideUp(200);
            $("#rowInsertPlus").slideDown(200);
            $("#rowName").slideDown(200);
            $("#rowMemo").slideDown(200);
            $("#rowOperation").slideDown(200);

            var jsonData = szdwMenu.jsonList[szdwMenu.dataIndex];
            //菜单名称和备注
            var name = jsonData.Name;
            $("#txtName").val(name);
            var memo = jsonData.Memo;
            $("#txtMemo").val(memo);
        }

        //设置图标和页面
        function FnIconPage() {
            $("#rowInsertPlus").slideUp(200);
            $("#rowName").slideUp(200);
            $("#rowMemo").slideUp(200);
            $("#rowOperation").slideUp(200);
            $("#rowIcon").slideDown(200);
            $("#rowXpage").slideDown(200);

            var jsonData = szdwMenu.jsonList[szdwMenu.dataIndex];
            //菜单图标
            var iconUrl = jsonData.IconUrl;
            $("#txtIcon").val(iconUrl);
            $("#imgIcon").css({ "background": "url(" + iconUrl + ") center no-repeat" });

            //菜单关联页面
            var pageUrl = jsonData.PageUrl;
            $("#txtPage").val(pageUrl);

        }
        //#endregion 操作类别按钮组 

        //#region 设置图标按钮
        var szdwIconButton = null;
        function CreateIconButton() {
            var nc = $("#cellCp01");
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = btnHeight;
            szdwIconButton = new SzdwButton(p, x, y, w, h);
            szdwIconButton.namingContainer = nc;
            szdwIconButton.imageWidth = 25;
            szdwIconButton.image = imgFile.query;
            szdwIconButton.title = "选取菜单图标";
            szdwIconButton.Load();

            //单击事件
            var btn = szdwIconButton.button;
            $(btn).click(function (e) {
                XmenuIconSetting();
                e.stopPropagation();
            });
        }
        //#endregion 设置图标按钮 
        
        //#region 设置图标显示背景按钮
        var szdwBtnIconBackColor = null;
        function CreateIconBackColorButton() {
            var nc = $("#iconSetting");
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 100;
            var h = btnHeight;
            szdwBtnIconBackColor = new SzdwButton(p, x, y, w, h);
            szdwBtnIconBackColor.namingContainer = nc;
            szdwBtnIconBackColor.text = "图片透明背景";
            szdwBtnIconBackColor.btnCssJson["float"] = "right";
            szdwBtnIconBackColor.Load();

            //单击事件
            var btn = szdwBtnIconBackColor.button;
            var btnText = szdwBtnIconBackColor.btnText;
            $(btn).click(function (e) {                 
                if ($(btnText).text() == "图片透明背景") {
                    $(btnText).text("图片黑色背景");
                    $("#iconBox").css({ "background-color": "transparent","border":"1px solid silver" });
                } else {
                    $(btnText).text("图片透明背景");
                    $("#iconBox").css({ "background-color": "black", "border": "1px solid black" });
                }
                e.stopPropagation();
            });
        }
        //#endregion 设置图标显示背景按钮 

        //#region 删除图标按钮
        var szdwBtnDeleteIcon = null;
        function CreateDeleteIconButton() {
            var nc = $("#cellCp01");
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = btnHeight;
            szdwBtnDeleteIcon = new SzdwButton(p, x, y, w, h);
            szdwBtnDeleteIcon.namingContainer = nc;
            szdwBtnDeleteIcon.imageWidth = 25;
            szdwBtnDeleteIcon.image = imgFile.del;
            szdwBtnDeleteIcon.title="删除菜单图标"
            szdwBtnDeleteIcon.btnCssJson["margin-left"] = "5px";
            szdwBtnDeleteIcon.Load();

            //单击事件
            var btn = szdwBtnDeleteIcon.button;
            $(btn).click(function (e) {
                DeleteXmenuIcon();
                e.stopPropagation();
            });
        }

        //删除图标
        function DeleteXmenuIcon() {
            //清除显示图标
            $("#imgIcon").css({ "background": "" });
            $("#txtIcon").val("");
            
            //更新数据    
            var jsonData = szdwMenu.jsonList[szdwMenu.dataIndex];
            var requestUrl = "XmenuProcess.ashx";
            var jsonData = { Id: jsonData.Id, IconUrl: "", ModifierId: xuserId };
            var paramJson = { jsonData: $.toJSONString(jsonData), MethodName: "XmenuUpdateById" };
            szdwMenu.jsonList = null;
            SzdwAjaxDataOperate.ajaxDataOperateIgnoreReturnValue(szdwMenu, requestUrl, paramJson);
        }
        //#endregion 删除图标按钮 

        //#region 关联页面按钮
        var szdwPageButton = null;
        function CreatePageButton() {
            var nc = $("#cellCp11");
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = btnHeight;
            szdwPageButton = new SzdwButton(p, x, y, w, h);
            szdwPageButton.namingContainer = nc;
            szdwPageButton.image = imgFile.query;
            szdwPageButton.title = "选取关联页面";
            szdwPageButton.imageWidth = 25;
            szdwPageButton.Load();

            //单击事件
            var btn = szdwPageButton.button;
            $(btn).click(function (e) {
                XmenuPageSetting();
                e.stopPropagation();
            });
        }
        //#endregion 关联页面按钮
        
        //#region 删除关联页面按钮
        var szdwBtnDeletePage = null;
        function CreateDeletePageButton() {
            var nc = $("#cellCp11");
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = btnHeight;
            szdwBtnDeletePage = new SzdwButton(p, x, y, w, h);
            szdwBtnDeletePage.namingContainer = nc;
            szdwBtnDeletePage.imageWidth = 25;
            szdwBtnDeletePage.image = imgFile.del;
            szdwBtnDeletePage.title = "解除页面关联"
            szdwBtnDeletePage.btnCssJson["margin-left"] = "5px";
            szdwBtnDeletePage.Load();

            //单击事件
            var btn = szdwBtnDeletePage.button;
            $(btn).click(function (e) {
                DeleteXmenuPage();
                e.stopPropagation();
            });
        }
        
        //删除关联页面
        function DeleteXmenuPage() {
            //清除显示
            $("#txtPage").val("");
            
            //更新数据
            var jsonData = szdwMenu.jsonList[szdwMenu.dataIndex];
            var requestUrl = "../XmenuPage/XmenuPageProcess.ashx";
            var paramJson = { xmenuId: jsonData.Id, xpageId: jsonData.XpageId, MethodName: "XmenuPageDeleteByXmenuIdXpageId" };
            szdwMenu.jsonList = null;
            SzdwAjaxDataOperate.ajaxDataOperateIgnoreReturnValue(szdwMenu, requestUrl, paramJson);
        }
        //#endregion 删除关联页面按钮 

        //#region 下拉框
        //绑定下拉框到目标控件
        var szdwDdlParent = null;
        function BindDropdownListToTarget() {
            var xuserId = xuserId;
            var requestUrl = "XmenuProcess.ashx";

            //部门下拉框
            var maxWidth = $("#ddlParent").outerWidth();
            var paramJson = { XuserId: xuserId,  MethodName: "XmenuGetDropDownList" };
            var paramDdlXmenu = { requestUrl: requestUrl, paramJson: paramJson, maxHeight: 200, fnInitial: InitialDdl };
            $("#ddlParent").dropDownList(paramDdlXmenu);
            $("#ddlParent").val("无").data("value", 0);
            //szdwDdlResourceType = $("#ddlResourceType").data("szdwDdl");
        }

        //通用下拉框初始化设置
        function InitialDdl(szdwDdl) {
            szdwDdl.nonCascadeItemLength = 0;
            szdwDdl.jsonItemAll = { Id: 0, Name: "无" };
            szdwDdl.hasSearchBox = true;
        }

        //#endregion 下拉框
        
        //#region 设置菜单图标
        //设置菜单图标
        function XmenuIconSetting() {            
            var titleText = "设置图标：" + szdwMenu.text+" 菜单";
            var pageUrl = "XmenuIconSetting.html";
            var i = szdwMenu.dataIndex;
            var xmenuId = szdwMenu.jsonList[i].Id;
            var xmenuName = szdwMenu.jsonList[i].Name;
            var paramJson = { xmenuId: xmenuId, xmenuName: xmenuName, operateBtnValue: szdwOperateBtnList.selectedValue };
            var body = document.body;
            var bw = $(body).width();
            var bh = $(body).height();
            var w = 330;
            var h = $("#rightPanel").outerHeight()-2;
            var rx = bw - w - ml - 1;
            var x = rx;
            var y = $("#rightPanel").offset().top + 1;
            var hasAnimation = false;
            OpenPopupWindow(titleText, pageUrl, paramJson, x, y, w, h, hasAnimation);
        }
        //#endregion 添加或移除用户

        //#region 设置关联页面
        //设置关联页面
        function XmenuPageSetting() {
            var titleText = "关联页面：对应 " + szdwMenu.text + " 菜单";
            var pageUrl = "XmenuPageSetting.html";
            var i = szdwMenu.dataIndex;
            var xmenuId = szdwMenu.jsonList[i].Id;
            var xmenuName = szdwMenu.jsonList[i].Name;
            var paramJson = { xmenuId: xmenuId, xmenuName: xmenuName };
            var body = document.body;
            var bw = $(body).width();
            var bh = $(body).height();
            var w = 500;
            var h = $("#rightPanel").outerHeight() - 2;
            var rx = bw - w - ml - 1;
            var x = rx;
            var y = $("#rightPanel").offset().top + 1;
            var hasAnimation = false;
            OpenPopupWindow(titleText, pageUrl, paramJson, x, y, w, h, hasAnimation);
        }
        //#endregion 添加或移除用户
        
        //#region 提交保存按钮
        var szdwSaveButton = null;
        function CreateSaveButton() {
            var nc = $("#cellOp00");
            $(nc).outerWidth($("#cellIp00").outerWidth());
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 90;
            var h = 30;
            szdwSaveButton = new SzdwButton(p, x, y, w, h);
            szdwSaveButton.namingContainer = nc;
            szdwSaveButton.image = imgFile.query;
            szdwSaveButton.text = "提交保存";
            szdwSaveButton.btnCssJson["float"] = "right";
            szdwSaveButton.btnHoverCssJson = { "color": "#017BBA" };
            szdwSaveButton.imageWidth = 26;
            szdwSaveButton.Load();

            //单击事件
            var btn = szdwSaveButton.button;
            $(btn).click(function (e) {
                var type1 = szdwOperateBtnList.selectedValue;
                var type = type1 > 0 ? type1 : 0;
                var name = $("#txtName").val();
                if (name == "" || name == null)
                {
                    alert("菜单名称不能为空");
                }
                else {
                    XmenuOperate(type);
                }
                e.stopPropagation();
            });
        }

        //添加新菜单
        function XmenuOperate(type) {
            var id = szdwMenu.jsonList[szdwMenu.dataIndex].Id;
            var name = $("#txtName").val();
            var memo = $("#txtMemo").val();
            var parentId = $("#ddlParent").data("value");
            var methodName = type == 0 ? "XmenuInsertTran" : "XmenuUpdateTran";
            var jsonData = { Id: id, Name: name, Memo: memo, ParentId: parentId, CreatorId: xuserId };
            if (type == 0) {
                var iconUrl = $("#txtIcon").val();
                jsonData["IconUrl"] = iconUrl;
            } 

            var requestUrl = "XmenuProcess.ashx";
            var paramJson = { jsonData: $.toJSONString(jsonData), MethodName: methodName };
            var OperateCallBack = type == 0 ? InsertCallBack : null;
            szdwMenu.jsonList = null;
            szdwMenu.defaultItemText = name;
            SzdwAjaxDataOperate.ajaxDataOperateIgnoreReturnValue(szdwMenu, requestUrl, paramJson, OperateCallBack);
        }

        //插入成功后回调函数
        function InsertCallBack() {
            $("#txtName").val("");
            $("#txtMemo").val("");
            $("#txtIcon").val("");
            $("#imgIcon").css({ "background": "" });

            $("#txtName")[0].focus();
        }
        //#endregion 提交保存按钮

        //#region 重置按钮
        var szdwResetButton = null;
        function CreateResetButton() {
            var nc = $("#cellOp00");
            $(nc).outerWidth($("#cellIp00").outerWidth());
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 90;
            var h = 30;
            szdwResetButton = new SzdwButton(p, x, y, w, h);
            szdwResetButton.namingContainer = nc;
            szdwResetButton.image = imgFile.reset;
            szdwResetButton.text = "重置填写";
            szdwResetButton.btnCssJson["float"] = "right";
            szdwResetButton.btnCssJson["margin-left"] = "10px";
            szdwResetButton.btnHoverCssJson = { "color": "#017BBA" };
            szdwResetButton.imageWidth = 26;
            szdwResetButton.Load();

            //单击事件
            var btn = szdwResetButton.button;
            $(btn).click(function (e) {
                $("#txtName").val("");
                $("#txtMemo").val("");
                $("#txtIcon").val("");
                $("#ddlParent").val("无").data("value", 0);
                $("#imgIcon").css({ "background": "" });
                e.stopPropagation();
            });
        }

        //#endregion 重置按钮

        //#endregion 右面板
        
        //#region 创建弹窗
        function OpenPopupWindow(titleText, pageUrl, paramJson, x, y, width, height, borderWidth, hasAnimation) {
            var t = document.body;
            var pw = t.popupWindow;
            if (pw == null || typeof (pw) == "undefined") {
                pw = new SzdwPopupWindow("absolute", x, y, width, height);
            }
            pw.hasMask = false;
            pw.titleText = titleText;
            pw.titleCssJson["padding-left"] = "10px";
            pw.pagePanelBackColor = "transparent";
            pw.backOpacity = 0.7;
            pw.pageUrl = pageUrl;
            pw.pageParamJson = paramJson;
            pw.x = x;
            pw.y = y;
            pw.width = width;
            pw.height = height;
            pw.borderWidth = borderWidth;
            pw.hasLoadingAnimation = hasAnimation;
            //pw.fnClose = CloseCallBack;
            pw.Load();
            pw.targetControl = t;
            t.popupWindow = pw;
        }

        function CloseCallBack() {
            //szdwGvRp.RecoverSelectedRow();
        }
        //#endregion 创建弹窗
    </script>
</body>
</html>