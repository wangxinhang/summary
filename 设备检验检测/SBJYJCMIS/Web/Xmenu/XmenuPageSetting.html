<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title></title>
    <link href="../Styles/Query.css" rel="stylesheet" type="text/css" />
    <link href="../Styles/ScrollBar.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCommon.js" type="text/javascript"></script>    
    <script src="../SzdwControls/SzdwGridView.js" type="text/javascript"></script>
    <link href="../SzdwControls/SzdwGridView.css" rel="stylesheet" type="text/css" />
    <script src="../SzdwControls/SzdwAjaxDataOperate.js" type="text/javascript"></script>
    <link href="../Scripts/jqueryFileTree/jqueryFileTree.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/jqueryFileTree/jqueryFileTree.js" type="text/javascript"></script>
    
    <style type="text/css">
        input::-ms-clear{display:none;} 
    </style>
</head>
<body> 
    <form action="">
        <div id="InsertPanel">            
            <div id="row0" style="margin-bottom:20px;display:none"></div>       
            <div id="row1" style="margin-bottom:20px;height:24px;display:none"></div>
        </div>
        <div id="buttonPanel">
            <input id="btnCancel" type="button" value="取消" class="button2" style="float:right;"/>
            <input id="btnSave" type="button" value="关联" class="keyButton2" style="float:right"/>
        </div>          
    </form>
      
    <script type="text/javascript">
        //#region 全局变量
        var permission = null; 
        var bodyWidth = $(document).width();
        var bodyHeight = $(document).height();
        var ml = 10;mt = 10; btnHeight = 32;btnPanelHeight = 35;
        var panelWidth = bodyWidth - ml * 2;
        var pageJsonData = null;
        //#endregion 全局变量

        //#region 网页加载 

        //#region 初始加载
        $(document).ready(function () {
            //设置录入面板
            SetInsertPanel();

            //设置按钮面板
            SetButtonPanel();

            //绑定按钮事件
            ButtonEventHandler();

            //窗口调整大小
            $(window).resize(function () {
                RePositionControls();
            });
        });

        function RePositionControls() {
            var pw = parent.document.body.popupWindow;
            if (pw) {
                var p = $("#buttonPanel");
                var ph = pw.pagePanelHeight;
                var h = $(p).outerHeight();
                var x = 0;
                var y = ph - h - 2;
                $(p).css({ "left": x, "top": y });
            }     
        }
        //#endregion 初始加载
       
        //#endregion 网页加载  

        //#region 设置录入面板
        var szdwChkl = null;
        function SetInsertPanel() {
            var p = $("#InsertPanel");
            var x = ml;
            var y = mt;
            var w = panelWidth;
            var h = bodyHeight - btnPanelHeight - mt * 2;
            $(p).addClass("queryPanel");
            $(p).css({ "left": x, "top": y, "min-width": 0 });
            $(p).outerWidth(w).outerHeight(h);

            GetXpageList();

//            //载入目录和文件夹
//            $(p).fileTree({ script: "../Scripts/jqueryFileTree/connectors/jqueryFileTree.aspx" }, function (file) {
//                selectedFile = file;
//            });
        }
        //#endregion 设置录入面板
        
        //#region 获取数据
        function GetXpageList() {
            //设置结果面板相关属性
            var body = document.body;
            var c = $("#InsertPanel");
            var position = "absolute";
            var x = 0;
            var y = 0; //by + bh + mt;
            var w = $(c).width();
            var h = $(c).height();

            //创建Gridview并绑定数据
            CreateXpageGridView(c, position, x, y, w, h);
        }
        //#endregion 获取数据

        //#region 查询结果

        //#region 获取查询参数
        function GetXpageParamJson() {
            var paramJson = { relationType: 2 };
            return paramJson;
        }
        //#endregion 获取查询参数

        //#region 创建Gridview并绑定数据
        var szdwXpage = null;
        function CreateXpageGridView(namingContainer, position, x, y, width, height) {
            if (szdwXpage == null || typeof (szdwXpage) == "undefined") {
                //创建SzdwGridViewt实例
                szdwXpage = new SzdwGridView(position, x, y, width, height);
                szdwXpage.namingContainer = namingContainer;
                szdwXpage.fnInitial = InitialSzdwXpage(szdwXpage);
                szdwXpage.fnRowClick = szdwXpageRowClick;
                //szdwXpage.fnDataBindCallBack = InitialRowClick;
            }

            //异步加载数据
            if (szdwXpage.pagination != null) {
                szdwXpage.pagination.ResetBar();
            }

            var paramJson = GetXpageParamJson();
            paramJson["pageSize"] = szdwXpage.pageSize;
            paramJson["MethodName"] = "XpageGetList";
            szdwXpage.requestUrl = "../Xpage/XpageProcess.ashx";
            szdwXpage.paramJson = paramJson;
            szdwXpage.DataBind();
        }


        //初次加载时默认选中第一行，并加载该Group对应的用户数据
        function InitialRowClick() {
            $(szdwXpage.bodyRows[0]).trigger("click");
        }
        //#endregion 创建Gridview并绑定数据

        //#region 初始化Gridview属性
        function InitialSzdwXpage(szdwXpage) {
            //个性样式设置    
            szdwXpage.dataPanelCssJson = { "background-color": "White", "border": "0px solid Silver" };
            szdwXpage.paginationCssJson = { "background-color": "White", "font-family": "微软雅黑", "font-size": "small", "border": "0px solid Silver", "border-top": "0px" };
            szdwXpage.minHeight = 300;
            szdwXpage.allowRowClickEvent = true;            

            //dataPanel设置
            szdwXpage.hasSumRow = false;
            szdwXpage.hasPagination = false;
            szdwXpage.pageSize = 1000;

            //head设置
            szdwXpage.headCssName = "gridHead2";
            szdwXpage.headHeight = 30;
            szdwXpage.fieldJsonData = [{ "Field": "RowNumber", "Text": "序号", "Width": 40 },
                                       { "Field": "Name", "Text": "页面名称", "Width": 150, "OrderField": "Name" },
                                       { "Field": "PathName", "Text": "页面路径", "Width": 260, Style: { "text-align": "left"}}];

            szdwXpage.cellCssJson = {
                "Name": { "text-align": "left" },
                "PathName": { "text-align": "left", "word-wrap": "break-word", "word-break": "break-all" }
            };
        }
        //#endregion 初始化Gridview属性

        //#region 行单击事件
        function szdwXpageRowClick(rowIndex) {
            var jsonList = szdwXpage.recordSetJson;
            if (jsonList) {
                var jsonData = jsonList[rowIndex];
                pageJsonData = { xpageId: jsonData.Id, pageUrl: jsonData.PathName };
            }
        }
        //#endregion 行单击事件

        //#endregion 查询结果

        //#region 设置按钮面板
        function SetButtonPanel() {
            var p = $("#buttonPanel");
            var w = bodyWidth;
            var h = btnPanelHeight;
            var x = 0;
            var y = bodyHeight - h - 2;
            $(p).css({ "position": "relative", "left": x, "top": y, "border-top": "0px solid #E2E2E2", "padding": "5px 10px 5px 5px" });
            $(p).outerWidth(w);
            $(p).outerHeight(h);

        }
        //#endregion 设置按钮面板        
        
        //#region 按钮事件
        function ButtonEventHandler() {
            $("#btnSave").click(function () {
                var pageUrl = pageJsonData.pageUrl;
                var txtPage = parent.document.getElementById("txtPage");
                $(txtPage).val(pageUrl);

                //更新
                var param = $.parseJSON(SzdwCommon.getQueryString("paramJson"));
                var szdwMenu = parent.szdwMenu;
                szdwMenu.jsonList = null;
                szdwMenu.defaultItemText = param.xmenuName;
                var requestUrl = "../XmenuPage/XmenuPageProcess.ashx";
                var xpageId = pageJsonData.xpageId;
                var jsonData = { XmenuId: param.xmenuId, XpageId: xpageId, Memo: "", CreatorId: parent.xuserId };
                var paramJson = { jsonData: $.toJSONString(jsonData), MethodName: "XmenuPageInsert" };
                SzdwAjaxDataOperate.ajaxDataOperateIgnoreReturnValue(szdwMenu, requestUrl, paramJson, OperateCallBack);
            });

            $("#btnCancel").click(function () {
                parent.document.body.popupWindow.Hide();
            });
        }

        function OperateCallBack() {
            parent.document.body.popupWindow.Hide();
        }
        //#endregion 按钮事件        
    </script>
</body>
</html>