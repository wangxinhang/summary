<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title></title>
    <link href="../Styles/ScrollBar.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCheckBoxList.js" type="text/javascript"></script>
    <link href="../Styles/Query.css" rel="stylesheet" type="text/css" />
    <script src="../SzdwControls/SzdwAjaxDataOperate.js" type="text/javascript"></script>
    <link href="../Scripts/jqueryFileTree/jqueryFileTree.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/jqueryFileTree/jqueryFileTree.js" type="text/javascript"></script>
    
    <style type="text/css">
        input::-ms-clear{display:none;} 
    </style>
</head>
<body> 
    <form action="">
        <div id="InsertPanel">            
            <div id="row0" style="margin-bottom:20px;display:none"></div>       
            <div id="row1" style="margin-bottom:20px;height:24px;display:none"></div>
        </div>
        <div id="buttonPanel">
            <input id="btnCancel" type="button" value="取消" class="button2" style="float:right;"/>
            <input id="btnSave" type="button" value="提交" class="keyButton2" style="float:right"/>
        </div>          
    </form>
      
    <script type="text/javascript">
        //#region 全局变量
        var permission = null; 
        var bodyWidth = $(document).width();
        var bodyHeight = $(document).height();
        var ml = 10;mt = 10; btnHeight = 32;btnPanelHeight = 35;
        var panelWidth = bodyWidth - ml * 2;
        var selectedFile = null;
        //#endregion 全局变量

        //#region 网页加载 

        //#region 初始加载
        $(document).ready(function () {
            //设置录入面板
            SetInsertPanel();

            //设置按钮面板
            SetButtonPanel();

            //绑定按钮事件
            ButtonEventHandler();

            //窗口调整大小
            $(window).resize(function () {
                RePositionControls();
            });
        });

        function RePositionControls() {
            var pw = parent.document.body.popupWindow;
            if (pw) {
                var p = $("#buttonPanel");
                var ph = pw.pagePanelHeight;
                var h = $(p).outerHeight();
                var x = 0;
                var y = ph - h - 2;
                $(p).css({ "left": x, "top": y });
            }     
        }
        //#endregion 初始加载
       
        //#endregion 网页加载  

        //#region 设置录入面板
        var szdwChkl = null;
        function SetInsertPanel() {
            var p = $("#InsertPanel");
            var x = ml;
            var y = mt;
            var w = panelWidth;
            var h = bodyHeight - btnPanelHeight - mt * 2;
            $(p).addClass("queryPanel");
            $(p).css({ "left": x, "top": y, "min-width": 0, "overflow": "auto", "border": "2px solid transparent", "padding": "5px" });
            $(p).outerWidth(w).outerHeight(h);
           
            //设置滚动条
            $(p).addClass("scrollBar2");
            $(p).mouseover(function () {
                $(this).css({ "overflow": "auto", "border": "2px solid #666666" });
            }).mouseleave(function () {
                $(this).css({ "overflow": "hidden", "border": "2px solid transparent" });
            });

            //载入目录和文件夹
            $(p).fileTree({ root: "/Styles/image/menu", script: "../Scripts/jqueryFileTree/connectors/jqueryFileTree.aspx" }, function (file) {
                selectedFile = file;
            });
        }
        //#endregion 设置录入面板
        
        //#region 设置按钮面板
        function SetButtonPanel() {
            var p = $("#buttonPanel");
            var w = bodyWidth;
            var h = btnPanelHeight;
            var x = 0;
            var y = bodyHeight - h - 2;
            $(p).css({ "position": "relative", "left": x, "top": y, "border-top": "0px solid #E2E2E2", "padding": "5px 10px 5px 5px" });
            $(p).outerWidth(w);
            $(p).outerHeight(h);

        }
        //#endregion 设置按钮面板        

        //#region 按钮事件
        function getRootPath() {
            var strFullPath = window.document.location.href;
            var strPath = parent.parent.parent.document.location.pathname;
            var pos = strFullPath.indexOf(strPath);
            var prePath = strFullPath.substring(0, pos);
            var postPath = strPath.substring(0, strPath.substr(1).indexOf('/') + 1);
            return (prePath + postPath);
        }

        function ButtonEventHandler() {
            $("#btnSave").click(function () {
                var filePath = selectedFile;
                var fp = selectedFile;
                var fromIndex = fp.indexOf("\\") + 1;
                var index = fp.indexOf("\\", fromIndex);
                var iconUrl = ".." + filePath.substring(index).replace(/\\/g, "/");

                var imgIcon = parent.document.getElementById("imgIcon");
                var backImage = "url(" + iconUrl + ") no-repeat center";
                $(imgIcon).css({ "background": backImage });

                var txtIcon = parent.document.getElementById("txtIcon");
                $(txtIcon).val(iconUrl);

                var param = $.parseJSON(SzdwCommon.getQueryString("paramJson"));
                var operateBtnValue = param.operateBtnValue;
                if (operateBtnValue == 2) {
                    //更新
                    var szdwMenu = parent.szdwMenu;
                    szdwMenu.jsonList = null;
                    szdwMenu.defaultItemText = param.xmenuName;
                    var requestUrl = "XmenuProcess.ashx";
                    var jsonData = { Id: param.xmenuId, IconUrl: iconUrl, ModifierId: parent.xuserId };
                    var paramJson = { jsonData: $.toJSONString(jsonData), MethodName: "XmenuUpdateById" };
                    SzdwAjaxDataOperate.ajaxDataOperateIgnoreReturnValue(szdwMenu, requestUrl, paramJson, OperateCallBack);
                } else {
                    $("#btnCancel").trigger("click");
                }
            });

            $("#btnCancel").click(function () {
                parent.document.body.popupWindow.Hide();
            });
        }

        function OperateCallBack() {
            parent.document.body.popupWindow.Hide();
        }
        //#endregion 按钮事件 
    </script>
</body>
</html>