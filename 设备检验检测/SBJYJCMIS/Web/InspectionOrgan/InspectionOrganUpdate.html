<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title></title>
    <link href="../Styles/Page.css" rel="stylesheet" type="text/css" />
    <link href="../Styles/Query.css" rel="stylesheet" type="text/css" />
    <script src="../Scripts/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwOnOff.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwAjaxDataOperate.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwDropDownList.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwButtonGroup.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwGridView.js" type="text/javascript"></script>
    <link href="../SzdwControls/SzdwGridView.css" rel="stylesheet" type="text/css" />
    <script src="../SzdwControls/SzdwPagination.js" type="text/javascript"></script>
    <script src="../SzdwControls/DateExtend.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwButton.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwDatePicker.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwPopupWindow.js" type="text/javascript"></script>

    <!-- <script src="../SzdwControls/SzdwValidator.js" type="text/javascript"></script>-->

    <script src="../SzdwControls/SzdwPopupWindow.js" type="text/javascript"></script>
    <script src="../Scripts/myparm.js" type="text/javascript"></script>
    <script src="../SzdwControls/domCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwInfoPanel.js" type="text/javascript"></script>
    <style type="text/css">
        input::-ms-clear {
            display: none;
        }
    </style>
</head>
<body>
    <form action="">
        <div id="operatePanel">
            <div id="basicInfoTitle" class="groupTitle" style="cursor:pointer;">
                <label>人员信息:</label>
                <div id="expBasic" style="float:right"></div>
            </div>
            <div id="basicInfoGroup" class="groupPanel">
                <div class="pwRow" style="margin-top:10px;">
                    <div id="cell00" class="cellDiv">
                        <label class="pwLabel">机构名称:</label>
                        <input id="txtName" type="text" class="pwTextBox" style="width:180px;float:right" />
                    </div>
                </div>
                <div class="pwRow" style="margin-top:10px;">
                    <div id="cell01" class="cellDiv">
                        <label class="pwLabel">简称:</label>
                        <input id="txtShortName" type="text" class="pwTextBox" style="width:180px;float:right" />
                    </div>
                </div>
                <div class="pwRow" style="margin-top:10px;">
                    <div id="cell03" class="cellDiv">
                        <label class="pwLabel">省内机构:</label>
                        <input id="txtIsInner" type="text" class="pwTextBox" style="width:180px;float:right" />
                    </div>
                </div>
                <div class="pwRow" style="margin-top:10px;">
                    <div id="cell03" class="cellDiv">
                        <label class="pwLabel">地址:</label>
                        <input id="txtAddress" type="text" class="pwTextBox" style="width:180px;float:right" />
                    </div>
                </div>
                <div class="pwRow" style="margin-top:10px;">
                    <div id="cell04" class="cellDiv">
                        <label class="pwLabel">电话:</label>
                        <input id="txtTel" type="text" class="pwTextBox" style="width:180px;float:right" />
                    </div>
                </div>
                <div class="pwRow" style="margin-top:10px;">
                    <div id="cell02" class="cellDiv">
                        <label class="pwLabel">联系人:</label>
                        <input id="txtContact" type="text" class="pwTextBox" style="width:180px;float:right" />
                    </div>
                </div>
                <div class="pwRow" style="margin-top:10px;">
                    <div id="cell08" class="cellDiv">
                        <label class="pwLabel">资质范围:</label>
                        <input id="txtQualification" type="text" class="pwTextBox" style="width:180px;float:right" />
                    </div>
                </div>
                <div class="pwRow" style="margin-top:10px;">
                    <div id="cell09" class="cellDiv">
                        <label class="pwLabel">机构描述:</label>
                        <input id="txtMemo" type="text" class="pwTextBox" style="width:180px;float:right" />
                    </div>
                </div>
            </div>
        </div>
        <div id="buttonPanel" class="pwBtnPanel" style="position:absolute;bottom:20px;">
            <input id="chkClose" type="checkbox" checked="checked" class="pwCheckbox" />
            <label for="chkClose" class="pwLabel">提交后关闭</label>
            <input id="btnCancel" type="button" value="取消" class="pwButton2" style="float:right;" />
            <input id="btnSave" type="button" value="提交保存" class="pwKeyButton2" style="float:right" />
        </div>
    </form>

    <script type="text/javascript">
        //#region 全局变量
        var permission = null;
        var bodyWidth = $(document).width();
        var bodyHeight = $(document).height();
        var ml = 10; mt = 10; btnHeight = 32; btnPanelHeight = 35;
        var panelWidth = bodyWidth - ml * 2;
        var oldName;
        //#endregion 全局变量

        //#region 网页加载
        $(document).ready(function () {
            //设置录入面板
            SetOperatePanel();

            //设置按钮面板
            SetButtonPanel();

            //窗口调整大小
            $(window).resize(function () {
                var pw = parent.document.body.popupWindow;
                SzdwCommon.rePositionButtonPanel(pw, $("#buttonPanel"));
                SzdwCommon.reSizeOperatePanel(pw, $("#operatePanel"), $("#buttonPanel"));
            });
        });
        //#endregion 网页加载

        //#region 数据操作面板

        //#region 设置面板
        function SetOperatePanel() {
            //#region 设置面板
            var p = $("#operatePanel");
            var x = 0;
            var y = 0;
            var w = bodyWidth - x * 2;
            var h = bodyHeight - btnPanelHeight;
            $(p).addClass("queryPanel").css({ "left": x, "top": y, "min-width": 0, "margin-bottom": "3px", "padding": "0px 0px 15px 0px", "overflow": "hidden" }).outerWidth(w).outerHeight(h, true);

            var cw = w - ml * 2;
            $(".cellDiv").outerWidth(cw);

            //设置滚动条
            $(p).addClass("scrollBar2");
            $(p).mouseover(function () {
                $(this).css({ "overflow-y": "auto" });
            }).mouseleave(function () {
                $(this).css({ "overflow-y": "hidden" });
            });

            var qsJson = $.parseJSON(SzdwCommon.getQueryString("paramJson"));
            $("#txtName").val(qsJson.name);
            $("#txtMemo").val(qsJson.memo);
            oldName = qsJson.name;
            //#endregion 设置面板

            //#region 信息分组

            //基本信息
            SetBasicInfoTitle();
            SetBasicInfoGroup();
            //#endregion 信息分组

            //#region 加载验证器
            //LoadValidaor();
            //#endregion 加载验证器
        }
        //#endregion 设置操作面板

        //#region 信息分组

        //#region 基本信息

        //#region 基本信息标题
        function SetBasicInfoTitle() {
            var p = $("#basicInfoTitle");
            var x = 0;
            var y = 0;
            var w = bodyWidth;
            $(p).css({ "position": "relative", "left": x, "top": y }).outerWidth(w);

            //绑定事件
            $(p).click(function () {
                SzdwCommon.infoGroupTitleClick(szdwExpBasic, basicInfoValidators);
            }).mouseover(function () {
                if (szdwExpBasic.onOff) szdwExpBasic.Show();
            }).mouseleave(function () {
                if (szdwExpBasic.onOff) szdwExpBasic.Hide();
            });

            //加载组显隐开关
            LoadSzdwExpBasic();
        }
        //#endregion 基本信息标题

        //#region 基本信息显隐
        var szdwExpBasic = null;
        function LoadSzdwExpBasic() {
            if (!szdwExpBasic) {
                var p = "relative";
                var x = 0;
                var y = 0;
                var w = 56;
                var h = 22;
                szdwExpBasic = new SzdwOnOff(p, x, y, w, h);
                szdwExpBasic.namingContainer = $("#expBasic");
                szdwExpBasic.visible = false;
                szdwExpBasic.onOff = true;
                szdwExpBasic.backColorOn = parent.themeColor ? parent.themeColor : parent.parent.themeColor;
                szdwExpBasic.fnClickCallBack = FnExpBasic;
                szdwExpBasic.Load();
            }
        }

        //显隐回调函数
        var basicInfoValidators = []; //存储验证器对象的数组
        function FnExpBasic() {
            var arrValidators = basicInfoValidators;
            //隐藏验证器
            $.each(arrValidators, function (i, item) {
                $(item.panel).css({ "display": "none" });
                item.showing = false;
            });

            //组面板显示完毕后执行验证
            var g = $("#basicInfoGroup");
            $(g).slideToggle(300, null, function () {
                SzdwCommon.setGroupValidatorsPosition(arrValidators);
                SzdwCommon.scrollToView(g, $(g).parent());
            });
        }
        //#endregion 基本信息显隐

        //#region 基本信息组
        function SetBasicInfoGroup() {
            $("#basicInfoGroup").css({ "position": "relative" }).outerWidth(bodyWidth);
        }

        //#endregion 基本信息组

        //#endregion 基本信息

        //#endregion 信息分组


        //#region 验证

        //function LoadValidaor() {
        //    var wt = 3;

        //    //#region 基本信息验证
        //    var ncBsc = $("#basicInfoGroup");
        //    $("#txtName").szdwValidate({
        //        widthType: wt,
        //        fnInitial: function (szdwCtrl) {
        //            szdwCtrl.namingContainer = ncBsc;
        //            szdwCtrl.offsetMode = 0;
        //            szdwCtrl.ruleJson = { required: true, existence: true };
        //            szdwCtrl.existenceRequestUrl = "../Flow/FlowProcess.ashx";
        //            szdwCtrl.existenceRequestMethodName = "FlowIsExisted";
        //            szdwCtrl.existenceParamName = "name"; //要传到服务端的参数名称
        //            szdwCtrl.submitControl = $("#btnSave"); //提交保存数据的控件
        //            basicInfoValidators.push(szdwCtrl);
        //        }
        //    });

        //    var afg = $("#AddInfoGroup");
        //    $("#txtAddName").szdwValidate({
        //        widthType: wt,
        //        fnInitial: function (szdwCtrl) {
        //            szdwCtrl.namingContainer = afg;
        //            szdwCtrl.offsetMode = 0;
        //            szdwCtrl.ruleJson = { required: true };
        //            AddInfoValidators.push(szdwCtrl);
        //        }
        //    });

        //    //#endregion 基本信息验证
        //}
        //#endregion 验证

        //#endregion 数据操作面板

        //#region 按钮面板

        //#region 设置按钮面板
        function SetButtonPanel() {
            var p = $("#buttonPanel");
            var w = bodyWidth;
            var h = btnPanelHeight;
            var x = 0;
            var y = bodyHeight - h - 2;
            $(p).css({ "position": "relative", "left": x, "top": y, "padding": "5px 10px 0px 5px" });
            $(p).outerWidth(w).outerHeight(h);

            //按钮事件绑定
            ButtonHandler();
        }
        //#endregion 设置按钮面板

        //#region 下拉框效果
        function BindDdlDepartmentName() {
            $("#ddlDepartmentId").dropDownList({
                requestUrl: "EmployeeProcess.ashx",
                paramJson: { MethodName: "GetDepartmentNameList" },
                fnInitial: InitialDdlDepartmentName,
                width: 120
            });
            // $("#ddlDepartmentId").val("全部").data("value", 0);
        }
        function InitialDdlDepartmentName(szdwDdl) {
            szdwDdl.hasSearchBox = 1;
            szdwDdl.jsonItemAll = { Id: "", Name: "全部" };
            //szdwDdl.fnItemClick = function () {
            //    var btnPanel = szdwQueryButton.button;  
            //    $(btnPanel).trigger("click");
            //}
        }
        //#endregion

        //#region 按钮事件
        function ButtonHandler() {
            //获取弹窗
            var pw = parent.document.body.popupWindow;
            var szdwGv = parent.szdwGv;

            //绑定现有数据
            var qsJson = $.parseJSON(SzdwCommon.getQueryString("paramJson"));
            //绑定事件
            $("#btnSave").click(function () {
                //验证
                var isValid = GetValidResult();

                //验证通过更新数据
                if (isValid) {
                    //显示操作信息
                    SzdwCommon.showOperateInfoPanel(parent.opInfoPanel, parent.CreateOperateInfoPanel, "正在更新记录…");
                    var oldAllowRecoverRow = szdwGv.allowRecoverRowStyleWhenDataBinding;
                    szdwGv.allowRecoverRowStyleWhenDataBinding = false;

                    //更新数据
                    var id = qsJson.id;
                    var name = $("#txtName").val();
                    var pinYin = $("#txtPinYin").val();
                    var iDNumber = $("#txtIDNumber").val();
                    var position = $("#txtPosition").val();
                    var tel = $("#txtTel").val();
                    var sex = $("#txtSex input:checked").val();
                    var maritalStatus = $("#txtMaritalStatus input:checked").val();
                    var entryDate = $("#txtEntryDate").val();
                    var educationBackground = $("#txtEducationBackground").val();
                    var emergencyMan = $("#txtEmergencyMan").val();
                    var emergencyTel = $("#txtEmergencyTel").val();
                    var memo = $("#txtMemo").val();
                    var employeeStatus = $("#txtEmployeeStatus").val();
                    var departmentId = $("#ddlDepartmentId").data("value");
                    var requestUrl = "EmployeeProcess.ashx";
                    var paramJson = {
                        id: id, name: name, pinYin: pinYin, iDNumber: iDNumber, position: position, tel: tel, sex: sex,
                        maritalStatus: maritalStatus, entryDate: entryDate, educationBackground: educationBackground,
                        emergencyMan: emergencyMan, emergencyTel: emergencyTel, memo: memo, employeeStatus: employeeStatus,
                        departmentId: departmentId, MethodName: "EmployeeUpdate"
                    };

                    SzdwAjaxDataOperate.ajaxUpdate(null, requestUrl, paramJson, function () {
                        SzdwCommon.hideOperateInfoPanel(parent.opInfoPanel, "记录更新成功", parent.RecoverSelectedRow);
                        if (szdwGv) { szdwGv.DataBind(); szdwGv.allowRecoverRowStyleWhenDataBinding = oldAllowRecoverRow; }
                        pw.Hide();
                    });
                }
            });

            $("#btnCancel").click(function () {
                pw.Hide();
                pw.fnClose();
            });
        }

        //#region 获取验证结果
        function GetValidResult() {
            var basicValid = SzdwCommon.getGroupValidation(basicInfoValidators);
            if (!basicValid && !szdwExpBasic.onOff) {
                szdwExpBasic.Click();
            }

            var isValid = basicValid;

            return isValid;
        }
        //#endregion 获取验证结果

        //#endregion 按钮事件

        //#region 获取验证结果
        function GetValidResult() {
            var basicValid = SzdwCommon.getGroupValidation(basicInfoValidators);

            if (!basicValid && !szdwExpBasic.onOff) {
                szdwExpBasic.Click();
            }

            var isValid = basicValid;

            return isValid;
        }
        //#endregion 获取验证结果

        //#region 回调函数
        function OperateCallBack() {

            $("#txtName").val("").focus();
            $("#txtMemo").val("");
            //$("#btnSave").attr("disabled", false);

            SzdwCommon.hideOperateInfoPanel(parent.opInfoPanel, "添加记录成功");
            parent.RefreshDataAfterInsert();

            if ($("#chkClose").prop("checked")) {
                $("#btnCancel").trigger("click");
            }
        }
        //#endregion 回调函数
        //#endregion 按钮面板
    </script>
</body>
</html>