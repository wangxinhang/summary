<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">

<html xmlns="http://www.w3.org/1999/xhtml">

<head>
    <title></title>
    <link href="../Styles/Page.css" rel="stylesheet" type="text/css" />
    <link href="../Styles/Query.css" rel="stylesheet" type="text/css" />    
    <script src="../Scripts/jquery-1.11.1.js" type="text/javascript"></script>
    <script src="../SzdwControls/domCommon.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwDropDownList.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwGridView.js" type="text/javascript"></script>
    <link href="../SzdwControls/SzdwGridView.css" rel="stylesheet" type="text/css" />
    <script src="../SzdwControls/SzdwPagination.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwButton.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwPopupWindow.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwAjaxDataOperate.js" type="text/javascript"></script>
    <script src="../SzdwControls/SzdwCommon.js" type="text/javascript"></script>
    <script src="../Scripts/CommonJScript.js" type="text/javascript"></script>
    <script src="../Scripts/myparm.js" type="text/javascript"></script>
</head>
<body style="background-color:#EEEEEE">
    <form action="">
        <div id="leftFilterPanel" style="height:25px;padding-bottom:10px;">
            <div id="rfpCell00" class="cellDiv" style="color:#1B60C3;font-size:12pt; font-family:微软雅黑;">角色列表</div>
            <div id="rfpCell01" class="cellDiv" style="border-left:1px solid #DDDDDD;margin-left:10px;">
                <input id="txtRoleName" type="text" class="textBox2" style="background-color:transparent;border-right:0px;" />
            </div>
        </div>
        <div id="leftDataPanel"></div>
        <div id="rightFilterPanel" style="height:25px;padding-bottom:10px;">
            <div id="rpfpCell00" class="cellDiv" style="color:#1B60C3;font-size:12pt; font-family:微软雅黑;">添加组到选定的角色</div>
            <div id="rpfpCell01" class="cellDiv" style="border-left:1px solid #DDDDDD;margin-left:10px;">
                <div id="ddlAssignType" class="dropDownList" style="width:80px;"></div>
            </div>
            <div id="rpfpCell02" class="cellDiv" style="padding-left:5px">
                <input id="txtGroupName" type="text" class="textBox2" style="background-color:transparent;border-right:0px;width:120px;" />
            </div>
        </div>
        <div id="rightDataPanel"></div>
    </form>  
    
    <script type="text/javascript">
        //#region 全局变量
        var xuserId, xmenuId, permission = null;//用户及权限：json格式
        var leftWidth = 320;
        btnHeight = 26;
        //#endregion 全局变量

        $(document).ready(function () {    
            //获取用户Id和MenuId
            var paramJson = SzdwCommon.getJsonParm();
            xuserId = paramJson.xuserId;
            xmenuId = paramJson.xmenuId;
            permission = SzdwCommon.getPermission(paramJson.permissionJsonList);
            bodyWidth = Math.max($(document.body).width(), minWidth);
            bodyHeight = Math.max($(document.body).height(), minHeight);
            //设置查询面板
            SetLeftPanel();
            //设置结果面板
            SetRightPanel();
            //窗口调整大小
            $(window).resize(function () {
                bodyWidth = Math.max($(document.body).width(), minWidth);
                bodyHeight = Math.max($(document.body).height(), minHeight);
                ResizeControls();
            });
        });

        //#region 位置尺寸
        function ResizeControls() {
            $("#rightFilterPanel").outerWidth(bodyWidth - leftWidth - 3 * mt);
            $("#leftDataPanel").outerHeight(bodyHeight - 25 - 3 * mt);
            $("#rightDataPanel").outerWidth(bodyWidth - leftWidth - 3 * mt).outerHeight(bodyHeight - 25 - 3 * mt);
            if (szdwRole) {
                szdwRole.Resize(leftWidth, bodyHeight - 25 - 3 * mt);
            }
            if (szdwGroupRole) {
                szdwGroupRole.Resize(bodyWidth - leftWidth - 3 * mt, bodyHeight - 25 - 3 * mt);
            }
        }
        //#endregion

        //#region 左面板
        function SetLeftPanel() {
            $("#leftFilterPanel")
                .css({ "position": "absolute", "left": ml, "top": mt })
                .outerWidth(leftWidth)
                .outerHeight(25);
            $("#leftDataPanel")
                .css({ "position": "absolute", "left": ml, "top": 25 + 2 * mt })
                .outerWidth(leftWidth)
                .outerHeight(bodyHeight - 3 * mt - 25);

            //角色筛选按钮
            CreateRoleSearchButton();
            //角色名称回车筛选
            $("#txtRoleName").keypress(function (e) {
                var k = e.which;
                if (k == 13) {
                    $(szdwRoleSearchButton.button).trigger("click");
                }
            });
            //初始加载结果数据
            GetRoleList();
        }

        var szdwRoleSearchButton = null;
        function CreateRoleSearchButton() {
            var nc = $("#txtRoleName").parent();
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = btnHeight;
            szdwRoleSearchButton = new SzdwButton(p, x, y, w, h);
            szdwRoleSearchButton.namingContainer = nc;
            szdwRoleSearchButton.imageWidth = btnImageWidth;
            szdwRoleSearchButton.image = imgFile.query;
            szdwRoleSearchButton.title = "角色名称筛选";
            szdwRoleSearchButton.Load();

            //单击事件
            var btn = szdwRoleSearchButton.button;
            $(btn).click(function (e) {
                szdwRole.paramJson["name"] = $("#txtRoleName").val();
                szdwRole.DataBind();
                e.stopPropagation();
            });
        }

        function GetRoleList() {
            var c = $("#leftDataPanel");
            var position = "absolute";
            var x = 0;
            var y = 0;
            var w = c.width();
            var h = c.height();
            //创建Gridview并绑定数据
            CreateRoleGridView(c, position, x, y, w, h);
        }

        function GetRoleParamJson() {
            var xuserId = xuserId;
            var roleName = $.trim($("#txtName").val());
            var paramJson = { xuserId: xuserId };

            if (roleName.length > 0) {
                paramJson["name"] = roleName;
            }

            return paramJson;
        }

        var szdwRole = null;
        function CreateRoleGridView(namingContainer, position, x, y, width, height) {
            if (szdwRole == null || typeof (szdwRole) == "undefined") {
                //创建SzdwGridViewt实例
                szdwRole = new SzdwGridView(position, x, y, width, height);
                szdwRole.namingContainer = namingContainer;
                szdwRole.fnInitial = InitialSzdwRole(szdwRole);
                szdwRole.fnRowClick = szdwRoleRowClick;
                szdwRole.fnDataBindCallBack = InitialRowClick;
            }

            //异步加载数据
            if (szdwRole.pagination != null) {
                szdwRole.pagination.ResetBar();
            }

            var paramJson = GetRoleParamJson();
            paramJson["pageSize"] = szdwRole.pageSize;
            paramJson["MethodName"] = "RoleGetList";
            szdwRole.requestUrl = "../Role/RoleProcess.ashx";
            szdwRole.paramJson = paramJson;
            szdwRole.DataBind();
        }

        //初次加载时默认选中第一行，并加载该Group对应的用户数据
        function InitialRowClick() {
            $(szdwRole.bodyRows[0]).trigger("click");
        }

        function InitialSzdwRole(szdwRole) {
            //个性样式设置    
            szdwRole.dataPanelCssJson = { "background-color": "White", "border": "1px solid Silver" };
            szdwRole.paginationCssJson = { "background-color": "White", "font-family": "微软雅黑", "font-size": "small", "border": "1px solid Silver", "border-top": "0px" };
            szdwRole.minHeight = 300;
            szdwRole.allowRowClickEvent = true;

            //dataPanel设置
            szdwRole.hasSumRow = false;
            szdwRole.hasPagination = false;
            szdwRole.hasButtonPanel = true;
            szdwRole.pageSize = 1000;

            //head设置
            szdwRole.headCssName = "gridHead2";
            szdwRole.headHeight = 30;
            szdwRole.fieldJsonData = [{ "Field": "RowNumber", "Text": "序号", "Width": 40 },
                                       { "Field": "Name", "Text": "角色名称", "Width": 200,"OrderField": "Name" },
                                       { "Field": "Memo", "Text": "角色描述", "Width": 120 }];

            szdwRole.cellCssJson = {
                "Name": { "text-align": "left" },
                "Memo": { "text-align": "left" }
            };
        }
        function szdwRoleRowClick(rowIndex) {
            var jsonList = szdwRole.recordSetJson;
            if (jsonList) {
                var jsonData = jsonList[rowIndex];
                var roleId = jsonData.Id;
                if (szdwGroupRole) {
                    szdwGroupRole.paramJson["roleId"] = roleId;
                    szdwGroupRole.paramJson["role"] = jsonData.Name; 
                    szdwGroupRole.DataBind();
                }   
            }
        }
        //#endregion

        //#region 右面板
        function SetRightPanel() {
            $("#rightFilterPanel")
                .css({ "position": "absolute", "left": leftWidth + 2 * ml, "top": mt })
                .outerWidth(bodyWidth - leftWidth - 3 * ml)
                .outerHeight(25);
            $("#rightDataPanel")
                .css({ "position": "absolute", "left": leftWidth + 2 * ml, "top": 25 + 2 * mt })
                .outerWidth(bodyWidth - leftWidth - 3 * ml)
                .outerHeight(bodyHeight - 3 * mt - 25);

            //组筛选控件加载
            CreateGroupRoleFilter();

            //初始加载结果数据
            GetGroupRoleList();
        }

        function CreateGroupRoleFilter() {
            BindDdlAssingType();
            CreateGroupRoleSearchButton();

            //组名称回车筛选
            $("#txtGroupName").keypress(function (e) {
                var k = e.which;
                if (k == 13) {
                    $(szdwGroupRoleSearchButton.button).trigger("click");
                }
            });
        }

        function RefreshSzdwGroupRole() {
            $(szdwGroupRoleSearchButton.button).trigger("click");
        }

        function BindDdlAssingType() {
            var jsonList = [{ Id: 1, Name: "已添加" }, { Id: 2, Name: "未添加" }];
            var paramDdl = { jsonList: jsonList, fnInitial: InitialDdl };
            $("#ddlAssignType").dropDownList(paramDdl);
            $("#ddlAssignType").text("全部").data("value", 0);
        }

        function InitialDdl(szdwDdl) {
            szdwDdl.jsonItemAll = { Id: 0, Name: "全部" };
            szdwDdl.fnItemClick = RefreshSzdwGroupRole;
        }

        var szdwGroupRoleSearchButton = null;
        function CreateGroupRoleSearchButton() {
            var nc = $("#txtGroupName").parent();
            var p = "relative";
            var x = 0;
            var y = 0;
            var w = 0;
            var h = btnHeight;
            szdwGroupRoleSearchButton = new SzdwButton(p, x, y, w, h);
            szdwGroupRoleSearchButton.namingContainer = nc;
            szdwGroupRoleSearchButton.imageWidth = btnImageWidth;
            szdwGroupRoleSearchButton.image = imgFile.query;
            szdwGroupRoleSearchButton.title = "组名称筛选";
            szdwGroupRoleSearchButton.Load();

            //单击事件
            var btn = szdwGroupRoleSearchButton.button;
            $(btn).click(function (e) {
                szdwGroupRole.paramJson["assignType"] = $("#ddlAssignType").data("value");
                szdwGroupRole.paramJson["name"] = $("#txtGroupName").val();
                szdwGroupRole.DataBind();
                e.stopPropagation();
            });
        }

        function GetGroupRoleList() {
            var c = $("#rightDataPanel");
            var position = "absolute";
            var x = 0;
            var y = 0;
            var w = c.width();
            var h = c.height();

            //创建Gridview并绑定数据
            CreateGroupRoleGridView(c, position, x, y, w, h);
        }

        function GetGroupRoleParamJson() {
            var xuserId = xuserId;
            var groupName = $.trim($("#txtGroupName").val());
            var assignType = $("#ddlAssignType").data("value");

            var paramJson = { xuserId: xuserId };

            if (groupName.length > 0) {
                paramJson["groupName"] = groupName;
            }

            return paramJson;
        }

        var szdwGroupRole = null;
        function CreateGroupRoleGridView(namingContainer, position, x, y, width, height) {
            if (szdwGroupRole == null || typeof (szdwGroupRole) == "undefined") {
                //创建SzdwGridViewt实例
                szdwGroupRole = new SzdwGridView(position, x, y, width, height);
                szdwGroupRole.namingContainer = namingContainer;
                szdwGroupRole.fnInitial = InitialSzdwGroupRole(szdwGroupRole);                                     
            }

            //异步加载数据
            if (szdwGroupRole.pagination != null) {
                szdwGroupRole.pagination.ResetBar();
            }

            var paramJson = GetGroupRoleParamJson();
            paramJson["pageSize"] = szdwGroupRole.pageSize;
            paramJson["MethodName"] = "GroupRoleGetList";
            szdwGroupRole.requestUrl = "GroupRoleProcess.ashx";
            szdwGroupRole.paramJson = paramJson;
        }

        function InitialSzdwGroupRole(szdwGroupRole) {
            //个性样式设置      
            szdwGroupRole.dataPanelCssJson = { "background-color": "White", "border": "1px solid Silver" };
            szdwGroupRole.paginationCssJson = { "background-color": "White","font-family": "微软雅黑", "font-size": "small","border":"1px solid Silver","border-top":"0px"};
            szdwGroupRole.minHeight = 300;
            
            //dataPanel设置
            szdwGroupRole.hasSumRow = false;
            szdwGroupRole.hasButtonPanel = true;
            szdwGroupRole.freezeCols = 2;
            szdwGroupRole.scrollKeeingType = 1;
            //head设置 
            szdwGroupRole.headCssName = "gridHead2";
            szdwGroupRole.headHeight = 30;           
            szdwGroupRole.fieldJsonData = [{ "Field": "RowNumber", "Text": "序号", "Width": 50},
                                            { "Field": "GroupName", "Text": "组名称", "Width": 250, "OrderField": "GroupName" },
                                            { "Field": "AssignRole", "Text": "添加组到角色", "Width": 320, "FnControlColumn": CreateCellControl, "Style": { "text-align": "center", "color": "red"} },
                                            { "Field": "Memo", "Text": "组描述", "Width": 180 }
                                           ];

            szdwGroupRole.cellCssJson = {
                "GroupName": { "text-align": "left" },
                "Memo": { "text-align": "left" },
                "AssignRole": { "text-align": "left" }
            };
        }

        //被审批人设置控件
        function CreateCellControl(jsonList, cell) {
            var rowIndex = $(cell).data("rowIndex");
            var isAssigned = jsonList[rowIndex].IsAssigned;
            var gId = jsonList[rowIndex].GroupId;            

            //列中的控件box
            var c = document.createElement("div");
            $(c).css({ "height": 25, "line-height": "25px" });

            //checkbox
            var chk = document.createElement("input");
            $(chk).attr("type", "checkbox").attr("id", "chkRole").attr("disabled", true);
            $(chk).css({ "float": "left", "height": 18, "line-height": "18px" });
            $(chk).prop("checked", isAssigned);

            var s = document.createElement("label");
            $(s).css({ "float": "left", "height": 25, "line-height": "25px" });
            var role = szdwGroupRole.paramJson["role"];
            if (isAssigned) {
                $(s).text("已添加到角色:" + role);
                $(s).css("color", "red");
            }
            $(c).append(chk).append(s);

            //按钮
            if (permission.insertPermission && permission.deletePermission && permission.modifyPermission) {
                var btn = document.createElement("input");
                $(btn).attr("type", "button").addClass("button2");
                $(btn).css({ "float": "right", "width": 45, "height": 25 });
                var text = isAssigned ? "移除" : "添加";
                $(btn).val(text).appendTo(c);

                //绑定事件
                $(btn).click(function () {
                    if (isAssigned) {
                        var roleId = jsonList[rowIndex].RoleId;
                        var paramJson = { groupId: gId, roleId: roleId };
                        GroupRoleDelete(paramJson);
                    } else {
                        var creatorId = xuserId;
                        var roleId = szdwGroupRole.paramJson["roleId"];
                        var paramJson = { groupId: gId, roleId: roleId, creatorId: creatorId };
                        GroupRoleInsert(paramJson);
                    }
                });
            }
            return c;
        }

        //添加用户
        function GroupRoleInsert(paramJson) {
            var objDataBind = szdwGroupRole;
            var requestUrl = "GroupRoleProcess.ashx";
            paramJson["MethodName"] = "GroupRoleInsert";
            SzdwAjaxDataOperate.ajaxInsert(objDataBind, requestUrl, paramJson);            
        }

        //移除用户
        function GroupRoleDelete(paramJson) {
            var objDataBind = szdwGroupRole;
            var requestUrl = "GroupRoleProcess.ashx";
            paramJson["MethodName"] = "GroupRoleDelete";
            SzdwAjaxDataOperate.ajaxDelete(objDataBind, requestUrl, paramJson);      
        }
        //#endregion
    </script>
</body>
</html>